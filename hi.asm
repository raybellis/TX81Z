;****************************************************
;* A09 Assembler options			    *
;****************************************************

	IF	&VERSION < $012C
		ERR	"Incompatible assembler version - 1.44 or higher required"
	ENDIF

                        OPT     H03,NCL,NOW,EXP

FILCHR                  TEXT    $FF
BANK			TEXT	HI

			INCLUDE	"inc/hw.asm"
			INCLUDE	"inc/ram.asm"
			INCLUDE "inc/constants.asm"
			INCLUDE "inc/macros.asm"

;****************************************************
;* Used Labels					    *
;****************************************************


; CPU RAM

M0041			EQU	$0041
M0045			EQU	$0045
M0048			EQU	$0048
M0049			EQU	$0049
M0050			EQU	$0050
M0053			EQU	$0053
M0054			EQU	$0054
M0056			EQU	$0056
M0057			EQU	$0057
M0058			EQU	$0058
M0059			EQU	$0059
M005A			EQU	$005A
M005B			EQU	$005B
M006B			EQU	$006B
M006C			EQU	$006C
M006D			EQU	$006D
M006E			EQU	$006E
M006F			EQU	$006F
M0070			EQU	$0070
M0071			EQU	$0071
M0072			EQU	$0072
M0073			EQU	$0073
M0074			EQU	$0074
M0076			EQU	$0076
M0077			EQU	$0077
M0079			EQU	$0079
M007B			EQU	$007B
M007C			EQU	$007C
M007D			EQU	$007D
M007E			EQU	$007E
M0080			EQU	$0080
M0081			EQU	$0081
M0082			EQU	$0082
M0083			EQU	$0083
M0084			EQU	$0084
M0085			EQU	$0085
M0086			EQU	$0086
M0088			EQU	$0088
M0089			EQU	$0089
M008C			EQU	$008C
M008D			EQU	$008D
M008E			EQU	$008E
M0090			EQU	$0090
M0091			EQU	$0091
M0092			EQU	$0092
M0093			EQU	$0093
M0095			EQU	$0095
M0097			EQU	$0097
M0098			EQU	$0098
M009A			EQU	$009A
M009F			EQU	$009F
M00A0			EQU	$00A0
M00A1			EQU	$00A1
M00A2			EQU	$00A2
M00A3			EQU	$00A3
M00A4			EQU	$00A4
M00A5			EQU	$00A5
M00A6			EQU	$00A6
M00A7			EQU	$00A7
M00A9			EQU	$00A9
M00AD			EQU	$00AD
M00AE			EQU	$00AE
M00AF			EQU	$00AF
M00B0			EQU	$00B0
M00B2			EQU	$00B2
M00B3			EQU	$00B3
M00BF			EQU	$00BF
M00C0			EQU	$00C0
M00C1			EQU	$00C1
M00C2			EQU	$00C2
M00C3			EQU	$00C3
M00C7			EQU	$00C7
M00C8			EQU	$00C8
M00C9			EQU	$00C9
M00CB			EQU	$00CB
M00CC			EQU	$00CC
M00CE			EQU	$00CE
M00DA			EQU	$00DA
M00DC			EQU	$00DC
M00DF			EQU	$00DF
M00E0			EQU	$00E0
M00E1			EQU	$00E1
M00E2			EQU	$00E2
M00E3			EQU	$00E3
M00E5			EQU	$00E5
M00E7			EQU	$00E7
M00EF			EQU	$00EF
M00F0			EQU	$00F0
M00F1			EQU	$00F1
M00F2			EQU	$00F2
M00F3			EQU	$00F3
M00F4			EQU	$00F4
M00F5			EQU	$00F5
M00F6			EQU	$00F6
M00FE			EQU	$00FE

; System RAM

M69C1			EQU	$69C1
M6A19			EQU	$6A19
M6A67			EQU	$6A67
M6A9B			EQU	$6A9B
M6AA6			EQU	$6AA6
M6AA9			EQU	$6AA9
M6AAD			EQU	$6AAD
M6ABE			EQU	$6ABE
M6AC1			EQU	$6AC1
M6AC4			EQU	$6AC4
M6AD5			EQU	$6AD5
M7570			EQU	$7570
M7735			EQU	$7735
M7740			EQU	$7740
M7750			EQU	$7750
M7751			EQU	$7751
M7752			EQU	$7752
M7753			EQU	$7753
M7754			EQU	$7754
M7755			EQU	$7755
M775B			EQU	$775B
M775C			EQU	$775C
M775D			EQU	$775D
M775F			EQU	$775F
M7761			EQU	$7761
M7763			EQU	$7763
M7765			EQU	$7765
M7766			EQU	$7766
M7767			EQU	$7767
M776A			EQU	$776A
M776B			EQU	$776B
M776D			EQU	$776D
M776F			EQU	$776F
M7772			EQU	$7772
M7773			EQU	$7773
M7774			EQU	$7774
M7775			EQU	$7775
M7776			EQU	$7776
M7777			EQU	$7777
M7778			EQU	$7778
M7779			EQU	$7779
M777A			EQU	$777A
M777B			EQU	$777B
M777C			EQU	$777C
M777D			EQU	$777D
M777E			EQU	$777E
M777F			EQU	$777F
M7780			EQU	$7780
M7781			EQU	$7781
M7783			EQU	$7783
M7784			EQU	$7784
M7786			EQU	$7786
M7787			EQU	$7787
M7788			EQU	$7788
M7789			EQU	$7789
M778A			EQU	$778A
M778B			EQU	$778B
M778C			EQU	$778C
M778D			EQU	$778D
M778E			EQU	$778E
M778F			EQU	$778F
M7790			EQU	$7790
M7794			EQU	$7794
M7795			EQU	$7795
M7796			EQU	$7796
M77A6			EQU	$77A6
M77B6			EQU	$77B6
M77C6			EQU	$77C6
M77CE			EQU	$77CE
M77EE			EQU	$77EE
M780E			EQU	$780E
M781E			EQU	$781E
M782E			EQU	$782E
M7836			EQU	$7836
M7846			EQU	$7846
M784E			EQU	$784E
M784F			EQU	$784F
M7850			EQU	$7850
M7851			EQU	$7851
M7852			EQU	$7852
M7853			EQU	$7853
M7873			EQU	$7873
M7893			EQU	$7893
M78A3			EQU	$78A3
M78C3			EQU	$78C3
M78D3			EQU	$78D3
M7913			EQU	$7913
M791B			EQU	$791B
M7923			EQU	$7923
M792B			EQU	$792B
M7933			EQU	$7933
M7937			EQU	$7937
M793B			EQU	$793B
M7942			EQU	$7942
M7943			EQU	$7943
M7CE3			EQU	$7CE3
M7CF1			EQU	$7CF1
M7CF3			EQU	$7CF3
M7D01			EQU	$7D01
M7D03			EQU	$7D03
M7D13			EQU	$7D13
M7D15			EQU	$7D15
M7D17			EQU	$7D17
M7D19			EQU	$7D19
M7D1B			EQU	$7D1B
M7D23			EQU	$7D23
M7D2B			EQU	$7D2B
M7D33			EQU	$7D33
M7D3B			EQU	$7D3B
M7D53			EQU	$7D53
M7D5A			EQU	$7D5A
M7D5B			EQU	$7D5B
M7D62			EQU	$7D62
M7D63			EQU	$7D63
M7D6A			EQU	$7D6A
M7D6B			EQU	$7D6B
M7D72			EQU	$7D72
M7D73			EQU	$7D73
M7D7B			EQU	$7D7B
M7D83			EQU	$7D83
M7D8A			EQU	$7D8A
M7DCB			EQU	$7DCB
M7EE9			EQU	$7EE9
M7EF1			EQU	$7EF1
M7EF9			EQU	$7EF9
M7F01			EQU	$7F01
M7F08			EQU	$7F08
M7F09			EQU	$7F09
M7F29			EQU	$7F29
M7F39			EQU	$7F39
M7F89			EQU	$7F89
M7F99			EQU	$7F99
M7F9A			EQU	$7F9A
M7FB2			EQU	$7FB2

;****************************************************
;* Program Code / Data Areas			    *
;****************************************************

			ORG	$8000

hdlr_RST		BANK_HI			; ensure we remain in the HI bank
			LDAA	#LED4|LED3|LED2|LED1|BANKSEL
			STAA	DDR6		; set P63-P67 to outputs
			BANK_HI			; make sure we're really in the HI bank
			JMP	RESET		; jump to real reset routine

hdlr_OCI		JSR	OCI
			RTI
			JSR	OCI		; entry point from LO bank
			BANK_SW			; return to LO bank
			RTI

hdlr_CMI		JSR	CMI
			RTI
			JSR	CMI		; entry point from LO bank
			BANK_SW			; return to LO bank
			RTI

hdlr_SIO		JSR	SIO
			RTI
			JSR	SIO		; entry point from LO bank
			BANK_SW			; return to LO bank
			RTI

hdlr_IRQ1		JSR	IRQ1
			RTI
			JSR	IRQ1		; entry point from LO bank
			BANK_SW			; return to LO bank
			RTI

			INCLUDE	"inc/xrom.asm"
			INCLUDE	"inc/init.asm"

;-------

			ORG	$8200

RESET			; disable interrupts
			SEI

			; enable internal RAM and MRDY on P52
			LDAA	#RAME|MRE
			STAA	RP5CR

			; initalise timers
			CLRA
			STAA	TCSR1
			STAA	TCSR2

			; timer 2 input = E clock / 128
			LDAA	#CKS10
			STAA	TCSR3

			; set initial stack pointer
			LDS	#STACK_TOP

			; set all LEDs off
			LDAA	#BANKSEL
			STAA	PORT6

			; P20 is an output (Cassette interface output)
			CLR	>PORT2
			LDAA	#CASS_OUT
			STAA	DDR2
			CLR	>PORT2

			; Initialise the YM2414 OPZ FM chip
			JSR	OPZ_INIT

			; clear CPU RAM from $40 - $ff
			LDX	#XROM
			LDAB	#$C0
			CLRA
1			STAA	,X
			INX
			DECB
			BNE	1B

			LDAA	#$FF
			STAA	NOTE_NUMBER_STOP
			JSR	MIDI_INIT
			JSR	LCD_INIT
			JSR	F_C548
			LDAA	M7772
			ANDA	#$04
			BEQ	2F
			JSR	F_B820
			JSR	LO_CALL_08
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE

			; reset timer 2 and set its match value to 72
			LDAA	#0
			STAA	T2CNT
			LDAA	#72
			STAA	TCONR

			; setup timer 2
			;
			; ECMI      -> counter match interrupt enabled
			; TOS = %00 -> timer output on P26 inhibited
			; CKS = %10 -> clock = FRC / 128
			;
			LDAA	#ECMI|T2E|TOS00|CKS10
			STAA	TCSR3

			; enable IRQ1 on P50 from the OPZ chip
			OIM	#IRQ1E,RP5CR

			; clear all condition code registers
			CLRA
			TAP

			BRA	LOOP

;
; vector of entry points exposed to the other ROM bank
;
XROM_VEC		FDB	HI_CALL_00
			FDB	HI_CALL_01
			FDB	HI_CALL_02
			FDB	HI_CALL_03
			FDB	HI_CALL_04
			FDB	HI_CALL_05
			FDB	HI_CALL_06
			FDB	MIDI_INIT_RX
			FDB	MIDI_INIT
			FDB	HI_CALL_09
			FDB	HI_CALL_0A
			FDB	MIDI_SEND_SENSE
			FDB	MIDI_SEND
			FDB	HI_CALL_0D
			FDB	HI_CALL_0E
			FDB	HI_CALL_0F
			FDB	MIDI_SEND_EOX
			FDB	HI_CALL_11
			FDB	HI_CALL_12
			FDB	HI_CALL_13
			FDB	HI_CALL_14
			FDB	HI_CALL_15
			FDB	HI_CALL_16
			FDB	READ_SWITCHES
			FDB	HI_CALL_18
			FDB	HI_CALL_19
			FDB	HI_CALL_1A
			FDB	HI_CALL_1B
			FDB	NOTE_STOP
			FDB	NOTE_START
XROM_VEC2		FDB	hdlr_RST

;-------
;
; main execution loop
;
LOOP			OIM	#ECMI,TCSR3
			LDAA	LOOP_COUNT	; increment loop count modulo 16
			INCA			; -
			ANDA	#$0F		; -
			STAA	LOOP_COUNT	; -
			BNE	1F		; -
			JSR	F_89F9		; called every 16 iterations
1			JSR	POLL
			JSR	POLL
			NOP
			BRA	LOOP

;-------
;
; start a note?
; B -> instrument number
;
NOTE_START		STAB	M00E0			; save instrument number
			LDX	#M00F6			; offset into table
			ABX				; -
			LDAA	,X			; value -> A
			BNE	1F			; if non-zero carry on
			JMP	18F			; otherwise exit
1			PSHA				; save A
			LDAB	NOTE_NUMBER		; get the saved note number
			JSR	TEST_NOTE_LIMIT		; check if it's in the instrument's range
			BCS	3F			; it is? carry on.
			PULA				; otherwise, restore A
2			JMP	18F			; and exit
3			LDX	#M7EE9
			LDAB	M00E0			; get instrument number
			ABX
			LDAA	,X
			STAA	M0053
			JSR	F_87CA
			LDAB	M7772
			ANDB	#$04
			BEQ	4F
			TST	PFM_EDIT_ASSIGN
			BEQ	4F
			PULA
			LDAA	M7EF9
			INCA
			BEQ	2B
			BRA	5F
4			LDAA	M00E0
			JSR	F_9A2F
			TST	$3F,X
			PULA
			BEQ	5F
			JMP	F_8406
5			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAB	,X
			ASLB
			STAB	M00E1
			LDAB	$08,X
			ASLB
			STAB	M00E2
			LDAB	M0053
6			CMPB	M00E2
			BLS	7F
			LDAB	M00E1
7			LDX	#M7CE3
			ABX
			TIM	#%00000010,$01,X
			BNE	8F
			TIM	#%00000001,$01,X
			BEQ	11F
8			INCB
			INCB
			DECA
			BNE	6B
			LDX	M00E3
			LDAB	,X
			LDAA	#$FF
			STAA	,X
			CPX	M0079
			BNE	9F
			LDX	M0077
			BRA	10F
9			INX
10			STX	M00E3
			LDX	#M7CE3
			ABX
11			STAB	M0053
			LSRB
			STX	M00E1
			JSR	F_9169
			LDAB	M0053
			LSRB
			LDAA	#$08
			SEI
12			SPIN3
			OPZ_POLL
			OPZ_OUT_B
			CLI
			LDX	#M7F29
			LDAB	M00E0
			ASLB
			ABX
			LDD	,X
			PSHX
			LDX	M00E1
			STD	$20,X
			LDAB	M0053
			LSRB
			LDAA	NOTE_NUMBER
			JSR	F_890E
			LDX	M00E1
			STD	$10,X
			PULX
			STD	,X
			LDX	M00E1
			LDAA	NOTE_NUMBER
			LDAB	#$02
			ORAB	M0058
			STD	,X
			LDAB	M0053
			LDX	M00E5
			STAB	,X
			CPX	M0079
			BNE	15F
			LDX	M0077
			BRA	16F
15			INX
16			STX	M00E5
			BSR	F_83C0
			LDAA	M0053
			LSRA
			INCA
			LDX	#M7EE9
			LDAB	M00E0
			ABX
			CMPA	$10,X
			BLS	17F
			LDAA	$08,X
17			ASLA
			STAA	,X
			LDX	#M7F09
			LDAB	M00E0
			ASLB
			ABX
			LDD	M00E3
			STD	,X
			LDD	M00E5
			STD	$10,X
18			RTS

;-------

F_83C0			AIM	#~IRQ1E,RP5CR
			LDAA	M0053
			LSRA
			LDAB	M00F1
			STAB	M00F0
			LDAB	NOTE_NUMBER
			SUBB	#$0D
			JSR	F_A155
			LDAB	M0053
			LSRB
			JSR	F_8525
			LDAB	M0053
			LSRB
			LDAA	#$01
1			DECB
			BMI	2F
			ASLA
			BRA	1B
2			ORAA	M00EF
			STAA	M00EF
			LDAB	M0053
			LSRB
			LDX	#M7913
			ABX
			LDAA	#$40
			ORAA	,X
			ADDB	#$20
			SEI
3			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			RTS

;-------

F_8406			LDAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			STD	M00E1
			LDX	#M7F01
			LDAB	M00E0
			ABX
			LDAA	,X
			STAA	M005A
			LDX	M00E1
			TSTA
			BEQ	3F
			CMPA	M006C
			BEQ	2F
			LDAB	M006C
1			TST	,X
			BEQ	3F
			INX
			INX
			DECB
			BNE	1B
			RTS
2			JSR	F_84EB
			LDAA	NOTE_NUMBER
			LDAB	#$02
			ORAB	M0058
			STD	,X
			LDAB	M00E0
			LDAA	#$03
			BRA	4F
3			LDAA	NOTE_NUMBER
			LDAB	#$02
			ORAB	M0058
			STD	,X
			LDAA	M005A
			INCA
			STAA	M005A
			LDX	#M7F01
			LDAB	M00E0
			ABX
			STAA	,X
4			LDX	#M7EF1
			ABX
			LDAB	,X
			LDX	#M7CE3
			ASLB
			ABX
			LSRB
			CMPA	#$01
			BNE	6F
			PSHB
			PSHX
			JSR	F_9169
			PULX
			LDAA	#$08
			PULB
			PSHB
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_B
			CLI
			PSHX
			LDAA	NOTE_NUMBER
			JSR	F_890E
			PULX
			PSHX
			STD	$10,X
			PSHA
			PSHB
			LDAA	M00E0
			JSR	F_9A2F
			TST	$41,X
			PULB
			PULA
			PULX
			BEQ	5F
			STD	$20,X
5			PULB
			ASLB
			STAB	M0053
			JSR	F_83C0
			RTS
6			CMPA	#$02
			BNE	10F
			LDAA	NOTE_NUMBER
			PSHX
			PSHB
			CLRB
			LDX	M00E1
			SUBD	,X
			BCC	7F
			CLRA
			BRA	8F
7			LDAA	#$01
8			LDX	#M005B
			LDAB	M00E0
			ABX
			STAA	,X
9			LDAA	NOTE_NUMBER
			STAA	$08,X
			PULB
			JSR	F_890E
			PULX
			STD	$10,X
			RTS
10			PSHX
			PSHB
			LDX	#M005B
			LDAB	M00E0
			ABX
			LDAA	,X
			BEQ	11F
			LDAA	NOTE_NUMBER
			SUBA	$08,X
			BCS	12F
			BRA	9B
11			LDAA	NOTE_NUMBER
			SUBA	$08,X
			BCC	12F
			BRA	9B
12			PULB
			PULX
			RTS

;-------

F_84EB			LDX	#M005B
			LDAB	M00E0
			ABX
			CLR	>M006B
			TST	,X
			BEQ	1F
			COM	>M006B
1			CLRB
2			PSHX
			LDX	M00E1
			ASLB
			ABX
			LSRB
			LDAA	,X
			PULX
			BEQ	5F
			TST	,X
			BNE	3F
			CMPA	M006B
			BCS	5F
			BRA	4F
3			CMPA	M006B
			BHI	5F
4			STAA	M006B
			STAB	M007B
5			INCB
			CMPB	M006C
			BNE	2B
			LDX	M00E1
			LDAB	M007B
			ASLB
			ABX
			RTS

;-------

F_8525			TBA
			PSHA
			LDX	#M7846
			ABX
			LDAB	,X
			ANDB	#$03
			CMPB	#$01
			BNE	1F
			LDAB	M7850
			BMI	3F
			LDX	#M782E
			ABX
			TST	,X
			BEQ	3F
			LDAB	#$10
			BRA	2F
1			CMPB	#$02
			BNE	4F
			LDAB	M7851
			BMI	3F
			LDX	#M782E
			ABX
			TST	,X
			BEQ	3F
			LDAB	#$20
2			ORAB	M7852
			LDAA	#$1B
			SEI
			OPZ_POLL
			OPZ_OUT_B
			CLI
3			PULB
			BRA	5F
4			PULB
			LDX	#M782E
			ABX
			TST	,X
			BEQ	5F
			LDX	#M7836
			ASLB
			ABX
			LDD	#$3FFF
			STD	,X
5			CLRB
			LDX	#M782E
			ABX
			TST	,X
			BEQ	6F
			LDX	#M7836
			ASLB
			ABX
			LDD	#$3FFF
			STD	,X
6			RTS

;-------
;
; stop a note?
;
NOTE_STOP		STAB	M00E0
			LDX	#M00F6
			ABX
			TST	,X
			BNE	1F
			JMP	10F
1			LDAB	NOTE_NUMBER_STOP
			JSR	TEST_NOTE_LIMIT
			BCS	2F
			JMP	10F
2			JSR	F_87CA
			LDAA	M7772
			ANDA	#$04
			BEQ	3F
			TST	PFM_EDIT_ASSIGN
			BNE	4F
3			LDAA	M00E0
			JSR	F_9A2F
			TST	$3F,X
			BEQ	4F
			JMP	11F
4			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAA	,X
			TAB
			LDX	#M7CE3
			ASLB
			ABX
5			LDAB	NOTE_NUMBER_STOP
			CMPB	,X
			BNE	6F
			TIM	#%00000010,$01,X
			BEQ	6F
			LDAB	M0058
			EORB	$01,X
			ANDB	#$7C
			BEQ	F_85FA
6			INX
			INX
			PSHX
			LDX	#M7EF9
			LDAB	M00E0
			ABX
			CMPA	,X
			PULX
			BEQ	10F
			INCA
			BRA	5B

;-------

F_85FA			PSHX
			PSHB
			LDX	#M0049
			LDAB	M00E0
			ABX
			PULB
			TIM	#%10000000,$00,X
			PULX
			BNE	9F

F_8609			CLR	$01,X
			AIM	#~IRQ1E,RP5CR
			LDAB	#$08
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			PSHA
			BSR	F_8631
			PULA
			BSR	F_8664
			BRA	10F
9			OIM	#%00000001,$01,X
			AIM	#%11111101,$01,X
10			RTS

;-------

F_8631			AIM	#~IRQ1E,RP5CR
			LDAB	#$01
			PSHA
1			DECA
			BMI	2F
			ASLB
			BRA	1B
2			COMB
			ANDB	M00EF
			STAB	M00EF
			PULA
			TAB
			LDX	#M7913
			ABX
			LDAA	,X
			ANDA	#$BF
			ADDB	#$20
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			OIM	#IRQ1E,RP5CR
			RTS

;-------

F_8664			ASLA
			STAA	M0054
			LDX	M0077
1			LDAA	,X
			CMPA	M0054
			BEQ	2F
			CPX	M0079
			BEQ	10F
			INX
			BRA	1B
2			CPX	M00E3
			BEQ	7F
3			CPX	M0079
			BEQ	4F
			INX
			CPX	M00E5
			BEQ	5F
			DEX
			LDAA	$01,X
			STAA	,X
			INX
			BRA	3B
4			PSHX
			LDX	M00E5
			CPX	M0077
			PULX
			BEQ	6F
			PSHX
			LDX	M0077
			LDAA	,X
			PULX
			STAA	,X
			LDX	M0077
			BRA	3B
5			DEX
6			STX	M00E5
			LDAA	#$FF
			STAA	,X
			BRA	10F
7			LDAA	#$FF
			STAA	,X
			CPX	M0079
			BNE	8F
			LDX	M0077
			BRA	9F
8			INX
9			STX	M00E3
10			LDX	#M7F09
			LDAB	M00E0
			ASLB
			ABX
			LDD	M00E3
			STD	,X
			LDD	M00E5
			STD	$10,X
			RTS
11			LDX	#M7F01
			LDAB	M00E0
			ABX
			LDAA	,X
			STAA	M005A
			TSTA
			BLE	15F
			LDAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			STD	M00E1
			JSR	F_876B
			BCS	15F

;-------	fallthrough

F_86E4			LDAA	M005A
			DECA
			STAA	M005A
			PSHX
			LDX	#M7F01
			LDAB	M00E0
			ABX
			STAA	,X
			PULX
			BNE	F_8731
			LDX	M00E1
			PSHX
			LDX	#M0049
			LDAB	M00E0
			ABX
			TST	,X
			PULX
			BMI	14F

;-------	fallthrough

F_8703			CLR	$01,X
			AIM	#~IRQ1E,RP5CR
			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAB	,X
			LDAA	#$08
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_B
			CLI
			TBA
			JSR	F_8631
			BRA	15F
14			OIM	#%00000001,$01,X
			AIM	#%11111101,$01,X
15			RTS

;-------

F_8731			LDD	#$0000
			STD	,X
			JSR	F_8787
			PSHB
			PSHA
			PSHX
			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAB	,X
			PSHB
			JSR	F_890E
			STD	M00DC
			PULB
			LDX	#M7CF3
			ASLB
			ABX
			LDD	M00DC
			STD	,X
			PULX
			LDAA	M005A
			CMPA	#$01
			BNE	1F
			LDD	#$0000
			STD	,X
			LDX	M00E1
			PULA
			PULB
			STD	,X
			BRA	2F
1			PULA
			PULB
2			RTS

;-------

F_876B			LDAB	M006C
			LDX	M00E1
1			LDAA	,X
			CMPA	NOTE_NUMBER_STOP
			BNE	2F
			LDAA	M0058
			EORA	$01,X
			ANDA	#$7C
			BEQ	3F
2			INX
			INX
			DECB
			BNE	1B
			SEC
			BRA	4F
3			CLC
4			RTS

;-------

F_8787			LDX	M00E1
			STX	M0079
			LDX	#M005B
			LDAB	M00E0
			ABX
			CLR	$08,X
			CLRB
			TST	,X
			BNE	1F
			COM	$08,X
1			PSHX
			LDX	M0079
			LDAA	,X
			PULX
			BEQ	4F
			TST	,X
			BEQ	2F
			CMPA	$08,X
			BCS	4F
			BRA	3F
2			CMPA	$08,X
			BHI	4F
3			STAA	$08,X
			STAB	M007B
4			PSHX
			LDX	M0079
			INX
			INX
			STX	M0079
			PULX
			INCB
			CMPB	M006C
			BNE	1B
			LDX	M00E1
			LDAB	M007B
			ASLB
			ABX
			LDD	,X
			RTS

;-------

F_87CA			LDAB	M00E0
			LDX	#M7EF1
			ABX
			LDAB	,X
			BMI	1F
			PSHX
			LDX	#M00E7
			ABX
			STX	M0077
			PULX
			LDAB	$08,X
			BMI	1F
			LDX	#M00E7
			ABX
			STX	M0079
			LDX	#M7F09
			LDAB	M00E0
			ASLB
			ABX
			LDD	,X
			STD	M00E3
			LDD	$10,X
			STD	M00E5
			BRA	2F
1			LDX	#M00E7
			STX	M0077
			STX	M0079
			STX	M00E3
			STX	M00E5
2			RTS

;-------
;
; check if note B is in range of the current instrument
; sets C bit if it is (clear otherwise)
;
TEST_NOTE_LIMIT		LDAA	M7772
			ANDA	#$04
			BEQ	3F
			PSHB				; save B
			LDAA	M00E0			; calculate offset to
			LDAB	#12			; instrument data in
			MUL				; the performance edit
			LDX	#PFM_EDIT_BUF		; buffer
			ABX				; -> X
			PULB				; restore B
			LDAA	$05,X			; get high note limit
			CMPA	$04,X			; compare to low note limit
			BCC	1F
			CMPB	$04,X
			BCC	3F
			CMPB	$05,X
			BLS	3F
			BRA	2F
1			CMPB	$04,X
			BCS	2F
			CMPB	$05,X
			BLS	3F
2			CLC
			RTS
3			SEC
			RTS

;-------

F_8831			PSHA
			LDAA	M7772
			ANDA	#$04
			PULA
			BEQ	3F
			PSHB
			LDAB	#12
			MUL
			LDX	#PFM_EDIT_BUF
			ABX
			PULB
			LDAA	$05,X
			CMPA	$04,X
			BCC	1F
			CMPB	$04,X
			BCC	3F
			CMPB	$05,X
			BLS	3F
			BRA	2F
1			CMPB	$04,X
			BCS	2F
			CMPB	$05,X
			BLS	3F
2			CLC
			RTS
3			SEC
			RTS

;-------

F_885F			STAB	M00E0
			LDX	#M0041
			ABX
			LDAA	,X
			ANDA	#$80
			PSHX
			PSHA
			COMA
			ANDA	$08,X
			BEQ	5F
			JSR	F_87CA
			LDAA	M7772
			ANDA	#$04
			BEQ	1F
			TST	PFM_EDIT_ASSIGN
			BNE	2F
1			LDAA	M00E0
			JSR	F_9A2F
			TST	$3F,X
			BEQ	2F
			JMP	6F
2			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAA	,X
			TAB
			LDX	#M7CE3
			ASLB
			ABX
3			TIM	#%00000001,$01,X
			BEQ	4F
			AIM	#~IRQ1E,RP5CR
			LDAB	#$08
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			CLR	$01,X
			PSHX
			PSHA
			JSR	F_8631
			PULA
			PSHA
			JSR	F_8664
			PULA
			PULX
4			INX
			INX
			PSHX
			LDX	#M7EF9
			LDAB	M00E0
			ABX
			CMPA	,X
			PULX
			BEQ	5F
			INCA
			BRA	3B
5			PULA
			PULX
			STAA	$08,X
			RTS
6			LDAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			XGDX
			TIM	#%00000001,$01,X
			BEQ	7F
			CLR	$01,X
			AIM	#~IRQ1E,RP5CR
			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAA	,X
			LDAB	#$08
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			JSR	F_8631
7			BRA	5B

;-------

F_890E			STAB	M00DC
			LDX	#M793B
			ABX
			LDAB	,X
			PSHB
			LDAB	M7772
			BITB	#$04
			BNE	1F
			JMP	13F
1			PULB				; inst number
			PSHA
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			PULA
			PSHX
			TST	$0B,X
			BEQ	5F
			LDAB	PFM_EDIT_MICTUN
			CMPB	#$01
			BNE	2F
			TAB
			ASLB
			LDX	#MICROTUNE_FULL
			ABX
			LDD	,X
			ASLB
			ASLB
			BRA	6F
2			TAB
			CLRA
3			SUBB	#$0C
			BMI	4F
			ADDA	M7F99
			BRA	3B
4			ADDB	#$0C
			LDX	#M7F9A
			ASLB
			ABX
			ADDA	,X
			LDAB	$01,X
			ASLB
			ASLB
			BRA	6F
5			CLRB
6			SUBA	#$0D
			STD	M008E
			LDAB	M00DC
			LDX	#M791B
			ABX
			ADDA	,X
7			BLT	9F
8			CMPA	#$60
			BCS	10F
			SUBA	#$0C
			BRA	8B
9			ADDA	#$0C
			BRA	7B
10			STAA	M008E
			PULX
			LDAA	#$9F
			LDAB	M008E
			SBA
			LSRA
			LSRA
			LDAB	$06,X
			SUBB	#$07
			BPL	11F
			NEGB
			MUL
			LSRD
			LSRD
			STD	M00DC
			LDD	M008E
			SUBD	M00DC
			BPL	12F
			CLRA
			BRA	12F
11			MUL
			LSRD
			LSRD
			STD	M00DC
			LDD	M008E
			ADDD	M00DC
			CMPA	#$60
			BCS	12F
			CLRA
12			RTS
13			PULB
			TST	M7F99
			BEQ	17F
			LDAB	M7789
			CMPB	#$02
			BEQ	16F
			TAB
			CLRA
14			SUBB	#$0C
			BMI	15F
			ADDA	M7F99
			BRA	14B
15			ADDB	#$0C
			LDX	#M7F9A
			ASLB
			ABX
			ADDA	,X
			LDAB	$01,X
			ASLB
			ASLB
			BRA	18F
16			TAB
			ASLB
			LDX	#MICROTUNE_FULL
			ABX
			LDD	,X
			ASLB
			ASLB
			BRA	18F
17			CLRB
18			SUBA	#$0D
			STD	M008E
			LDAB	M00DC
			LDX	#M791B
			ABX
			ADDA	,X
19			BLT	21F
20			CMPA	#$60
			BCS	22F
			SUBA	#$0C
			BRA	20B
21			ADDA	#$0C
			BRA	19B
22			STAA	M008E
			LDD	M008E
			RTS

;-------

F_89F9			JSR	READ_SWITCHES
			TSTB
			BEQ	F_8A08
			CLR	>M00CC
			CLR	>M0056
			CLR	>M0057

;-------	fallthrough

F_8A08			CMPB	#$03
			BCS	1F
			CMPB	#$04
			BEQ	1F
			LDAA	#$FF
			STAA	M7795
			CMPB	#$0A
			BCC	1F
			STAA	M7794
1			LDAA	M7772

			JSR	JMPOFF1
			FCB	C_8ADD - *
			FCB	$01
			FCB	C_8A39 - *
			FCB	$03
			FCB	C_8AC2 - *
			FCB	$08
			FCB	C_8ACA - *
			FCB	$0A
			FCB	2F - *
			FCB	$0C
			FCB	3F - *
			FCB	$0D
			FCB	2F - *
			FCB	$00

2			JMP	C_8B9E
3			JMP	C_8BB3
4			JMP	C_8BBB

C_8A39			CMPA	#$12
			BCC	17F

			JSR	JMPOFFA
			FCB	13F - *
			FCB	13F - *
			FCB	C_8A69 - *
			FCB	C_8ADD - *
			FCB	13F - *
			FCB	13F - *
			FCB	6F - *
			FCB	C_8ADD - *
			FCB	C_8ADD - *
			FCB	18F - *
			FCB	19F - *
			FCB	C_8ADD - *
			FCB	C_8ADD - *
			FCB	C_8ADD - *
			FCB	20F - *
			FCB	C_8ADD - *
			FCB	C_8ADD - *
			FCB	18F - *

6			DECB
			TST	M7795
			BMI	7F
			TSTB
			BNE	10F
			JSR	F_B88D
			BRA	10F
7			JSR	F_8D02
			TAB

;-------	fallthrough

F_8A64			JSR	F_B7C3
			BRA	4B

C_8A69			SUBB	#$01
			TST	M7795
			BMI	11F
			TSTB
			BNE	10F
			JSR	F_B83F
10			LDAA	#$FF
			STAA	M7795
			BRA	4B
11			JSR	F_8CCE
			TAB

;-------	fallthrough

F_8A81			JSR	F_B784
			BRA	4B

;-------

13			ANDA	#$18
			BNE	C_8ADD
			TST	M7794
			BMI	15F
			CMPB	#$01
			BNE	14F
			JSR	F_B8A7
14			LDAA	#$FF
			STAA	M7794
			BRA	4B
15			JSR	F_B931
			BCS	16F
			JSR	F_BC2A
			BCS	4B
			BRA	C_8ADD
16			TST	>M00CE
			BEQ	4B
			CLR	>M00CE
17			BRA	C_8ADD
18			JSR	F_B8E3
			BRA	22F
19			JSR	F_B862
			BRA	22F
20			JSR	F_B884
			BRA	22F
C_8AC2			SUBB	#$03
			JSR	F_AF7B
22			JMP	C_8BBB
C_8ACA			SUBB	#$08
			CMPA	#$07
			BCC	C_8ADD
			CLR	>M00A4

			JSR	JMPOFFA
			FCB	27F - *
			FCB	27F - *
			FCB	37F - *
			FCB	34F - *
			FCB	25F - *
			FCB	26F - *
			FCB	C_8ADD - *

C_8ADD			JMP	44F
25			JMP	39F
26			JMP	38F
27			LDAA	M7788
			BEQ	33F
			CMPA	#$01
			BEQ	31F
			CMPA	#$02
			BHI	C_8ADD
			LDAA	M7774
			CMPA	#$1C
			BNE	30F
			LDAA	M7789
			BEQ	30F
			CMPA	#$02
			BEQ	29F
			TST	M778C
			BEQ	28F
			JSR	F_8C90
			LDAB	M7774
			BRA	36F
28			COMB
			ANDB	#$01
			LDAA	#$0A
			STAA	M00A7
			LDAA	M778A
			JSR	F_8D0C
			STAA	M778A
			BRA	32F
29			JSR	F_8C64
			BCS	32F
30			JSR	F_8C42
			BRA	32F
31			LDAA	M7789
			PSHA
			JSR	F_8C06
			JSR	F_8BC2
			PULA
			JSR	F_8D48
32			LDAB	M7774
			BRA	36F
33			LDAA	M7772
			CMPA	#$01
			BEQ	35F
			LDAA	#$14
			STAA	M00A9
			LDAA	#$1E
			STAA	M00A7
			LDAA	M7774
			JSR	F_8CA9
			TAB
			BRA	36F
34			JMP	C_8BBB
35			LDAA	#$0A
			STAA	M00A7
			CLR	>M00A9
			LDAA	M7774
			JSR	F_8CA9
			TAB
			JSR	F_8DB2
36			JSR	F_B1DD
			BRA	C_8BBB
37			JSR	F_8CE7
			TAB
			JSR	F_B784
			BRA	C_8BBB
38			LDAA	#$35
			STAA	M00A7
			LDAA	#$28
			STAA	M00A9
			LDAA	M7774
			JSR	F_8CA9
			TAB
			JSR	F_8D1D
			BRA	36B
39			LDAA	#$3E
			STAA	M00A7
			LDAA	#$3C
			STAA	M00A9
			LDAA	M7774
			JSR	F_8CA9
			TAB
			BRA	36B
C_8B9E			TST	M7790
			BEQ	41F
			CMPB	#$0C
			BCC	44F
			SUBB	#$0A
			JSR	F_8DCD
			BRA	C_8BBB
41			JSR	F_AB9E
			BRA	C_8BBB
C_8BB3			COM	M7790
			BEQ	C_8BBB
			CLR	>M009A
C_8BBB			JSR	F_C95A
			JSR	F_C972
44			RTS

;-------

F_8BC2			LDAA	M7774
			CMPA	#$04
			BEQ	3F
			CMPA	#$15
			BNE	5F
			LDAA	M7789
			TSTB
			BEQ	1F
			CMPA	#$08
			BNE	5F
			BRA	2F
1			CMPA	#$0A
			BNE	5F
2			TST	SYS_SYSAVL
			BNE	5F
			JSR	F_8C06
			JSR	F_8C06
			JSR	F_8C06
			BRA	5F
3			PSHB
			JSR	F_B6A8
			TSTB
			BNE	4F
			TAB
			LDAA	#$05
			JSR	F_AF64
			TST	$57,X
			BNE	4F
			PULB
			JSR	F_8C06
			BRA	5F
4			PULB
5			RTS

;-------

F_8C06			LDAA	M7789
			CMPA	M778D
			BHI	2F
			TSTB
			BNE	1F
			DECA
			BPL	3F
			BRA	2F
1			INCA
			CMPA	M778D
			BLS	3F
2			CLR	M7788
			CLR	M7789
			LDAA	#$01
			STAA	M00A4
			LDAA	M7774
			CMPA	#$19
			BCS	4F
			CMPA	#$1C
			BCC	4F
			PSHB
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE
			PULB
			BRA	4F
3			STAA	M7789
4			RTS

;-------

F_8C42			LDAA	M778A
			CMPA	M778E
			BHI	2F
			TSTB
			BNE	1F
			DECA
			BPL	3F
			BRA	2F
1			INCA
			CMPA	M778E
			BLS	3F
2			LDAA	#$01
			STAA	M7788
			STAA	M00A4
			CLRA
3			STAA	M778A
			RTS

;-------

F_8C64			PSHB
			LDX	#M7CE3
			LDAB	#$08
1			TIM	#%00000010,$01,X
			BNE	3F
			INX
			INX
			DECB
			BNE	1B
			LDX	#M7F39
			LDAB	M006C
2			TIM	#%00000010,$01,X
			BNE	3F
			INX
			INX
			DECB
			BNE	2B
			CLC
			BRA	4F
3			LDAA	,X
			ANDA	#$7F
			STAA	M778A
			SEC
4			PULB
			RTS

;-------

F_8C90			LDAA	M778F
			TSTB
			BEQ	1F
			INCA
			CMPA	#$0C
			BCS	2F
			CLRA
			BRA	2F
1			DECA
			CMPA	#$0C
			BCS	2F
			LDAA	#$0B
2			STAA	M778F
			RTS

;------

F_8CA9			CMPA	M00A7
			BHI	2F
			TSTB
			BNE	3F
			DECA
			TST	>M00A9
			BEQ	1F
			CMPA	M00A9
			BCC	4F
			LDAA	M00A9
			BRA	4F
1			CMPA	M00A7
			BCS	4F
2			LDAA	M00A9
			BRA	4F
3			INCA
			CMPA	M00A7
			BLS	4F
			LDAA	M00A7
4			RTS

;-------

F_8CCE			LDAA	M7773
			TSTB
			BEQ	1F
			DECA
			BRA	2F
1			INCA
2			ANDA	#$1F
			LDAB	M7773
			ANDB	#$E0
			ABA
			CMPA	#$A0
			BCS	3F
			LDAA	#$80
3			RTS

;-------

F_8CE7			LDAA	M7773
			TSTB
			BNE	1F
			SUBA	#$20
			CMPA	#$A0
			BCS	2F
			ANDA	#$1F
			ADDA	#$80
			BRA	2F
1			ADDA	#$20
			CMPA	#$A0
			BCS	2F
			ANDA	#$1F
2			RTS

;-------

F_8D02			LDAA	#$17
			STAA	M00A7
			LDAA	M7779
			JMP	F_8D0C

;-------

F_8D0C			TSTB
			BEQ	1F
			DECA
			BPL	2F
			LDAA	M00A7
			BRA	2F
1			INCA
			CMPA	M00A7
			BLS	2F
			CLRA
2			RTS

;-------

F_8D1D			CMPB	#$33
			BNE	1F
			LDAA	M778C
			ADDA	#$02
			CMPA	#$0A
			BCS	3F
			LDAA	#$09
			BRA	3F
1			CMPB	#$35
			BNE	2F
			CLRA
			BRA	3F
2			LDAA	M7774
			CMPA	#$33
			BNE	4F
			LDAA	M778C
			SUBA	#$02
			BPL	3F
			CLRA
3			STAA	M778C
4			RTS

;-------

F_8D48			PSHB
			TST	M7788
			BEQ	3F
			LDAB	M7774
			CMPB	#$03
			BNE	6F
			CMPA	#$01
			BNE	1F
			LDAA	M7789
			BEQ	4F
			LDAA	M778C
			CMPA	#$05
			BCC	4F
			DECA
			BPL	2F
			CLRA
			BRA	2F
1			LDAA	M7789
			BEQ	4F
			CMPA	#$01
			BNE	5F
			LDAA	M778C
			CMPA	#$04
			BCC	4F
			INCA
2			STAA	M778C
3			PULB
			RTS
4			CLRA
			BRA	2B
5			LDAA	M778C
			CMPA	#$04
			BCS	3B
			BRA	4B
6			CMPB	#$04
			BNE	7F
			LDAA	M7789
			BEQ	4B
			CMPA	#$03
			BEQ	4B
			CMPA	#$06
			BEQ	4B
			CMPA	#$09
			BEQ	4B
			LDAA	#$01
			BRA	2B
7			CMPB	#$07
			BNE	8F
			BRA	5B
8			CMPB	#$09
			BNE	3B
			BRA	5B

;-------

F_8DB2			TSTB
			BEQ	2F
			CMPB	#$05
			BEQ	1F
			CMPB	#$06
			BEQ	1F
			CMPB	#$08
			BNE	3F
1			LDAA	M778C
			CMPA	#$04
			BCS	3F
2			CLRA
			STAA	M778C
3			RTS

;-------

F_8DCD			CMPA	#$09
			BEQ	1F
			CMPA	#$11
			BNE	2F
1			JMP	29F
2			CMPA	#$07
			BCC	3F

			JSR	JMPOFFA
			FCB	C_8DEA - *
			FCB	C_8E38 - *
			FCB	3F - *
			FCB	3F - *
			FCB	C_8E2E - *
			FCB	C_8EBB - *
			FCB	4F - *

3			RTS
4			JMP	C_8EF6
C_8DEA			LDAA	M776B
			ANDA	#$F7
			STAA	M776B
			LDAA	M7774
			CMPA	#$1F
			BNE	6F
			JMP	21F
6			CMPA	#$1B
			BNE	7F
			LDAA	M7788
			CMPA	#$02
			BNE	3B
			BRA	14F
7			CMPA	#$1C
			BNE	3B
			LDAA	M7788
			CMPA	#$02
			BNE	3B
			LDAA	M7789
			CMPA	#$01
			BEQ	8F
			CMPA	#$03
			BNE	16F
8			LDAA	M778A
			CMPA	#$01
			BCS	9F
			CMPA	#$05
			BCS	16F
9			CLRA
			JMP	27F
C_8E2E			LDAA	M7774
			CMPA	#$3C
			BNE	3B
			JMP	C_8EF6
C_8E38			LDAA	M7774
			BEQ	13F
			CMPA	#$0B
			BCC	3B
			CMPA	#$03
			BCS	3B
			BNE	15F
			LDAA	M7788
			BEQ	3B
			CMPA	#$01
			BNE	3B
			LDAA	M7789
			BEQ	13F
			CMPA	#$01
			BEQ	12F
			JMP	C_8EF6
12			JMP	28F
13			LDAA	#$04
			JMP	26F
14			LDAA	#$03
			JMP	26F
15			CMPA	#$04
			BNE	17F
			LDAA	M7788
			CMPA	#$01
			BNE	19F
			LDAA	M7789
			BEQ	13B
			CMPA	#$03
			BEQ	13B
			CMPA	#$06
			BEQ	13B
			CMPA	#$09
			BEQ	13B
			LDAA	#$05
			BRA	26F
16			LDAA	#$01
			BRA	26F
17			CMPA	#$07
			BCS	C_8EF6
			BEQ	18F
			CMPA	#$09
			BCS	C_8EF6
			BEQ	18F
			BHI	20F
18			LDAA	M7788
			CMPA	#$01
			BEQ	C_8EF6
19			JMP	3B
20			LDAA	M7788
			CMPA	#$01
			BNE	19B
			LDAA	M7789
			CMPA	#$0F
			BNE	19B
20			LDAA	#$09
			BRA	26F
21			LDAA	#$0F
			BRA	26F
C_8EBB			LDAA	M7774
			CMPA	#$28
			BEQ	19B
			CMPA	#$34
			BEQ	19B
			CMPA	#$36
			BCC	19B
			CMPA	#$35
			BEQ	20B
			CMPA	#$33
			BNE	C_8EF6
			LDAA	PFM_EDIT_MICTUN
			CMPA	#$03
			BCS	23F
			CMPA	#$07
			BCS	20B
23			LDAA	M778C
			BEQ	24F
			CMPA	#$02
			BNE	20B
			TSTB
			BNE	20B
			DEC	M778C
			BRA	20B
24			TSTB
			BEQ	20B
			INC	M778C
			BRA	20B
C_8EF6			LDAA	#$07
26			STAA	M00A7
			CLR	>M00A9
			LDAA	M778C
			JSR	F_8CA9
27			STAA	M778C
			LDAB	M7774
			JMP	F_B1DD
28			LDAA	#$08
			BRA	26B
29			LDAA	#$01
			STAA	M00A7
			CLR	>M00A9
			LDAA	M0059
			JSR	F_8CA9
			STAA	M0059
			RTS

;-------
;
; CMI interrupt handler
;
CMI			LDAA	#T2E|CKS10		; T2 enabled, E / 128
			STAA	TCSR3			;
			LDAA	TCSR1			; save TSCR1 state
			PSHA
			AIM	#~EOCI1,TCSR1		; disable timer 1 interrupts
			LDAA	TCSR2
			PSHA
			AIM	#~EOCI2,TCSR2
			LDAA	RP5CR
			PSHA
			AIM	#~IRQ1E,RP5CR
			LDAA	XROM
			PSHA
			CLI
			COM	>M006D
			JSR	F_EC17
			JSR	F_E8D0
			JSR	F_ABC7
			TST	>M006D
			BPL	1F
			JSR	F_A390
			JSR	F_AAF7
			JSR	F_AA1A
			JSR	F_A538
			BRA	4F
1			JSR	F_A64D
			LDAA	M776B
			ANDA	#$02
			BEQ	2F
			LDAA	M7767
			BEQ	2F
			ANDA	#$03
			DECA
			STAA	M7767
			BRA	3F
2			JSR	F_ECFE
			JSR	F_A68F
3			JSR	F_A94B
4			SEI
			SPIN3
			PULA
			STAA	XROM
			PULA
			STAA	RP5CR
			PULA
			STAA	TCSR2
			PULA
			STAA	TCSR1
			OIM	#ECMI,TCSR3
			RTS

;-------
;
; Timer 1 Output Compare Interrupt
;
OCI			LDAA	RP5CR
			PSHA
			AIM	#~IRQ1E,RP5CR		; disable IRQ1 (OPZ)
			LDAA	TCSR3
			PSHA
			LDAA	TCSR2
			PSHA
			AIM	#~EOCI1,TCSR1
			AIM	#~EOCI2,TCSR2
			AIM	#~ECMI,TCSR3
			LDD	FRCH
			ADDD	#14139
			STD	OCR1H
			CLI
			PULB
			ROLB
			ROLB
			BCS	2F
			ROLB
			BCS	1F
			BRA	4F
1			NOP
			NOP
			BRA	3F
2			LDAA	M776B
			BITA	#$01
			BEQ	4F
			LDAA	XROM
			PSHA
			LDX	M0077
			PSHX
			LDX	M0079
			PSHX
			LDAA	M007B
			PSHA
			JSR	F_EAE6
			PULA
			STAA	M007B
			PULX
			STX	M0079
			PULX
			STX	M0077
			PULA
			STAA	XROM
			LDAA	M776B
			BITA	#$01
			BEQ	4F
3			SEI
			OIM	#EOCI1,TCSR1
			SPIN3
			PULA
			STAA	TCSR3
			PULA
			STAA	RP5CR
			RTS
4			SEI
			SPIN3
			PULA				; restore TCSR3
			STAA	TCSR3			; -
			PULA				; restore RP5CR
			STAA	RP5CR			; -
			RTS

;-------
;
; IRQ1 handler (OPZ chip)
;
IRQ1			LDAA	TCSR3
			PSHA
			AIM	#~ECMI,TCSR3
			AIM	#~IRQ1E,RP5CR
			CLI
			LDAB	OPZ_DATA
			BITB	#$20
			BEQ	7F
			ANDB	#$1C
			LSRB
			LSRB
			TST	>M00EF
			BEQ	3F
			PSHB
			TBA
			LDAB	#$01
1			DECA
			BMI	2F
			ASLB
			BRA	1B
2			ANDB	M00EF
			BNE	4F
			PULB
3			PSHB
			JSR	F_91B0
			PULB
			BRA	5F
4			COMB
			ANDB	M00EF
			STAB	M00EF
			PULB
			PSHB
			JSR	F_91B0
			PULB
			ORAB	#$78
			LDAA	#$08
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_B
			CLI
			ANDB	#$07
5			LDX	#M7913
			ABX
			LDAA	,X
			ANDA	#$BF
			ADDB	#$20
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_A
			CLI
			LDAB	#$40
6			LDAA	#$14
			SEI
			SPIN3
			OPZ_POLL
			OPZ_OUT_B
			OIM	#IRQ1E,RP5CR
			PULA
			STAA	TCSR3
			RTS
7			LDAB	#$30
			BRA	6B

;-------

OPZ_WAIT		OPZ_POLL
			RTS

;-------

MUL_660			LDAB	#$A5
			MUL
			ASLD
			ASLD
			RTS

MUL_200			LDAB	#$C8
			MUL
			RTS

			LDAB	#$8E
			MUL
			RTS

			LDAB	#$26
			MUL
			RTS

;-------

OPZ_INIT		CLRB
			LDAA	#$09
			JSR	OPZ_WRITE_FAST
			LDAA	#$0F
			JSR	OPZ_WRITE
			LDAA	#$1C
			JSR	OPZ_WRITE
			LDAA	#$1E
			JSR	OPZ_WRITE
			LDAA	#$0A
			LDAB	#$04
			JSR	OPZ_WRITE
			LDAA	#$14
			LDAB	#$70
			JSR	OPZ_WRITE
			LDAA	#$15
			LDAB	#$01
			JSR	OPZ_WRITE
			RTS

;-------

OPZ_WRITE		JSR	OPZ_WAIT

;-------	fallthrough

OPZ_WRITE_FAST		OPZ_OUT_B
			RTS

;-------

HI_CALL_01		PSHA
			PSHB
			PSHX
			AIM	#~EOCI1,TCSR1
			JSR	HI_CALL_16
			CLRA
			CLRB
			LDX	#M7CE3
1			STD	,X
			INX
			INX
			CPX	#M7CF3
			BNE	1B
			LDD	#$1700
2			STD	,X
			INX
			INX
			CPX	#M7D13
			BNE	2B
			LDD	#$1700
			LDX	#M7F29
3			STD	,X
			INX
			INX
			CPX	#M7F39
			BNE	3B
			CLRA
			CLRB
			LDX	#M7F39
4			STD	,X
			INX
			INX
			CPX	#M7F89
			BNE	4B
			LDX	#M00E7
			LDAA	#$FF
5			STAA	,X
			INX
			CPX	#M00EF
			BNE	5B
			JSR	F_993C
			JSR	F_995A
			PULX
			PULB
			PULA
			RTS

;-------

HI_CALL_00		PSHA
			PSHB
			PSHX
			AIM	#~IRQ1E,RP5CR
			AIM	#~EOCI1,TCSR1
			CLR	>M00EF
			BSR	F_915E
			LDAA	#$08
			CLRB
1			SEI
			SPIN3
			JSR	OPZ_WAIT
			OPZ_OUT_B
			CLI
			INCB
			CMPB	#$08
			BNE	1B
			LDAA	#$01
			STAA	M777D
			OIM	#IRQ1E,RP5CR
			PULX
			PULB
			PULA
			RTS

;-------

F_915E			CLRB
1			PSHB
			BSR	F_9169
			PULB
			INCB
			CMPB	#$08
			BNE	1B
			RTS

;------

F_9169			PSHB
			CLRA
			ADDB	#$E0
1			PSHA
			LDAA	#$FE
			SEI
			OPZ_POLL
			OPZ_OUT_A
			CLI
			ADDB	#$08
			PULA
			INCA
			CMPA	#$04
			BNE	1B
			PULB
			CLRA
2			PSHA
			PSHB
			LDX	#M77EE
			ABX
			LDAA	,X
			ANDA	#$E8
			ADDB	#$C0
			SEI
			OPZ_POLL
			OPZ_OUT_A
			CLI
			PULB
			ADDB	#$08
			PULA
			INCA
			CMPA	#$04
			BNE	2B
			RTS

;-------

F_91B0			TBA
			PSHA
			CLRB
1			PSHB
			LDX	#M77CE
			TAB
			ABX
			LDAB	,X
			PSHA
			ADDA	#$E0
			SEI
			OPZ_POLL
			OPZ_OUT_B
			CLI
			PULA
			ADDA	#$08
			PULB
			INCB
			CMPB	#$04
			BNE	1B
			PULA
			CLRB
2			PSHB
			LDX	#M77EE
			TAB
			ABX
			LDAB	,X
			PSHA
			ADDA	#$C0
			SEI
			OPZ_POLL
			OPZ_OUT_B
			CLI
			PULA
			ADDA	#$08
			PULB
			INCB
			CMPB	#$04
			BNE	2B
			RTS

;-------

F_91FE			PSHA
			PSHB
			PSHX
			JSR	HI_CALL_0F
			BRA	1F

;-------	fallthrough

HI_CALL_05		PSHA
			PSHB
			PSHX
			JSR	HI_CALL_0F
			LDX	#F_9EEC
			JSR	F_92DB
1			LDX	#F_9E95
			JSR	F_92DB
			LDX	#F_9EB9
			JSR	F_92DB
			LDX	#F_9ECC
			JSR	F_92DB
			LDX	#F_9E8A
			JSR	F_92DB
			LDX	#F_9A41
			JSR	F_92E3
			LDX	#F_9F00
			JSR	F_92DB
			LDX	#F_9DD7
			JSR	F_92DB
			LDX	#F_9E58
			JSR	F_92DB
			LDX	#F_9FEC
			JSR	F_92DB
			LDX	#F_9D68
			JSR	F_92DB
			LDX	#F_9E6D
			JSR	F_92DB
			LDX	#F_9D91
			JSR	F_92E3
			JSR	F_9A87
			LDX	#F_9B02
			JSR	F_92E3
			LDX	#F_9C35
			JSR	F_92E3
			LDX	#F_9AC2
			JSR	F_92E3
			JSR	F_9C76
			LDX	#F_9D12
			JSR	F_92E3
			LDX	#F_A049
			JSR	F_92E3
			LDX	#F_A01B
			JSR	F_92E3
			LDX	#F_A0D1
			JSR	F_92E3
			LDX	#F_A0F1
			JSR	F_92E3
			LDX	#F_A100
			JSR	F_92E3
			LDX	#F_A110
			JSR	F_92E3
			JSR	HI_CALL_18
			JSR	HI_CALL_11
			LDAA	M777D
			CMPA	#$01
			BNE	2F
			LDX	#F_9EEC
			JSR	F_92DB
			CLR	M777D
2			PULX
			PULB
			PULA
			RTS

;-------	unreachable

			LDX	#F_9D91
			JSR	F_92E3
			JSR	F_9A87
			LDX	#F_9B02
			JSR	F_92E3
			LDX	#F_9C35
			JSR	F_92E3
			LDX	#F_9AC2
			JSR	F_92E3
			JSR	F_9C76
			LDX	#F_9D12
			JSR	F_92E3
			RTS

;-------

F_92DB			STX	M0079
			LDX	#F_9306
			JMP	F_92E8

F_92E3			STX	M0079
			JMP	F_9306

;-------

F_92E8			LDD	M006F
			PSHA
			PSHB
			CLRA
			CLRB
			STD	M006F
1			PSHX
			JSR	,X
			PULX
			INC	>M006F
			LDAB	#$0D
			ADDB	M0070
			STAB	M0070
			CMPB	#$34
			BNE	1B
			PULB
			PULA
			STD	M006F
			RTS

;-------

F_9306			CLR	>M0073
			LDD	#$0000
			STD	M0074
			CLR	>M0076
1			LDX	#M00F6
			LDAB	M0073
			CMPB	#$08
			BEQ	3F
			ABX
			LDAB	,X
			STAB	M007B
			BEQ	2F
			LDX	M0079
			JSR	,X
2			CLRA
			LDAB	#110
			ADDD	M0074
			STD	M0074
			LDAA	M0076
			CMPA	#$08
			BEQ	3F
			INC	>M0073
			BRA	1B
3			RTS

;-------

HI_CALL_0F		LDAA	TCSR1
			PSHA
			AIM	#~EOCI1,TCSR1
			LDX	#M00F6
			STX	M0079
			LDAB	M7772
			ANDB	#$04
			BNE	7F
			CLRB
1			CMPB	#$01
			BNE	2F
			LDAA	M7774
			CMPA	#$1A
			BNE	5F
			TST	M7788
			BEQ	5F
			BRA	3F
2			TSTB
			BNE	5F
			LDAA	M7774
			CMPA	#$1A
			BNE	4F
			TST	M7788
			BEQ	4F
3			LDAA	#$04
			BRA	6F
4			LDAA	#$08
			BRA	6F
5			CLRA
6			STAA	,X
			INX
			INCB
			CMPB	#$08
			BNE	1B
			BRA	8F
7			JSR	F_95F5
8			LDAA	#$FF
			LDAB	#$08
			LDX	#M7942
9			STAA	,X
			DEX
			DECB
			BNE	9B
			LDX	#M793B
			STX	M0079
			LDX	#M00F6
			CLRB
10			LDAA	,X
			PSHX
			LDX	M0079
			TSTA
			BEQ	12F
11			STAB	,X
			INX
			DECA
			BNE	11B
			BRA	12F
12			INCB
			STX	M0079
			CPX	#M7943
			PULX
			BEQ	13F
			INX
			CPX	#M00FE
			BNE	10B
13			LDAB	#$FF
			STAB	M784E
			STAB	M784F
			CLRB
14			PSHB
			LDX	#M00F6
			ABX
			TST	,X
			BEQ	16F
			TST	M784E
			BPL	15F
			STAB	M784E
			BRA	16F
15			TST	M784F
			BPL	16F
			STAB	M784F
16			PULB
			INCB
			CMPB	#$08
			BNE	14B
			LDX	#M7846
			STX	M0079
			CLRB
17			PSHB
			LDX	#M793B
			ABX
			LDAB	,X
			BMI	19F
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAB	$0A,X
			BEQ	19F
			CMPB	#$03
			BCC	20F
			PSHB
			DECB
			LDX	#M784E
			ABX
			LDAA	,X
			BMI	18F
			ASLA
			ASLA
			PULB
			ABA
			BRA	21F
18			PULB
19			CLRA
			BRA	21F
20			TBA
21			LDX	M0079
			STAA	,X
			INX
			STX	M0079
			PULB
			INCB
			CMPB	#$08
			BNE	17B
			LDAB	#$FF
			STAB	M7850
			STAB	M7851
			CLRB
22			PSHB
			LDX	#M7846
			ABX
			LDAA	,X
			ANDA	#$03
			BEQ	24F
			CMPA	#$03
			BCC	24F
			CMPA	#$01
			BNE	23F
			TST	M7850
			BPL	24F
			STAB	M7850
			BRA	24F
23			TST	M7851
			BPL	24F
			STAB	M7851
24			PULB
			INCB
			CMPB	#$08
			BNE	22B
			JSR	F_95C4
			LDAB	M7772
			ANDB	#$04
			BNE	30F
			LDAA	M7774
			CMPA	#$1A
			BNE	26F
			TST	M7788
			BEQ	26F
			LDAA	#$04
			LDX	#M793B
25			DEX
			STAA	,X
			CPX	#M7933
			BEQ	28F
			CPX	#M7937
			BHI	25B
			LDAA	#$02
			BRA	25B
26			LDAA	#$07
			LDX	#M793B
27			DEX
			STAA	,X
			CPX	#M7933
			BNE	27B
28			LDAA	#$01
			LDX	#M784E
29			DEX
			STAA	,X
			CPX	#M7846
			BNE	29B
			CLR	M7850
			LDAA	#$FF
			STAA	M7851
			LDAA	#$08
			STAA	M006C
			BRA	31F
30			LDAA	#$05
			STAA	M006C
			JSR	F_C7FF
31			JSR	F_98A1
			JSR	F_995A
			LDAA	TCSR3
			PSHA
			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_15
			PULA
			STAA	TCSR3
			JSR	HI_CALL_03
			PULA
			STAA	TCSR1
			RTS

;-------

F_94C9			PSHA
			PSHB
			PSHX
			BRA	1F
			PSHA
			PSHB
			PSHX
			LDX	#F_9EEC
			JSR	F_9575
1			LDX	#F_9E95
			JSR	F_9575
			LDX	#F_9EB9
			JSR	F_9575
			LDX	#F_9ECC
			JSR	F_9575
			LDX	#F_9E8A
			JSR	F_9575
			LDX	#F_9A41
			JSR	F_957D
			LDX	#F_9F00
			JSR	F_9575
			LDX	#F_9DD7
			JSR	F_9575
			LDX	#F_9E58
			JSR	F_9575
			LDX	#F_9FEC
			JSR	F_9575
			LDX	#F_9D68
			JSR	F_9575
			LDX	#F_9E6D
			JSR	F_9575
			LDX	#F_9D91
			JSR	F_957D
			JSR	F_9A87
			LDX	#F_9B02
			JSR	F_957D
			LDX	#F_9C35
			JSR	F_957D
			LDX	#F_9AC2
			JSR	F_957D
			JSR	F_9C76
			LDX	#F_9D12
			JSR	F_957D
			LDX	#F_A049
			JSR	F_957D
			LDX	#F_A01B
			JSR	F_957D
			LDX	#F_A0D1
			JSR	F_957D
			LDX	#F_A0F1
			JSR	F_957D
			LDX	#F_A100
			JSR	F_957D
			LDX	#F_A110
			JSR	F_957D
			LDAA	M777D
			CMPA	#$01
			BNE	2F
			LDX	#F_9EEC
			JSR	F_9575
			CLR	M777D
2			PULX
			PULB
			PULA
			RTS

;-------

F_9575			STX	M0079
			LDX	#F_9582
			JMP	F_92E8

;-------

F_957D			STX	M0079
			JMP	F_9582

;-------

F_9582			LDAB	M0073
			LDX	#M7EF1
			ABX
			LDAA	,X
			STAA	M0076
			LDX	#M00F6
			LDAB	M0073
			ABX
			LDAB	,X
			STAB	M007B
			BEQ	1F
			LDAA	M0073
			LDAB	#110
			MUL
			STD	M0074
			LDX	M0079
			JSR	,X
1			RTS

;-------

F_95A4			LDX	#M7EF1
			ABX
			LDAA	,X
			LDX	#M00F6
			ABX
			TAB
			LDAA	,X
			BEQ	2F
1			PSHA
			PSHB
			JSR	F_9169
			PULB
			INCB
			PULA
			DECA
			BNE	1B
			LDAA	#$01
			STAA	M777D
2			RTS

;-------

F_95C4			CLR	>M0076
1			JSR	F_9A1C
			LDAA	$09,X
			LDX	#M7933
			LDAB	M0076
			ABX
			ASLA
			CMPA	#$06
			BNE	2F
			ORAA	#$01
2			STAA	,X
			INC	>M0076
			LDAB	M0076
			CMPB	#$08
			BNE	1B
			RTS

;-------

F_95E5			JSR	F_95C4
			LDX	#F_9A41
			JSR	F_92E3
			LDX	#F_9F00
			JSR	F_92DB
			RTS

;-------

F_95F5			CLRB
1			PSHB
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAA	,X
			LDX	M0079
			STAA	,X
			INX
			STX	M0079
			PULB
			INCB
			CMPB	#$08
			BNE	1B
			RTS

;-------

HI_CALL_03		LDAB	M7772
			ANDB	#$04
			BNE	2F
			JSR	F_9881
			TAB
			LDAA	M778F
			BRA	3F
1			LDX	#MICROTUNE_OCT
			JMP	11F
2			LDAB	PFM_EDIT_MICTUN
			LDAA	PFM_EDIT_KEY
3			CMPB	#$02
			BCS	1B
			SUBB	#$02
			JSR	F_969B
			LDX	#M7F9A
			STX	M00A9
			LDX	#M7F9A
			STX	M00A7
			CLRB
4			PSHB
			LDX	M00A9
			LDD	,X
			PSHA
			LDAA	M7772
			ANDA	#$04
			BNE	5F
			JSR	F_9881
			BRA	6F
5			LDAA	PFM_EDIT_MICTUN
6			CMPA	#$0B
			PULA
			BCS	8F
			BNE	7F
			SUBA	#$1E
			BRA	9F
7			SUBA	#$0F
			BRA	9F
8			SUBA	#$3C
9			INX
			INX
			STX	M00A9
			LDX	M00A7
			STD	,X
			INX
			INX
			STX	M00A7
			PULB
			INCB
			CMPB	#$0C
			BNE	4B
10			RTS
11			STX	M00A9
			LDX	#M7F9A
			STX	M00A7
			CLRB
12			PSHB
			LDX	M00A9
			LDD	,X
			SUBA	#$3C
			INX
			INX
			STX	M00A9
			LDX	M00A7
			STD	,X
			INX
			INX
			STX	M00A7
			PULB
			INCB
			CMPB	#$0C
			BNE	12B
			JMP	10B

;-------

F_969B			LDX	#DVEC_9703
			ABX
			ABX
			LDX	,X
			STX	M00A9
			TSTB
			BEQ	1F
			CMPB	#$05
			BCS	2F
1			LDAB	#$18
			LDX	#M7F9A
			JSR	MEMCPY_xB_A9_X
			JMP	5F
2			ASLA
			PSHA
			DECB
			LDAA	#$18
			MUL
			PULA
			PSHA
			ABA
			TAB
			LDX	#M9821
			ABX
			LDD	,X
			STD	M007E
			LDX	#M7F9A
			PULB
			ABX
			STX	M00A7
			LDAB	#$0C
3			PSHB
			LDX	M00A9
			LDD	,X
			INX
			INX
			STX	M00A9
			SUBA	#$0D
			ASLB
			ASLB
			LSRD
			LSRD
			ADDD	M007E
			ASLD
			ASLD
			ADDA	#$0D
			LSRB
			LSRB
			LDX	M00A7
			CPX	#M7FB2
			BCS	4F
			XGDX
			SUBD	#$0018
			XGDX
			SUBA	#$0C
4			STD	,X
			LDX	M00A7
			INX
			INX
			STX	M00A7
			PULB
			DECB
			BNE	3B
5			RTS

DVEC_9703		FDB	M9719_via_dvec_9703
			FDB	M9731_via_dvec_9705
			FDB	M9749_via_dvec_9707
			FDB	M9761_via_dvec_9709
			FDB	M9779_via_dvec_970b
			FDB	M9791_via_dvec_970d
			FDB	M97A9_via_dvec_970f
			FDB	M97C1_via_dvec_9711
			FDB	M97D9_via_dvec_9713
			FDB	M97F1_via_dvec_9715
			FDB	M9809_via_dvec_9717

M9719_via_dvec_9703	FDB	$3C00,$3D00,$3E00,$3F00,$4000,$4100,$4200,$4300
			FDB	$4400,$4500,$4600,$4700

M9731_via_dvec_9705	FDB	$3C0A,$3C37,$3E0D,$3F14,$4001,$4109,$4136,$430B
			FDB	$4338,$4500,$4615,$4703

M9749_via_dvec_9707	FDB	$3C0A,$3C37,$3D3F,$3F14,$4001,$4109,$4136,$430B
			FDB	$4338,$4500,$4615,$4703

M9761_via_dvec_9709	FDB	$3C07,$3C37,$3E02,$3F0D,$3F3E,$4109,$4139,$4304
			FDB	$4335,$4500,$460B,$463C

M9779_via_dvec_970b	FDB	$3B3C,$3D05,$3D3F,$3E38,$4001,$403B,$4204,$423D
			FDB	$4406,$4500,$453A,$4703

M9791_via_dvec_970d	FDB	$3C08,$3D01,$3E03,$3F04,$4001,$4106,$4200,$4305
			FDB	$4403,$4500,$4605,$4703

M97A9_via_dvec_970f	FDB	$3C07,$3D00,$3E02,$3F03,$3F3E,$4105,$4200,$4304
			FDB	$4402,$4500,$4604,$463F

M97C1_via_dvec_9711	FDB	$3C04,$3D00,$3E01,$3F03,$3F3F,$4105,$413F,$4303
			FDB	$4401,$4500,$4604,$463D

M97D9_via_dvec_9713	FDB	$3C20,$3D20,$3E20,$3F20,$4020,$4120,$4220,$4320
			FDB	$4420,$4520,$4620,$4720

M97F1_via_dvec_9715	FDB	$4200,$4220,$4300,$4320,$4400,$4420,$4500,$4520
			FDB	$4600,$4620,$4700,$4720

M9809_via_dvec_9717	FDB	$3F00,$3F10,$3F20,$3F30,$4000,$4010,$4020,$4030
			FDB	$4100,$4110,$4120,$4130

M9821			FDB	$0000,$0048,$0075,$00CA,$00F7,$013F,$016C,$01B3
			FDB	$0209,$0236,$027D,$02AB,$0000,$0048,$0075,$00CA
			FDB	$00F7,$013F,$016C,$01C1,$0209,$0236,$027D,$02AB
			FDB	$0000,$004B,$007C,$00C7,$00F7,$0142,$0173,$01BE
			FDB	$0209,$0239,$0284,$02B5,$0000,$003A,$0083,$00BC
			FDB	$0105,$013F,$0188,$01C1,$01FB,$0244,$027D,$02C6

;-------

F_9881			LDAA	M7774
			CMPA	#$1C
			BNE	1F
			LDAA	M7788
			CMPA	#$02
			BNE	1F
			LDAA	M7789
			BEQ	1F
			CMPA	#$02
			BEQ	1F
			LDAA	M778A
			ADDA	#$02
			BRA	2F
1			CLRA
2			RTS

;-------

F_98A1			CLR	>M0072
1			LDAB	M0072
			LDX	#M00F6
			ABX
			TST	,X
			BNE	2F
			LDAA	#$FF
			BRA	4F
2			CLRB
			CLRA
			LDX	#M00F6
3			CMPB	M0072
			BEQ	4F
			ADDA	,X
			INCB
			INX
			BRA	3B
4			LDAB	M0072
			LDX	#M7EF1
			ABX
			STAA	,X
			LDAB	M0072
			INCB
			STAB	M0072
			CMPB	#$08
			BNE	1B
			CLRB
5			LDX	#M7EF1
			ABX
			LDAA	,X
			BPL	6F
			LDAA	#$FF
			BRA	7F
6			LDX	#M00F6
			ABX
			ADDA	,X
			DECA
7			LDX	#M7EF9
			ABX
			STAA	,X
			INCB
			CMPB	#$08
			BNE	5B
			LDAB	M7772
			ANDB	#$04
			BEQ	9F
			TST	PFM_EDIT_ASSIGN
			BEQ	9F
			CLRA
			CLRB
8			LDX	#M00F6
			ABX
			ADDA	,X
			INCB
			CMPB	#$08
			BNE	8B
			DECA
			STAA	M7EF9
			CLR	M7EF1
9			CLRB
10			PSHB
			LDX	#M7EF1
			ABX
			LDAB	,X
			BPL	11F
			LDX	#M00E7
			BRA	12F
11			LDX	#M00E7
			ABX
12			STX	M0077
			LDX	#M7F09
			PULB
			PSHB
			ASLB
			ABX
			LDD	M0077
			STD	,X
			STD	$10,X
			PULB
			INCB
			CMPB	#$08
			BNE	10B
			BSR	F_993C
			RTS

;-------

F_993C			LDX	#M7EE9
			LDAB	#$08
1			LDAA	$08,X
			BPL	2F
			LDAA	#$FF
			BRA	3F
2			ASLA
3			STAA	,X
			INX
			DECB
			BNE	1B
			CLRA
			LDX	#M7F08
			LDAB	#$08
			JSR	F_C7F8
			RTS

;-------

F_995A			LDX	#M7F89
1			CLR	,X
			INX
			CPX	#M7F99
			BCS	1B
			LDAA	#$01
			STAA	M007B
			LDAA	M7772
			ANDA	#$04
			BEQ	5F
			CLRA
2			PSHA
			LDAB	#12
			MUL
			ADDD	#PFM_EDIT_BUF
			XGDX
			LDAB	,X
			BEQ	4F
			LDAB	$03,X
			CMPB	#$10
			BNE	3F
			BSR	F_99DE
			BRA	4F
3			LDX	#M7F89
			ABX
			LDAB	M007B
			ORAB	,X
			STAB	,X
4			PULA
			TST	PFM_EDIT_ASSIGN
			BNE	9F
			INCA
			ASL	>M007B
			BNE	2B
			BRA	9F
5			CLRA
6			PSHA
			LDAB	SYS_MIDBCH
			CMPB	#$10
			BEQ	8F
			LDX	#M7F89
			ABX
			LDAB	M007B
			ORAB	,X
			STAB	,X
7			PULA
			LDAB	M7774
			CMPB	#$1A
			BNE	9F
			TST	M7788
			BEQ	9F
			INCA
			CMPA	#$02
			BEQ	9F
			ASL	>M007B
			BRA	6B
8			BSR	F_99DE
			BRA	7B
9			LDAB	MIDI_RX_CMD
			CMPB	#SYX
			BCC	10F
			ANDB	#$0F
			LDX	#M7F89
			ABX
			LDAB	,X
			STAB	M00DA
10			RTS

;-------

F_99DE			CLRB
1			LDX	#M7F89
			ABX
			LDAA	M007B
			ORAA	,X
			STAA	,X
			INCB
			CMPB	#$10
			BNE	1B
			RTS

;-------

F_99EF			LDD	#M6A67
			ADDD	M0074
			XGDX
			LDAB	M0070
			ABX
			RTS

;-------

F_99F9			LDAA	M006F
			LDAB	#$05
			MUL
			LDX	#M6ABE
			ABX
			XGDX
			ADDD	M0074
			XGDX
			RTS

;-------

F_9A07			TAB
			LDX	#M793B
			ABX
			LDAA	,X
			CMPA	#$08
			BCS	1F
			CLRA
			BSR	F_9A2F
			SEC
			BRA	2F
1			BSR	F_9A2F
			CLC
2			RTS

;-------

F_9A1C			LDX	#M793B
			LDAB	M0076
			ABX
			LDAB	,X
			BPL	1F
			CLRB
1			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			RTS

;-------

F_9A2F			LDAB	#110
			MUL
			ADDD	#M6A67
			XGDX
			RTS

;-------

HI_CALL_11		LDAA	EF2R
			JSR	MUL_660
			STAA	M7750
			RTS

;-------

F_9A41			LDD	#M6A9B
			ADDD	M0074
			XGDX
			LDAB	$01,X
			ASLB
			ASLB
			ASLB
			ORAB	,X
			STAB	M0072
1			LDX	#M7933
			LDAB	M0076
			ABX
			LDAA	,X
			ANDA	#$04
			BEQ	2F
			LDAB	#$80
			BRA	3F
2			CLRB
3			ORAB	M0072
			TBA
			LDX	#M7913
			LDAB	M0076
			ABX
			STAA	,X
			LDAB	#$20
			ADDB	M0076
			SEI
			JSR	OPZ_WAIT
			OPZ_OUT_A
			CLI
			INC	>M0076
			DEC	>M007B
			BNE	1B
			RTS

;-------

F_9A87			CLR	>M0072
			LDAA	M784E
			BMI	1F
			JSR	F_9A2F
			LDAA	$3B,X
			ANDA	#$03
			STAA	M0072
1			LDAA	M784F
			BMI	2F
			JSR	F_9A2F
			LDAA	$3B,X
			ANDA	#$03
			ASLA
			ASLA
			ORAA	M0072
			STAA	M0072
2			LDAA	M0072
			STAA	M7852
			LDAB	#$1B
			SEI
			SPIN3
			JSR	OPZ_WAIT
			OPZ_OUT_A
			CLI
			RTS

;-------

F_9AC2			JSR	F_A120
			JSR	F_9AE2
			LDAA	$3A,X
			LDX	#M782E
			STX	M00A7
			JMP	F_9AD2

;-------

F_9AD2			LDX	M00A7
			LDAB	M0076
			ABX
			STAA	,X
			INC	>M0076
			DEC	>M007B
			BNE	F_9AD2
			RTS

;-------

F_9AE2			PSHX
			LDX	#M7846
			LDAB	M0076
			ABX
			LDAB	,X
			ANDB	#$03
			BEQ	1F
			CMPB	#$03
			BEQ	1F
			LDAB	,X
			PULX
			LSRB
			LSRB
			ANDB	#$07
			TBA
			JSR	F_9A2F
			BRA	2F
1			PULX
2			RTS

;-------

F_9B02			LDAB	#$36
			JSR	F_A121
			PSHX
			LDX	#M7846
			LDAB	M0076
			ABX
			LDAB	,X
			ANDB	#$03
			BEQ	4F
			CMPB	#$03
			BEQ	4F
			PSHB
			LDAB	,X
			LSRB
			LSRB
			ANDB	#$07
			TBA
			JSR	F_9A2F
			LDAA	$36,X
			JSR	MUL_660
			LDAB	$3B,X
			CMPB	#$03
			BEQ	1F
			LDX	#MA82B
			TAB
			ABX
			LDAA	,X
			COMA
1			PULB
			CMPB	#$01
			BEQ	2F
			LDAB	#$16
			BRA	3F
2			LDAB	#$18
3			SEI
			JSR	OPZ_WAIT
			OPZ_OUT_A
			CLI
4			PULX
			LDAB	,X
			ASLB
			LDX	#D_9B6D
			ABX
			LDD	,X
5			PSHB
			LDX	#M781E
			LDAB	M0076
			ASLB
			ABX
			PULB
			STD	,X
			INC	>M0076
			DEC	>M007B
			BNE	5B
			RTS

D_9B6D			FDB	$0001,$0002,$000E,$001B
			FDB	$003D,$0052,$0081,$00BF
			FDB	$00EF,$0125,$0169,$01C9
			FDB	$020D,$026C,$02FB,$0346
			FDB	$03D5,$0420,$048D,$051D
			FDB	$05F7,$06D1,$071C,$07F6
			FDB	$083A,$08D0,$0A39,$0AC8
			FDB	$0BED,$0C7D,$0DA2,$0E31
			FDB	$0F56,$107B,$110A,$1199
			FDB	$122F,$1472,$1598,$16B6
			FDB	$17DB,$1900,$1B43,$1C68
			FDB	$1D87,$1EAC,$1FD1,$20EF
			FDB	$2214,$2339,$2339,$26A2
			FDB	$28E5,$28E5,$2B2F,$2D72
			FDB	$2FB6,$3200,$3443,$3443
			FDB	$3687,$38D1,$3B14,$3B14
			FDB	$3D57,$3FA2,$41E5,$41E5
			FDB	$4428,$4428,$4672,$48B6
			FDB	$48B6,$4D43,$51CA,$51CA
			FDB	$5657,$5AE5,$5AE5,$5F6C
			FDB	$63F9,$63F9,$6887,$6887
			FDB	$6D0D,$719B,$719B,$7628
			FDB	$7628,$7AB6,$7AB6,$7F3C
			FDB	$7F3C,$83CA,$83CA,$83CA
			FDB	$8857,$8CDE,$8CDE,$8CDE

;-------

F_9C35			LDAB	#$37
			JSR	F_A121
			PSHX
			LDX	#M7846
			LDAB	M0076
			ABX
			LDAB	,X
			ANDB	#$03
			BEQ	1F
			CMPB	#$03
			BEQ	1F
			LDAB	,X
			LSRB
			LSRB
			ANDB	#$07
			TBA
			JSR	F_9A2F
			LDAB	#$37
			ABX
			JSR	F_9CF5
			PULX
			BRA	2F
1			PULX
			JSR	F_9CF5
2			PSHB
			LDX	#M780E
			LDAB	M0076
			ASLB
			ABX
			PULB
			STD	,X
			INC	>M0076
			DEC	>M007B
			BNE	2B
			RTS

;-------

F_9C76			LDX	#M784E
			STX	M00A9
			LDX	#M7D13
			STX	M00A7
1			LDX	M00A9
			LDAA	,X
			BMI	2F
			JSR	F_9A2F
			LDAA	$39,X
			JSR	MUL_660
			PSHX
			LDX	M00A7
			STAA	,X
			PULX
			LDAA	$48,X
			JSR	MUL_660
			PSHX
			LDX	M00A7
			STAA	$02,X
			PULX
			LDAA	$4A,X
			JSR	MUL_660
			PSHX
			LDX	M00A7
			STAA	$04,X
			PULX
			LDAA	$6D,X
			JSR	MUL_660
			LDX	M00A7
			STAA	$06,X
2			LDX	M00A7
			INX
			STX	M00A7
			LDX	M00A9
			INX
			STX	M00A9
			CPX	#M7850
			BNE	1B
			LDX	#M7D3B
			STX	M00A7
			CLRA
3			PSHA
			JSR	F_9A07
			LDAA	$47,X
			JSR	MUL_660
			PSHX
			LDX	M00A7
			STAA	,X
			PULX
			LDAA	$49,X
			JSR	MUL_660
			PSHX
			LDX	M00A7
			STAA	$08,X
			PULX
			LDAA	$6C,X
			JSR	MUL_660
			LDX	M00A7
			STAA	$10,X
			INX
			STX	M00A7
			PULA
			INCA
			CMPA	#$08
			BNE	3B
			RTS

;-------

F_9CF5			LDAA	#$63
			SUBA	,X
			TAB
			ANDB	#$70
			LSRB
			LSRB
			LSRB
			LSRB
			SUBB	#$07
			NEGB
			STAB	M0071
			ANDA	#$0F
			ORAA	#$10
			ASLA
			CLRB
1			LSRD
			DEC	>M0071
			BNE	1B
			RTS

;-------

F_9D12			JSR	F_A120
			JSR	F_9AE2
			LDAA	$38,X
			JSR	MUL_660
			LDX	#M7D7B
			STX	M00A7
			JMP	F_9AD2

;-------

F_9D25			LDAB	M006F
			ASLB
			ASLB
			ASLB
			ABA
			ADDA	M0076
			LDAB	M0072
1			SEI
			JSR	OPZ_WAIT
			OPZ_OUT_B
			CLI
			PSHB
			CMPA	#$C0
			BCS	4F
			CMPA	#$E0
			BCC	2F
			BITB	#$20
			BEQ	4F
			TAB
			SUBB	#$C0
			LDX	#M77EE
			BRA	3F
2			TAB
			SUBB	#$E0
			LDX	#M77CE
3			ABX
			LDAB	M0072
			STAB	,X
4			PULB
			INCA
			INC	>M0076
			DEC	>M007B
			BNE	1B
			RTS

;-------

F_9D68			JSR	F_99EF
			LDAB	$07,X
			LDX	#D_9D89
			ABX
			LDAA	,X
1			LDX	#M7853
			LDAB	M006F
			ASLB
			ASLB
			ASLB
			ADDB	M0076
			ABX
			STAA	,X
			INC	>M0076
			DEC	>M007B
			BNE	1B
			RTS

D_9D89			FCB	$00,$25,$49,$6E,$92,$B7,$DB,$FF

;-------

F_9D91			LDX	#M7846
			LDAB	M0076
			ABX
			LDAB	,X
			ANDB	#$03
			BEQ	1F
			CMPB	#$03
			BEQ	1F
			PSHB
			LDAB	#$3C
			JSR	F_A121
			ASLA
			ASLA
			ASLA
			ASLA
			LDAB	$01,X
			ABA
			PULB
			CMPB	#$02
			BNE	2F
			ORAA	#$84
			BRA	2F
1			CLRA
2			TAB
3			LDAA	#$38
			ADDA	M0076
			BSR	4F
			INC	>M0076
			DEC	>M007B
			BNE	3B
			RTS
4			SEI
			JSR	OPZ_WAIT
			OPZ_OUT_B
			CLI
			RTS

;-------

F_9DD7			JSR	F_99EF
			PSHX
			JSR	F_99F9
			TST	,X
			BNE	1F
			CLRB
			BRA	2F
1			LDAB	#$01
			LDAA	$01,X
			PULX
			BRA	4F
2			PULX
			LDAA	$0C,X
			CMPA	#$03
			BCC	3F
			COMA
			BRA	4F
3			SUBA	#$03
4			ASLA
			ASLA
			ASLA
			ASLA
			TSTB
			BEQ	5F
			LDAB	$0B,X
			BRA	6F
5			LDAB	$0B,X
			LDX	#D_9E18
			ABX
			LDAB	,X
6			LSRB
			LSRB
			ABA
			ANDA	#$7F
			STAA	M0072
			LDAA	#$40
			JSR	F_9D25
			RTS

D_9E18			FCB	$00,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0C,$0A,$0B
			FCB	$10,$0D,$0E,$14,$0F,$11,$18,$12,$13,$1C,$15,$16,$20
			FCB	$19,$17,$24,$1A,$1D,$28,$1B,$1E,$2C,$21,$30,$1F,$22
			FCB	$25,$34,$23,$38,$29,$26,$3C,$2D,$27,$2A,$31,$2E,$2B
			FCB	$35,$32,$2F,$39,$36,$33,$3D,$3A,$37,$3E,$3B,$3F

;-------

F_9E58			JSR	F_99F9
			LDAA	$03,X
			ASLA
			ASLA
			ASLA
			ASLA
			ADDA	$02,X
			ORAA	#$80
			STAA	M0072
			LDAA	#$40
			JSR	F_9D25
			RTS

;-------

F_9E6D			JSR	F_99F9
			LDAB	$04,X
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			PSHB
			LDAB	#$6B
			JSR	F_A121
			PULB
			ABA
			ORAA	#$28
			STAA	M0072
			LDAA	#$C0
			JSR	F_9D25
			RTS

;-------

F_9E8A			CLRA
			ORAA	#$28
			STAA	M0072
			LDAA	#$C0
			JSR	F_9D25
			RTS

;-------

F_9E95			JSR	F_99EF
			LDAB	$06,X
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			ADDB	,X
			PSHB
			JSR	F_99F9
			PULB
			TST	,X
			BEQ	1F
			ORAB	#$20
			BRA	2F
1			ANDB	#$DF
2			STAB	M0072
			LDAA	#$80
			JSR	F_9D25
			RTS

;-------

F_9EB9			JSR	F_99EF
			LDAB	$08,X
			RORB
			RORB
			ANDB	#$80
			ADDB	$01,X
			STAB	M0072
			LDAA	#$A0
			JSR	F_9D25
			RTS

;-------

F_9ECC			JSR	F_99EF
			LDAA	$02,X
			LDAB	$0B,X
			LDX	#D_9E18
			ABX
			LDAB	,X
			ANDB	#$03
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			ASLB
			ABA
			ANDA	#$DF
			STAA	M0072
			LDAA	#$C0
			JSR	F_9D25
			RTS

;-------

F_9EEC			JSR	F_99EF
			LDAA	$04,X
			COMA
			ASLA
			ASLA
			ASLA
			ASLA
			ADDA	$03,X
			STAA	M0072
			LDAA	#$E0
			JSR	F_9D25
			RTS

;-------

F_9F00			JSR	F_99EF
			LDAA	$05,X
			JSR	MUL_660
			STAA	M007C
			LDAB	#$0A
			ABX
			JSR	F_9FD9
			LDX	#M7913
			LDAB	M0076
			ABX
			LDAB	,X
			ANDB	#$07
			SUBB	#$04
			BCS	2F
			CMPB	#$04
			BCS	1F
			CLRB
1			JSR	JMPOFFB
			FCB	C_9F32 - *
			FCB	C_9F3C - *
			FCB	C_9F3C - *
			FCB	C_9F45 - *

2			LDAB	M006F
			CMPB	#$03
			BNE	7F
			BRA	8F
C_9F32			LDAB	M006F
			BITB	#$02
			BEQ	7F
			ADDA	#$08
			BRA	6F
C_9F3C			TST	>M006F
			BEQ	7F
			ADDA	#$0D
			BRA	6F
C_9F45			ADDA	#$10
6			BPL	8F
			LDAA	#$7F
			BRA	8F
7			ASLA
			BRA	10F
8			ASLA
			LDAB	M7772
			ANDB	#$04
			BEQ	10F
			LDX	#M7933
			LDAB	M0076
			ABX
			TST	,X
			BEQ	9F
			LDX	#M793B
			LDAB	M0076
			ABX
			LDAB	,X
			BPL	10F
9			LDAA	#$FF
10			STAA	M007D
11			LDX	#M7943
			LDAB	M006F
			LDAA	#$1D
			MUL
			ABX
			STX	M007E
			LDAB	M0076
			LDAA	#$74
			MUL
			ADDD	M007E
			XGDX
			CLRB
12			PSHB
			PSHX
			LDX	#D_9FBC
			ABX
			LDAA	,X
			PULX
			LDAB	M007C
			MUL
			ADDA	M007D
			BCC	13F
			LDAA	#$FF
13			STAA	,X
			INX
			PULB
			INCB
			CMPB	#$1D
			BNE	12B
			INC	>M0076
			DEC	>M007B
			BNE	11B
			RTS

;-------

D_9FA8			FCB	$7F,$7A,$76,$72,$6E,$6B
			FCB	$68,$66,$64,$62,$60,$5E
			FCB	$5C,$5A,$58,$56,$55,$54
			FCB	$52,$51

;-------

D_9FBC			FCB	$00,$01,$02,$03,$04,$05
			FCB	$06,$07,$08,$09,$0B,$0E
			FCB	$10,$13,$17,$1C,$21,$27
			FCB	$2F,$39,$43,$50,$5F,$71
			FCB	$86,$A0,$BE,$E0,$FF

;-------

F_9FD9			LDAB	,X
			CMPB	#$14
			BCS	1F
			LDAA	#$63
			SUBA	,X
			BRA	2F
1			LDX	#D_9FA8
			ABX
			LDAA	,X
2			RTS

;-------

F_9FEC			JSR	F_99EF
			LDAA	$09,X
			BEQ	1F
			LDAB	#$20
			MUL
			LDAA	$09,X
			ASLA
			ORAA	#$F0
			COMA
			BRA	2F
1			LDD	#$0000
2			PSHB
			LDX	#M78D3
			LDAB	M006F
			ASLB
			ASLB
			ASLB
			ADDB	M0076
			ABX
			PULB
			STAA	,X
			STAB	$20,X
			INC	>M0076
			DEC	>M007B
			BNE	2B
			RTS

;-------

F_A01B			LDAB	#$3E
			JSR	F_A121
			SUBA	#$18
			LDAB	M7772
			ANDB	#$04
			BEQ	1F
			LDX	#M793B
			LDAB	M0076
			ABX
			LDAB	,X
			BMI	1F
			PSHA
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAB	$07,X
			SUBB	#$18
			PULA
			ABA
1			LDX	#M791B
			STX	M00A7
			JMP	F_9AD2

;-------

F_A049			LDAB	M7772
			ANDB	#$04
			BEQ	1F
			TST	PFM_EDIT_ASSIGN
			BEQ	1F
			LDAB	M6AA9
			BRA	2F
1			LDAB	#$42
			JSR	F_A121
2			LDX	#D_A06D
			ABX
			LDAA	,X
			LDX	#M77C6
			STX	M00A7
			JMP	F_9AD2

D_A06D			FCB	$FF,$FE,$F3,$E8,$D3,$CA,$C1,$B9
			FCB	$B2,$AB,$A5,$9F,$99,$93,$8D,$87
			FCB	$82,$7D,$78,$73,$6E,$6A,$66,$62
			FCB	$5E,$5B,$58,$55,$52,$4F,$4C,$4A
			FCB	$48,$46,$44,$42,$40,$3E,$3C,$3A
			FCB	$38,$36,$35,$33,$31,$2F,$2E,$2C
			FCB	$2A,$29,$27,$26,$25,$24,$22,$21
			FCB	$1F,$1E,$1C,$1B,$1A,$19,$18,$17
			FCB	$16,$15,$14,$13,$12,$12,$11,$10
			FCB	$10,$0F,$0E,$0E,$0D,$0D,$0C,$0C
			FCB	$0B,$0B,$0A,$0A,$09,$09,$08,$08
			FCB	$07,$07,$06,$06,$05,$05,$04,$04
			FCB	$03,$03,$02,$01

;-------

F_A0D1			LDAB	#$40
			JSR	F_A121
			LDX	#D_A0E4
			ABX
			LDAA	,X
			LDX	#M7923
			STX	M00A7
			JMP	F_9AD2

D_A0E4			FCB	$00,$10,$21,$31,$41,$51,$61,$71
			FCB	$81,$91,$A2,$B2,$C2

;-------

F_A0F1			LDAB	#$4B
			JSR	F_A121
			SUBA	#$32
			LDX	#M792B
			STX	M00A7
			JMP	F_9AD2

;-------

F_A100			LDAB	#$43
			JSR	F_A121
			JSR	MUL_660
			LDX	#M7D1B
			STX	M00A7
			JMP	F_9AD2

;-------

F_A110			LDAB	#$4C
			JSR	F_A121
			JSR	MUL_660
			LDX	#M7D33
			STX	M00A7
			JMP	F_9AD2

;-------

F_A120			CLRB

;-------	fallthrough

F_A121			LDX	#M6A67
			ABX
			XGDX
			ADDD	M0074
			XGDX
			LDAA	,X
			TAB
			RTS

;-------

HI_CALL_18		LDAB	SYS_TUNE
			ASLB
			EORB	#$80
			BMI	1F
			CLRA
			BRA	2F
1			LDAA	#$FF
2			ASLD
			STD	M0086
			RTS
			LDAB	#$60
			LDAA	#$FF
			CLC
			RORA
3			SEI
			OPZ_OUT_A
			CLI
			INCB
			CMPB	#$80
			BNE	3B
			RTS

;-------

F_A155			STAB	M0083
			PSHA
			JSR	F_A354
			PULA
			STAA	M0084
			CLRB
			STAB	M0085
1			LDX	#D_A350
			ABX
			LDAB	,X
			LDX	#OP_ENABLE
			ABX
			LDAA	,X
			ANDA	#$01
			BNE	2F
			LDAA	#$FF
			BRA	9F
2			LDX	#M7943
			LDAB	M0085
			LDAA	#$1D
			MUL
			ABX
			STX	M00DC
			LDAB	M0084
			LDAA	#$74
			MUL
			ADDD	M00DC
			XGDX
			PSHX
			LDX	#M791B
			LDAB	M0084
			ABX
			LDAB	,X
			ADDB	M0083
3			BLT	5F
4			CMPB	#$60
			BCS	6F
			SUBB	#$0C
			BRA	4B
5			ADDB	#$0C
			BRA	3B
6			LDX	#MA2F0
			ABX
			LDAB	,X
			SUBB	#$0E
			BCC	7F
			CLRB
7			CMPB	#$70
			BLS	8F
			LDAB	#$70
8			LSRB
			LSRB
			PULX
			ABX
			LDAA	,X
9			PSHA
			LDAA	#$08
			LDAB	M0085
			MUL
			ADDB	M0084
			STAB	M0080
			LDX	#M78D3
			ABX
			LDAB	M00F0
			LDAA	$20,X
			MUL
			ADDA	,X
			BCC	10F
			LDAA	#$FF
10			PULB
			ABA
			BCC	11F
			LDAA	#$FF
11			LDAB	M0080
			LDX	#M78A3
			ABX
			STAA	,X
			CMPA	#$FF
			BEQ	12F
			LDX	#M7873
			LDAB	M0080
			ABX
			ADDA	,X
			BCC	12F
			LDAA	#$FF
12			LSRA
			LDAB	#$60
			ADDB	M0080
			SEI
			OPZ_POLL
			OPZ_OUT_A
			CLI
			LDAB	M0085
			INCB
			STAB	M0085
			CMPB	#$04
			BEQ	13F
			JMP	1B
13			LDAA	M7772
			ANDA	#$04
			BEQ	14F
			TST	PFM_EDIT_ASSIGN
			BEQ	14F
			TIM	#%01000000,M0041
			BEQ	17F
			BRA	16F
14			LDAA	M0084
			JSR	F_9A07
			LDAA	$3F,X
			BEQ	15F
			LDAA	$41,X
			BNE	17F
15			LDX	#M793B
			LDAB	M0084
			ABX
			LDAB	,X
			BMI	17F
			LDX	#M0041
			ABX
			TIM	#%01000000,$00,X
			BEQ	17F
16			LDX	#M77C6
			LDAB	M0084
			ABX
			LDAA	,X
			CMPA	#$FF
			BEQ	17F
			LDX	#M7D03
			BRA	18F
17			LDX	#M7CF3
18			LDAB	M0084
			ASLB
			ABX
			LDD	,X
			STD	M00DC
			LDD	M0086
			PSHB
			LDX	#M78C3
			LDAB	M0084
			ASLB
			ABX
			PULB
			ADDD	,X
			BVC	20F
			BCS	19F
			LDD	#$7FFF
			BRA	20F
19			LDD	#$0000
20			LDX	#M77B6
			PSHB
			TST	>M0084
			BNE	21F
			LDAB	M7846
			ANDB	#$03
			CMPB	#$03
			BEQ	21F
			PULB
			BRA	23F
21			LDAB	M0084
			ASLB
			ABX
			PULB
			ADDD	,X
			BVC	23F
			BCS	22F
			LDD	#$7FFF
			BRA	23F
22			LDD	#$0000
23			ADDD	M00DC
24			BLT	26F
25			CMPA	#$60
			BCS	27F
			SUBA	#$0C
			BRA	25B
26			ADDA	#$0C
			BRA	24B
27			PSHB
			LDX	#MA2F0
			TAB
			ABX
			LDAA	,X
			PULB
			ANDB	#$FC
			STD	M0081
			LDAA	#$28
			ADDA	M0084
			LDAB	M0081
			SEI
			OPZ_POLL
			OPZ_OUT_B
			ADDA	#$08
			LDX	#M7933
			LDAB	M0084
			ABX
			LDAB	,X
			ANDB	#$01
			ORAB	M0082
			OPZ_POLL
			OPZ_OUT_B
			CLI
			RTS

MA2F0			FCB	$00,$01,$02,$04,$05,$06,$08,$09,$0A,$0C,$0D,$0E,$10
			FCB	$11,$12,$14,$15,$16,$18,$19,$1A,$1C,$1D,$1E,$20,$21
			FCB	$22,$24,$25,$26,$28,$29,$2A,$2C,$2D,$2E,$30,$31,$32
			FCB	$34,$35,$36,$38,$39,$3A,$3C,$3D,$3E,$40,$41,$42,$44
			FCB	$45,$46,$48,$49,$4A,$4C,$4D,$4E,$50,$51,$52,$54,$55
			FCB	$56,$58,$59,$5A,$5C,$5D,$5E,$60,$61,$62,$64,$65,$66
			FCB	$68,$69,$6A,$6C,$6D,$6E,$70,$71,$72,$74,$75,$76,$78
			FCB	$79,$7A,$7C,$7D,$7E

D_A350			FCB	$03,$01,$02,$00

;-------

F_A354			TAB
			LDX	#M7846
			ABX
			LDAB	,X
			ANDB	#$03
			BEQ	1F
			CMPB	#$03
			BCC	1F
			DECB
			LDX	#M7850
			ABX
			LDAB	,X
			BPL	2F
1			TAB
2			STAB	M0084
			ASLB
			LDX	#M780E
			ABX
			LDD	,X
			SUBD	#$1300
			BEQ	3F
			LDX	#M7796
			LDAB	M0084
			ASLB
			ABX
			PSHX
			LDX	#M77A6
			ABX
			LDD	#$0000
			STD	,X
			PULX
			STD	,X
3			RTS

;-------

F_A390			LDAB	#$07
			STAB	M0097
1			LDX	#M793B
			LDAB	M0097
			ABX
			LDAB	,X
			BPL	2F
			LDD	#$0000
			JMP	23F
2			LDX	#M7D83
			ABX
			LDAB	,X
			CMPB	#$80
			BNE	4F
3			LDD	#$0000
			BRA	11F
4			LSRB
			LDX	#MA4B8
			ABX
			LDAA	,X
			ASLA
			EORA	#$80
			STAA	M008C
			LDX	#M7923
			LDAB	M0097
			ABX
			LDAB	,X
			BEQ	3B
			LDAA	M008C
			CMPB	#$C2
			BNE	6F
			TSTA
			BMI	5F
			CMPA	#$7E
			BNE	6F
			LDD	#$0C00
			BRA	10F
5			NEGA
			LDAB	#$C0
			MUL
			COMA
			COMB
			INCB
			BCC	9F
			INCA
			BRA	9F
6			TSTA
			BMI	7F
			ASLA
			MUL
			BRA	8F
7			COMA
			ASLA
			MUL
			COMB
			COMA
8			LSRD
9			LSRD
			LSRD
			LSRD
10			TST	>M008C
			BPL	11F
			ORAA	#$F0
11			STD	M0089
			LDX	#M792B
			LDAB	M0097
			ABX
			LDAB	,X
			BNE	12F
			LDD	#$0000
			BRA	22F
12			STAB	M008D
			PSHB
			LDX	#M793B
			LDAB	M0097
			ABX
			LDAB	,X
			BPL	13F
			CLRA
			BRA	14F
13			LDX	#M7D5B
			ABX
			LDAA	,X
			BNE	14F
			PULB
			LDD	#$0000
			BRA	22F
14			PULB
			CMPB	#$32
			BEQ	15F
			CMPB	#$31
			BNE	16F
15			CMPA	#$FE
			BCS	17F
			LDD	#$C000
			BRA	21F
16			TSTB
			BMI	18F
17			BSR	F_A47E
			MUL
			BRA	21F
18			NEGB
			CMPB	#$31
			BCC	25F
19			BSR	F_A47E
			MUL
20			COMA
			COMB
			ADDD	#1
			BEQ	22F
21			LSRD
			LSRD
			TST	>M008D
			BPL	22F
			ORAA	#$C0
22			ADDD	M0089
23			PSHB
			LDX	#M78C3
			LDAB	M0097
			ASLB
			ABX
			PULB
			STD	,X
			DEC	>M0097
			BMI	24F
			JMP	1B
24			RTS
25			CMPA	#$FE
			BCS	19B
			LDD	#$C000
			BRA	20B

;-------

F_A47E			LDX	#MA485
			ABX
			LDAB	,X
			RTS

MA485			FCB	$00,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0A,$0B,$0C
			FCB	$0D,$0F,$11,$14,$17,$1A,$1C,$1F,$23,$27,$2A,$2E,$32
			FCB	$36,$3A,$3E,$43,$48,$4E,$52,$58,$5D,$62,$69,$6E,$75
			FCB	$7B,$81,$88,$8E,$95,$9C,$A4,$AB,$B3,$BB,$C2,$C2

MA4B8			FCB	$00,$01,$02,$03,$04,$05,$06,$07,$08,$09,$0A,$0B,$0C
			FCB	$0D,$0E,$0F,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19
			FCB	$1A,$1B,$1C,$1D,$1E,$1F,$20,$21,$22,$23,$24,$25,$26
			FCB	$27,$28,$2A,$2B,$2C,$2D,$2E,$2F,$30,$31,$32,$33,$34
			FCB	$35,$36,$37,$38,$39,$3A,$3B,$3C,$3D,$3E,$3F,$40,$40
			FCB	$40,$41,$42,$43,$44,$45,$46,$47,$48,$49,$4A,$4B,$4C
			FCB	$4D,$4E,$4F,$50,$51,$52,$53,$54,$55,$56,$58,$59,$5A
			FCB	$5B,$5C,$5D,$5E,$5F,$60,$61,$62,$63,$64,$65,$66,$67
			FCB	$68,$69,$6A,$6B,$6C,$6D,$6E,$6F,$70,$71,$72,$73,$74
			FCB	$75,$76,$77,$78,$79,$7A,$7B,$7C,$7D,$7E,$7F

;-------

F_A538			LDX	#M7D01
			LDAB	#$07
			STAB	M0097
1			PSHX
			LDAA	M7772
			ANDA	#$04
			BEQ	2F
			TST	PFM_EDIT_ASSIGN
			BEQ	2F
			TIM	#%01000000,M0041
			BNE	5F
			BRA	4F
2			LDAA	M0097
			JSR	F_9A07
			TST	$3F,X
			BEQ	3F
			TST	$41,X
			BNE	5F
3			LDX	#M793B
			LDAB	M0097
			ABX
			LDAB	,X
			BMI	4F
			LDX	#M0041
			ABX
			TIM	#%01000000,$00,X
			BNE	5F
4			PULX
			LDD	,X
			BRA	9F
5			PULX
			LDD	,X
			STD	M0098
			SUBD	$10,X
			BEQ	8F
			BPL	7F
			BSR	F_A59A
			BEQ	8F
			NEGA
			LSRA
			LSRA
			INCA
			MUL
			STD	M0095
			LDD	$10,X
			SUBD	M0095
			XGDX
			CPX	M0098
			XGDX
			BCC	9F
			BRA	8F

;------- fallthrough

F_A59A			PSHX
			LDX	#M77C6
			LDAB	M0097
			ABX
			LDAB	,X
			PULX
			CMPB	#$FF
			RTS
7			BSR	F_A59A
			BEQ	8F
			LSRA
			LSRA
			INCA
			MUL
			ADDD	$10,X
			XGDX
			CPX	M0098
			XGDX
			BCS	9F
8			LDD	M0098
9			STD	$10,X
			PSHX
			LDD	M0086
			PSHB
			LDX	#M78C3
			LDAB	M0097
			ASLB
			ABX
			PULB
			ADDD	,X
			LDX	#M77B6
			PSHB
			TST	>M0097
			BNE	10F
			LDAB	M7846
			ANDB	#$03
			CMPB	#$03
			BEQ	10F
			PULB
			BRA	12F
10			LDAB	M0097
			ASLB
			ABX
			PULB
			ADDD	,X
			BVC	12F
			BCS	11F
			LDD	#$7FFF
			BRA	12F
11			LDD	#$0000
12			PULX
			ADDD	$10,X
13			BLT	15F
14			CMPA	#$60
			BCS	16F
			SUBA	#$0C
			BRA	14B
15			ADDA	#$0C
			BRA	13B
16			PSHB
			PSHX
			LDX	#MA2F0
			TAB
			ABX
			LDAA	,X
			PULX
			PULB
			ANDB	#$FC
			STD	M0081
			LDAA	#$28
			ADDA	M0097
			LDAB	M0081
			SEI
			SPIN3
			OPZ_OUT_B
			ADDA	#$08
			PSHX
			LDX	#M7933
			LDAB	M0097
			ABX
			LDAB	,X
			PULX
			ANDB	#$01
			ORAB	M0082
			OPZ_POLL
			OPZ_OUT_B
			CLI
			DEX
			DEX
			DEC	>M0097
			BMI	17F
			JMP	1B
17			RTS

;-------

F_A64D			CLR	>M0097
1			LDAB	M0097
			ASLB
			LDX	#M7796
			ABX
			PSHX
			LDX	#M780E
			ABX
			LDD	,X
			PULX
			ADDD	,X
			BCC	2F
			LDD	#$FFFF
2			STD	,X
			ADDD	#1
			BNE	4F
			LDAB	M0097
			ASLB
			LDX	#M77A6
			ABX
			PSHX
			LDX	#M780E
			ABX
			LDD	,X
			PULX
			ADDD	,X
			BCC	3F
			LDD	#$FFFF
3			STD	,X
4			INC	>M0097
			LDAA	M0097
			CMPA	#$08
			BNE	1B
			RTS

;-------

F_A68F			CLR	>M0097
			TST	>M0091
			BEQ	1F
			LDAA	#$04
			STAA	M0097
1			LDX	#M7D1B
			LDAB	M0097
			ABX
			LDAA	$18,X
			PSHX
			LDX	#M793B
			LDAB	M0097
			ABX
			LDAB	,X
			BPL	2F
			PULX
			JMP	9F
2			STAB	M0093
			LDX	#M7D5B
			ABX
			STX	M0089
			LDAB	,X
			PULX
			MUL
			STAA	M00F4
			LDAA	$18,X
			SUBA	M00F4
			STAA	$08,X
			LDAA	,X
			PSHX
			LDX	M0089
			LDAB	$08,X
			PULX
			MUL
			STAA	$10,X
			LDAA	,X
			SUBA	$10,X
			PSHX
			LDX	M0089
			ADDA	$10,X
			PULX
			BCC	3F
			LDAA	#$FF
3			COMA
			TAB
			PSHX
			LDX	#MA82B
			ABX
			LDAA	,X
			LDAB	M776D
			COMB
			LDX	#MA82B
			ABX
			ADDA	,X
			BCC	4F
			LDAA	#$FF
			BRA	5F
4			LDAB	M776B
			ANDB	#$02
			BEQ	5F
			LDX	#M7753
			LDAB	M0093
			ABX
			LDAB	,X
			COMB
			LDX	#MA82B
			ABX
			ADDA	,X
			BCC	5F
			LDAA	#$FF
5			PULX
			STAA	$10,X
			LDAB	$08,X
			COMB
			LDX	#MA82B
			ABX
			TAB
			CLRA
			ADDB	,X
			ROLA
			XGDX
			STX	M0093
			LDX	#M7893
			LDAB	M0097
			ASLB
			ABX
			LDD	,X
			PSHA
			PSHB
			LDD	M0093
			STD	,X
			PULB
			PULA
			SUBD	M0093
			BEQ	9F
			BCC	6F
			COMA
			COMB
			ADDD	#1
6			XGDX
			CPX	#$0020
			BCS	7F
			CLRA
			BRA	8F
7			XGDX
			LDX	#MA92B
			ABX
			LDAA	,X
8			LDAB	M0097
			SEI
			OPZ_OUT_A
			CLI
9			INC	>M0097
			LDAB	M0097
			ANDB	#$03
			BEQ	10F
			JMP	1B
10			LDAB	#$03
			STAB	M0088
			STAB	M0097
			TST	>M0091
			BNE	11F
			COM	>M0091
			CLR	>M0092
			BRA	12F
11			CLR	>M0091
			LDAB	#$04
			STAB	M0092
12			LDAB	M0088
			ASLB
			ASLB
			ASLB
			ADDB	M0097
			ADDB	M0092
			STAB	M0090
			LDX	#M7853
			LDAB	M0090
			ABX
			LDAA	,X
			LDX	#M7D23
			LDAB	M0097
			ADDB	M0092
			ABX
			LDAB	,X
			MUL
			COMA
			LDX	#MA82B
			TAB
			ABX
			LDAA	,X
			LDX	#M7913
			LDAB	M0097
			ADDB	M0092
			ABX
			LDAB	,X
			ANDB	#$07
			SUBB	#$04
			BCS	14F
			BEQ	15F
			CMPB	#$03
			BCS	16F
			BRA	17F
13			BRA	12B
14			LDAB	M0088
			CMPB	#$03
			BNE	18F
			BRA	17F
15			TIM	#%00000010,M0088
			BEQ	18F
			BRA	17F
16			TST	>M0088
			BEQ	18F
17			LDX	#M7D2B
			LDAB	M0097
			ADDB	M0092
			ABX
			ADDA	,X
			BCC	18F
			LDAA	#$FF
18			LDX	#M7873
			LDAB	M0090
			ABX
			STAA	,X
			LDX	#M78A3
			LDAB	M0090
			ABX
			ADDB	#$60
			PSHA
			ADDA	,X
			BCC	19F
			LDAA	#$FF
19			PSHA
			LDAA	M776B
			ANDA	#$02
			PULA
			BEQ	20F
			TST	M7767
			BEQ	20F
			CLC
			BRA	21F
20			SEC
21			RORA
			SEI
			OPZ_OUT_A
			CLI
			PULA
			DEX
			DEC	>M0097
			BPL	13B
			LDAB	#$03
			STAB	M0097
			DEC	>M0088
			BPL	13B
			RTS

MA82B			FCB	$FF,$FF,$E0,$CD,$C0,$B5,$AD,$A6,$A0,$9A,$95,$91,$8D
			FCB	$89,$86,$82,$80,$7D,$7A,$78,$75,$73,$71,$6F,$6D,$6B
			FCB	$69,$67,$66,$64,$62,$61,$60,$5E,$5D,$5B,$5A,$59,$58
			FCB	$56,$55,$54,$53,$52,$51,$50,$4F,$4E,$4D,$4C,$4B,$4A
			FCB	$49,$48,$47,$46,$46,$45,$44,$43,$42,$42,$41,$40,$40
			FCB	$3F,$3E,$3D,$3D,$3C,$3B,$3B,$3A,$39,$39,$38,$38,$37
			FCB	$36,$36,$35,$35,$34,$33,$33,$32,$32,$31,$31,$30,$30
			FCB	$2F,$2F,$2E,$2E,$2D,$2D,$2C,$2C,$2B,$2B,$2A,$2A,$2A
			FCB	$29,$29,$28,$28,$27,$27,$26,$26,$26,$25,$25,$24,$24
			FCB	$24,$23,$23,$22,$22,$22,$21,$21,$21,$20,$20,$20,$1F
			FCB	$1F,$1E,$1E,$1E,$1D,$1D,$1D,$1C,$1C,$1C,$1B,$1B,$1B
			FCB	$1A,$1A,$1A,$19,$19,$19,$18,$18,$18,$18,$17,$17,$17
			FCB	$16,$16,$16,$15,$15,$15,$15,$14,$14,$14,$13,$13,$13
			FCB	$13,$12,$12,$12,$12,$11,$11,$11,$11,$10,$10,$10,$10
			FCB	$0F,$0F,$0F,$0F,$0E,$0E,$0E,$0E,$0D,$0D,$0D,$0D,$0C
			FCB	$0C,$0C,$0C,$0B,$0B,$0B,$0B,$0A,$0A,$0A,$0A,$09,$09
			FCB	$09,$09,$08,$08,$08,$08,$08,$07,$07,$07,$07,$06,$06
			FCB	$06,$06,$06,$05,$05,$05,$05,$05,$04,$04,$04,$04,$04
			FCB	$03,$03,$03,$03,$03,$02,$02,$02,$02,$02,$02,$01,$01
			FCB	$01,$01,$01,$00,$00,$00,$00,$00,$00

MA92B			FCB	$30,$30,$30,$20,$1C,$1B,$1A,$19,$18,$17,$16,$15,$14
			FCB	$13,$12,$11,$10,$0F,$0E,$0D,$0C,$09,$09,$09,$09,$08
			FCB	$08,$08,$08,$06,$04,$02

;-------

F_A94B			TST	>M0091
			BNE	1F
			CLRB
			BRA	2F
1			LDAB	#$01
2			STAB	M0097
			LDX	#M7D15
			LDAB	M0097
			ABX
			LDAA	,X
			LDAB	M7850
			BEQ	4F
			CMPB	#$FF
			BEQ	4F
			TST	>M0097
			BNE	3F
			LDAB	M784F
			BRA	6F
3			LDAB	M784E
			BRA	6F
4			TST	>M0097
			BNE	5F
			LDAB	M784E
			BRA	6F
5			LDAB	M784F
6			LDX	#M7D53
			ABX
			STAB	M0089
			LDAB	,X
			MUL
			STAA	M00F2
			LDX	#M7D17
			LDAB	M0097
			ABX
			LDAA	,X
			LDX	#M7D5B
			LDAB	M0089
			ABX
			LDAB	,X
			MUL
			STAA	M00F3
			LDX	#M7D19
			LDAB	M0097
			ABX
			LDAA	,X
			LDX	#M7D63
			LDAB	M0089
			ABX
			LDAB	,X
			MUL
			STAA	M00F5
			LDAA	M00F2
			ADDA	M00F3
			BCS	7F
			ADDA	M00F5
			BCC	8F
7			LDAA	#$FF
8			PSHA
			LDX	#M7D13
			LDAB	M0097
			ABX
			LDAA	,X
			LDX	#M7850
			LDAB	M0097
			ABX
			LDAB	,X
			BMI	9F
			LDX	#M77A6
			ABX
			LDAB	,X
			BRA	10F
9			CLRB
10			MUL
			PULB
			ABA
			BCC	11F
			LDAA	#$FF
11			TAB
			COMB
			LDX	#MA82B
			ABX
			LDAA	,X
			LDX	#M7850
			LDAB	M0097
			ABX
			LDAB	,X
			BMI	13F
			LDX	#M7873
			ABX
			ADDA	,X
			BCC	12F
			LDAA	#$FF
12			SUBA	,X
13			LSRA
			TST	>M0097
			BNE	14F
			LDAB	#$19
			BRA	15F
14			LDAB	#$17
15			SEI
			OPZ_OUT_A
			CLI
			RTS

;-------

F_AA1A			TST	>M0091
			BNE	1F
			CLR	>M0092
			BRA	2F
1			LDAB	#$04
			STAB	M0092
2			CLR	>M0097
3			LDX	#M793B
			LDAB	M0097
			ADDB	M0092
			ABX
			LDAB	,X
			BMI	6F
			LDX	#M7D53
			ABX
			STX	M0089
			LDX	#M7D3B
			LDAB	M0097
			ADDB	M0092
			ABX
			LDAA	,X
			PSHX
			LDX	M0089
			LDAB	,X
			PULX
			MUL
			STAA	$38,X
			LDAA	$10,X
			PSHX
			LDX	M0089
			LDAB	$10,X
			PULX
			MUL
			PSHA
			LDAA	$08,X
			PSHX
			LDX	M0089
			LDAB	$08,X
			PULX
			MUL
			PULB
			ABA
			BCS	4F
			ADDA	$38,X
			BCC	5F
4			LDAA	#$FF
5			STAA	$38,X
6			INC	>M0097
			LDAB	M0097
			CMPB	#$04
			BNE	3B
			TST	>M0091
			BNE	7F
			CLR	>M0097
			BRA	8F
7			LDAB	#$01
			STAB	M0097
8			LDX	#M7D7B
			TST	>M0097
			BNE	9F
			LDAB	M7850
			BRA	10F
9			LDAB	M7851
10			BPL	11F
			CLRA
			BRA	16F
11			ABX
			LDAA	,X
			LDX	#M77A6
			ASLB
			ABX
			LDAB	,X
			MUL
			LDAB	M7850
			BEQ	13F
			CMPB	#$FF
			BEQ	13F
			TST	>M0097
			BNE	12F
			LDAB	M784F
			BRA	15F
12			LDAB	M784E
			BRA	15F
13			TST	>M0097
			BNE	14F
			LDAB	M784E
			BRA	15F
14			LDAB	M784F
15			BMI	16F
			LDX	#M7EF1
			ABX
			LDAB	,X
			LDX	#M7D73
			ABX
			ADDA	,X
			BCC	16F
			LDAA	#$FF
16			LSRA
			ORAA	#$80
			TST	>M0097
			BNE	17F
			LDAB	#$19
			BRA	18F
17			LDAB	#$17
18			SEI
			OPZ_OUT_A
			CLI
			RTS

;-------

F_AAF7			CLR	>M0097
1			LDAB	M0097
			BEQ	2F
			LDX	#M7846
			ABX
			LDAA	,X
			ANDA	#$03
			CMPA	#$03
			BNE	11F
2			LDX	#M7836
			ASLB
			ABX
			PSHX
			LDD	,X
			LDX	#M781E
			PSHB
			LDAB	M0097
			ASLB
			ABX
			PULB
			ADDD	,X
			PULX
			STD	,X
			ASLD
			BCC	3F
			COMA
3			TST	>M0097
			BNE	4F
			STAA	M776A
4			ADDA	#$80
			PSHA
			LDX	#M7D73
			LDAB	M0097
			ABX
			LDAA	$08,X
			ADDA	,X
			BEQ	10F
			BCC	5F
			LDAA	#$FF
5			LDX	#M77A6
			LDAB	M0097
			ASLB
			ABX
			LDAB	,X
			MUL
			TAB
			PULA
			TSTA
			BMI	6F
			MUL
			BRA	7F
6			NEGA
			MUL
			COMA
			COMB
			ADDD	#1
7			TAB
			BMI	8F
			CLRA
			BRA	9F
8			LDAA	#$FF
9			LDX	#M77B6
			PSHB
			LDAB	M0097
			ASLB
			ABX
			PULB
			ASLD
			STD	,X
			LDAA	M0097
			INCA
			STAA	M0097
			CMPA	#$08
			BNE	1B
			RTS
10			PULA
11			LDD	#$0000
			BRA	9B

;-------

			INCLUDE	"inc/jmpoff.asm"

;-------

F_AB9E			CMPB	#$0D
			BEQ	4F
			CMPB	#$0E
			BEQ	4F
			LDAA	#$01
			STAA	M009A
			LDAA	M776D
			LSRA
			CMPB	#$0B
			BEQ	1F
			CMPA	#$7F
			BEQ	2F
			INCA
			BRA	2F
1			TSTA
			BEQ	2F
			DECA
2			ASLA
			STAA	M776D
3			RTS
4			CLR	>M009A
			BRA	3B

;-------

F_ABC7			TST	>M00AE
			BNE	2F
			LDAB	M7772
			ANDB	#$04
			BNE	1F
			TST	VOICE_COMPARE
			BNE	2F
1			CLR	>M006E
			BRA	6F
2			LDAB	M7772
			ANDB	#$03
			LDAA	M006E
			INCA
			ANDA	#$3F
			STAA	M006E
			BEQ	4F
			CMPA	#$20
			BNE	6F
			TST	>M00AE
			BNE	7F
			TSTB
			BEQ	3F
			CMPB	#$01
			BNE	6F
			AIM	#~LED3,PORT6
			BRA	6F
3			AIM	#~LED4,PORT6
			BRA	6F
4			TST	>M00AE
			BNE	8F
			TSTB
			BEQ	5F
			CMPB	#$01
			BNE	6F
			OIM	#LED3,PORT6
			BRA	6F
5			OIM	#LED4,PORT6
6			RTS
7			CMPB	#$02
			BNE	6B
			AIM	#~LED2,PORT6
			BRA	6B
8			CMPB	#$02
			BNE	6B
			OIM	#LED2,PORT6
			DEC	>M00AE
			BRA	6B

;-------

C_AC2F			JSR	JMPOFF1
			FCB	C_AC48 - *		; B = 0
			FCB	$01
			FCB	C_AC45 - *		; B = 1 .. 3
			FCB	$04
			FCB	C_AC41 - *		; B = 4 .. 5
			FCB	$06
			FCB	C_AC3C - *		; B = 6 .. 10
			FCB	$0B
			FCB	C_AC48 - *		; default
			FCB	$00

C_AC3C			COMB				; B = 6 .. 10
			SUBB	#$F0			;  -> 9 .. 5
			BRA	C_AC48

C_AC41			SUBB	#$03			; B = 4 .. 5
			BRA	C_AC48			;  -> 1 .. 2

C_AC45			COMB				; B = 1 .. 3
			SUBB	#$F2			; -> 12 .. 10

C_AC48			TST	>M00A3			;
			BEQ	1F
			CMPB	M00A0
			BEQ	1F
			CMPB	#$0D
			BCC	2F
			CLRB
			BRA	2F
1			STAB	M00A0
2			CLR	>M00A1
			CLR	>M00A2
			CLR	>M00A3
			RTS

;-------

READ_SWITCHES		LDAA	PORT2			; read all of port 2 (pressed = low)
			COMA				; flip the bits (pressed = high)
			ANDA	#SW3|SW2|SW1		; mask the required bits (321_____)
			LSRA				; shift right (_321____)
			LSRA				; shift right (__321___)
			LSRA				; shift right (___321__)
			LSRA				; shift right (____321_)
			LSRA				; shift right (_____321)
			STAA	SWITCH_LO_N		; and save
			LDAA	PORT5			; read all of port 5 (pressed = low)
			COMA				; invert the bits (pressed = high)
			ANDA	#SW7|SW6|SW5|SW4|SW11	; mask the required bits (7654__B_)
			LSRA				; shift right (_7654__B)
			CLR	>SWITCH_HI_N		; get ready to save
			LSRA				; shift right (__7654__) - SW11 -> C
			BCC	1F			; if not pressed skip
			OIM	#%00000100,SWITCH_HI_N	; save SW11
1			ASLA				; shift left (07654___)
			ORAA	SWITCH_LO_N		; combine    (07654321)
			STAA	SWITCH_LO_N		; and save
			LDAA	PORT6			; read switches 8 - 10
			COMA				; flip the bits (pressed = high)
			ANDA	#SW10|SW9|SW8		; mask the required bits (_____A98)
			LSRA				; shift right (______A9) - SW8 -> C
			BCC	2F			; if not pressed skip
			OIM	#%10000000,SWITCH_LO_N	; save SW8
2			ORAA	SWITCH_HI_N		; combine with SW11 (_____BA9)
			STAA	SWITCH_HI_N		; and save

			CLRB				; B <- 0
			LDX	#SWITCH_LO		; offset to state
			LDAA	SWITCH_LO_N		; get current low switches
			CMPA	,X			; compare to low state
			BNE	3F			; different?  branch
			INX				; inc offset (point to SWITCH_HI)
			INCB				; B <- 1
			LDAA	SWITCH_HI_N		; A <- current high switches
			CMPA	,X			; compare to high state
			BNE	3F			; different? branch
			JMP	10F			; switches match - branch

3			CMPB	#$01			; check which byte was different
			BNE	4F			; low byte?  branch
			PSHA				; save A
			EORA	,X			; generate differences
			ANDA	#$04			; mask off bit 2 (SW11 - Store/Copy)
			PULA				; restore A (no flags change)
			BEQ	4F			; no difference?  branch
			STAA	,X			; save (non-EOR'd value) to high state
			LDAB	#$03			; B <- 3
			BITA	#$04			; test bit 2 again (SW11)
			BNE	C_AC48			; set?  branch
			INCB				; B <- 4
			BRA	C_AC48			; branch

4			ASLB				; B <- B * 8
			ASLB				; -
			ASLB				; -
			PSHB				; and save
			EORA	,X
			BEQ	10F
			BITA	,X
			BNE	7F
			CLR	>M0071
5			INC	>M0071
			LSRA
			BCC	5B
			PULB
			ADDB	M0071
			CLRA
			SEC
6			ROLA
			DEC	>M0071
			BNE	6B
			ORAA	,X
			STAA	,X
			JMP	C_AC2F
7			ANDA	,X
			TAB
			EORA	,X
			STAA	,X
			PULA
			TSTA
			BNE	10F
			ANDB	#$06
			BEQ	10F
			CMPB	#$06
			BEQ	9F
			BITB	#$02
			BEQ	8F
			LDAB	#$0D
			JMP	C_AC48
8			LDAB	#$0E
			JMP	C_AC48
9			AIM	#%11111011,$00,X
			BRA	8B

10			LDAB	M00A0
			JSR	JMPOFF1
			FCB	C_AD20 - *		; B = 0
			FCB	$01
			FCB	C_AD24 - *		; B = 1 .. 2
			FCB	$03
			FCB	C_AD20 - *		; B = 3 .. 7
			FCB	$08
			FCB	C_ADEF - *		; B = 8 .. 9
			FCB	$0A
			FCB	11F - *			; B = 10, 11
			FCB	$0C
			FCB	C_AD20 - *		; default
			FCB	$00

11			JMP	C_AE50

							; B = 3 .. 7
C_AD20			CLRB				; B <- 0
			JMP	C_AC48

C_AD24			TBA
			LDAB	M7772
			CMPB	#$02
			BEQ	14F
			CMPB	#$06
			BNE	15F
14			JMP	C_ADB6
15			CMPB	#$09
			BCS	16F
			CMPB	#$12
			BCS	C_ADB6
16			LDAB	M7774

			JSR	JMPOFF1
			FCB	C_ADB6 - *
			FCB	$02
			FCB	C_AD75 - *
			FCB	$05
			FCB	C_ADB6 - *
			FCB	$07
			FCB	C_AD75 - *
			FCB	$08
			FCB	C_ADB6 - *
			FCB	$09
			FCB	C_AD75 - *
			FCB	$0B
			FCB	17F - *
			FCB	$14
			FCB	C_ADB6 - *
			FCB	$15
			FCB	C_AD83 - *
			FCB	$16
			FCB	17F - *
			FCB	$19
			FCB	C_AD75 - *
			FCB	$1B
			FCB	C_AD67 - *
			FCB	$1C
			FCB	C_ADAA - *
			FCB	$1D
			FCB	17F - *
			FCB	$1F
			FCB	C_ADB6 - *
			FCB	$20
			FCB	17F - *
			FCB	$28
			FCB	C_ADB6 - *
			FCB	$36
			FCB	17F - *
			FCB	$00

17			BRA	C_AD20

C_AD67			LDAB	M7788
			CMPB	#$02
			BNE	17B
			TST	>M00A4
			BNE	17B
			BRA	C_ADB6

C_AD75			LDAB	M7788
			CMPB	#$01
			BNE	17B
			TST	>M00A4
			BNE	17B
			BRA	C_ADB6

C_AD83			LDAB	M7788
			CMPB	#$01
			BEQ	21F
			CMPB	#$02
			BNE	17B
			TST	>M00A4
			BNE	17B
			LDAB	M7789
			CMPB	#$0C
			BNE	17B
			BRA	C_ADB6
21			TST	>M00A4
			BNE	17B
			LDAB	M7789
			CMPB	#$08
			BCS	C_ADB6
			BRA	17B

C_ADAA			LDAB	M7788
			CMPB	#$02
			BNE	17B
			TST	>M00A4
			BNE	17B
C_ADB6			CMPA	#$02
			BEQ	27F
			TIM	#%00001000,SWITCH_LO	; test SW4 (INC)
			BEQ	17B
			LDAB	#$01
24			LDX	M00A1
			INX
			STX	M00A1
			TST	>M00A3
			BNE	28F
			CPX	#$0100
			BCC	25F
			JMP	42F
25			LDAA	#$01
			STAA	M00A3
26			CLR	>M00A1
			CLR	>M00A2
			RTS
27			TIM	#%00010000,SWITCH_LO	; test SW5 (DEC)
			BEQ	17B
			LDAB	#$02
			BRA	24B
28			CPX	#$0002
			BCC	26B
			JMP	42F

C_ADEF			TST	>M00A4
			BNE	37F
			CMPB	#$09
			BEQ	29F
			TIM	#%01000000,SWITCH_LO	; test SW7 (PARAM-)
			BEQ	37F
			LDAB	#$08
			BRA	30F
29			TIM	#%00100000,SWITCH_LO	; test SW6 (PARAM+)
			BEQ	37F
			LDAB	#$09
30			LDAA	M7772
			BNE	32F
			LDAA	M7788
			CMPA	#$02
			BNE	32F
			LDAA	M7774
			CMPA	#$15
			BNE	31F
			LDAA	M7789
			CMPA	#$0C
			BNE	32F
			BRA	24B
31			CMPA	#$1C
			BNE	32F
			LDAA	M7789
			CMPA	#$02
			BEQ	24B
32			LDX	M00A1
			INX
			STX	M00A1
			TST	>M00A3
			BNE	34F
			CPX	#$0100
			BCS	42F
			LDAA	#$01
			STAA	M00A3
33			CLR	>M00A1
			CLR	>M00A2
			RTS
34			CPX	#M0045
			BCS	42F
			BRA	33B

C_AE50			CMPB	#$0B
			BEQ	36F
			TIM	#%00000100,SWITCH_LO	; test SW3 (volume down)
			BEQ	37F
			LDAB	#$0A
			BRA	39F
36			TIM	#%00000010,SWITCH_LO	; test SW2 (volume up)
			BNE	38F
37			JMP	17B
38			LDAB	#$0B
39			LDX	M00A1
			INX
			STX	M00A1
			TST	>M00A3
			BNE	41F
			CPX	#$0100
			BCS	42F
			LDAA	#$01
			STAA	M00A3
40			CLR	>M00A1
			CLR	>M00A2
			RTS
41			CPX	#$0004
			BCS	42F
			BRA	40B
42			CLRB
			RTS

;-------
;
; Copy B bytes from @($A9) to @(X)
;
MEMCPY_xB_A9_X		STX	M00A7

;-------	fallthrough
;
; Copy B bytes from @($A9) to @($A7)
;
MEMCPY_xB_A9_A7
0			LDX	M00A9
			LDAA	,X
			INX
			STX	M00A9
			LDX	M00A7
			STAA	,X
			INX
			STX	M00A7
			DECB
			BNE	0B
			RTS

;-------

LO_CALL_06		STX	M00A7
			LDAB	#$06
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

LO_CALL_00		STX	M00A7
			CLRB
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

LO_CALL_08		LDAB	#$08
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

LO_CALL_0A		LDAB	#$0A
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

LO_CALL_09		LDAB	#$09
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

LO_CALL_07		STX	M00A7
			LDAB	#$07
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

F_AED3			STX	M00A7
			LDAB	#$05
			STAB	XROM
			JSR	XROM_CALL
			RTS

;-------

F_AEDD			LDAB	M7773

;-------	fallthrough

F_AEE0			CMPB	#$A0
			BCC	2F
			CMPB	#$20
			BCC	4F
			LDAA	#$4E
			MUL
			ADDD	#USER_VOICE
1			XGDX
			BRA	3F
2			LDX	#INIT_VOICE
3			RTS
4			SUBB	#$20
			LDAA	#$4E
			MUL
			ADDD	#$D1C0
			BRA	1B

;-------

F_AEFF			LDAB	M7779
			CMPB	#$18
			BCC	1F
			LDAA	#$4C
			MUL
			ADDD	#USER_PFM
			XGDX
			BRA	2F
1			LDX	#D_PFM_SINGLE
2			RTS

D_PFM_SINGLE		FCB	$68,$00,$20,$00,$7F,$07,$18,$63
			FCB	$60,$00,$41,$00,$7F,$07,$18,$63
			FCB	$60,$00,$62,$00,$7F,$07,$18,$63
			FCB	$60,$00,$63,$00,$7F,$07,$18,$63
			FCB	$60,$00,$64,$00,$7F,$07,$18,$63
			FCB	$60,$00,$65,$00,$7F,$07,$18,$63
			FCB	$60,$00,$66,$00,$7F,$07,$18,$63
			FCB	$60,$00,$67,$00,$7F,$07,$18,$63
			FCB	$00,$00
			FCC	"SINGLE    "

;-------

F_AF5F			LDAB	M777B

;-------	fallthrough

F_AF62			LDAA	#$0D

;-------	fallthrough

F_AF64			LDX	#D_A350
			ABX
			LDAB	,X
			MUL
			BSR	F_AF6F
			ABX
			RTS

;-------

F_AF6F			XGDX
			LDAB	M778B
			LDAA	#110
			MUL
			ADDD	#M6A67
			XGDX
			RTS

;-------

F_AF7B			LDAA	M7772
			ANDA	#$07
			BEQ	2F
			CMPA	#$03
			BEQ	2F
			BCS	1F
			CMPA	#$07
			BEQ	2F
			DECA
1			ADDB	#$05
			DECA
			BNE	1B
2			CMPB	#$1E
			BCS	3F
			CLRB
3			CLR	>M00AE

			JSR	JMPOFFB
			FCB	17F - *
			FCB	C_B00C - *
			FCB	14F - *
			FCB	F_B082 - *
			FCB	F_B09A - *
			FCB	C_AFE0 - *
			FCB	C_B00C - *
			FCB	C_B066 - *
			FCB	C_B016 - *
			FCB	C_B09E - *
			FCB	C_AFF0 - *
			FCB	C_B00C - *
			FCB	C_B06E - *
			FCB	F_B084 - *
			FCB	12F - *
			FCB	17F - *
			FCB	C_B00C - *
			FCB	14F - *
			FCB	8F - *
			FCB	6F - *
			FCB	17F - *
			FCB	C_B00C - *
			FCB	10F - *
			FCB	5F - *
			FCB	7F - *
			FCB	4F - *
			FCB	C_B00C - *
			FCB	11F - *
			FCB	9F - *
			FCB	F_AFD9 - *

4			JMP	ZB127
5			JMP	ZB1AE
6			JMP	F_B164
7			JMP	ZB168
8			JMP	HI_CALL_14
9			JMP	ZB14E
10			JMP	ZB133
11			JMP	ZB136
12			JSR	F_C94D
			JMP	ZB179

F_AFD9			JSR	F_C94D
			JMP	ZB0C0
14			RTS

C_AFE0			TST	VOICE_COMPARE
			BNE	19F
			LDAA	M777B
			STAA	M777C
			CLR	>M0059
			BRA	17F
C_AFF0			LDAA	M7773
			STAA	M777F
			CLR	>M00A5
17			LDAA	SYS_MLOCK
			ANDA	#$01
			INCA
			ASLA
			ASLA
			ASLA
			ORAA	M7772
			STAA	M7772
18			JSR	F_E10E
19			RTS

C_B00C			LDAA	#$07
			ANDA	M7772
			STAA	M7772
			BRA	18B

C_B016			LDAA	VOICE_EDITED
			BEQ	14B
			TST	VOICE_COMPARE
			BNE	23F
			LDAA	#$07
			ANDA	M7772
			STAA	M7772
			LDAA	#$01
			STAA	VOICE_COMPARE
			JSR	F_E10E
			TST	SYS_CMBIN
			BNE	22F
			LDAB	#$01
			STAB	SYS_CMBIN
			JSR	F_B774
			CLR	SYS_CMBIN
			BRA	19B
22			JMP	F_B774
23			CLR	VOICE_COMPARE
			JSR	F_E10E
			TST	SYS_CMBIN
			BNE	24F
			LDAB	#$01
			STAB	SYS_CMBIN
			JSR	F_C2BC
			CLR	SYS_CMBIN
			BRA	25F
24			JSR	F_C2BC
25			LDX	M7781
			JMP	F_E10C

C_B066			TST	VOICE_COMPARE
			BNE	ZB0BF
			JSR	F_B115

C_B06E			CLR	M7772
			LDAA	#$FF
			STAA	M7790
			CLR	>M009A
			JSR	F_E10E
			LDAB	M7775
			JMP	F_B1DD

F_B082			BSR	F_B0EA
F_B084			LDAA	#$01
			STAA	M7772
			LDAA	#$FF
			STAA	M7790
			CLR	>M009A
			JSR	F_E10E
			LDAB	M7776
			JMP	F_B1DD

F_B09A			BSR	F_B0EA
			BRA	ZB0A5

C_B09E			TST	VOICE_COMPARE
			BNE	ZB0BF
			BSR	F_B115
ZB0A5			LDAA	#$02
			STAA	M7772
			CLR	M778C
			CLR	M7790
			LDD	#$0101
			STD	OP_ENABLE
			STD	OP_ENABLE + 2
			JSR	F_E10F
			JSR	F_E10E
ZB0BF			RTS
ZB0C0			LDAA	#$02
			STAA	M7772
			CLR	M778C
			CLR	M7790
			JSR	F_E10E
			LDX	#M69C1
			TST	SYS_CMBIN
			BNE	ZB0E3
			LDAB	#$01
			STAB	SYS_CMBIN
			JSR	F_B7A2
			CLR	SYS_CMBIN
			BRA	ZB0E6
ZB0E3			JSR	F_B7A2
ZB0E6			JSR	F_C7C2
			RTS

F_B0EA			LDAA	M7774
			CMPA	#$1F
			BCC	ZB0F5
			CMPA	#$14
			BCC	ZB0F7
ZB0F5			LDAA	#$14
ZB0F7			STAA	M7775
			CLR	>M00A6
			CLR	M7788
			CLR	M778C
			CMPA	#$19
			BCS	ZB114
			CMPA	#$1C
			BCC	ZB114
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE
ZB114			RTS

F_B115			LDAA	M7774
			CMPA	#$0B
			BCS	ZB11D
			CLRA
ZB11D			STAA	M7776
			CLR	M7788
			CLR	M778C
			RTS
ZB127			LDAA	M7779
			STAA	M777A
			CLR	>M00A5
			JMP	17B
ZB133			JSR	F_B1C6
ZB136			LDAA	#$04
			STAA	M7772
			LDAA	#$FF
			STAA	M7790
			CLR	>M009A
			JSR	F_E10E
			LDAB	M7777
			JMP	F_B1DD
HI_CALL_14		BSR	F_B1AF
ZB14E			LDAA	#$05
			STAA	M7772
			LDAA	#$FF
			STAA	M7790
			CLR	>M009A
			JSR	F_E10E
			LDAB	M7778
			JMP	F_B1DD

F_B164			BSR	F_B1AF
			BRA	ZB16A
ZB168			BSR	F_B1C6
ZB16A			LDAA	#$06
			STAA	M7772
			CLR	M778C
			CLR	M7790
			JSR	F_E10E
			RTS
ZB179			LDAA	#$06
			STAA	M7772
			CLR	M778C
			CLR	M7790
			JSR	F_E10E
			LDX	#M6A67
			STX	M00A9
			LDX	#M69C1
			JSR	LO_CALL_06
			TST	SYS_CMBIN
			BNE	ZB1A4
			LDAB	#$01
			STAB	SYS_CMBIN
			JSR	F_B805
			CLR	SYS_CMBIN
			BRA	ZB1A7
ZB1A4			JSR	F_B805
ZB1A7			JSR	SEND_SYSEX_PCED
			JSR	F_C7C2
			RTS
ZB1AE			RTS

F_B1AF			LDAA	M7774
			CMPA	#$3F
			BCC	ZB1BA
			CMPA	#$3C
			BCC	ZB1BC
ZB1BA			LDAA	#$3C
ZB1BC			STAA	M7777
			CLR	M7788
			CLR	M778C
			RTS

F_B1C6			LDAA	M7774
			CMPA	#$36
			BCC	ZB1D1
			CMPA	#$28
			BCC	ZB1D3
ZB1D1			LDAA	#$28
ZB1D3			STAA	M7778
			CLR	M7788
			CLR	M778C
			RTS

F_B1DD			PSHB
			JSR	F_B6BB
			PULB
			LDAA	#$01
			STAA	M7787
			TST	M7788
			BEQ	ZB1EF
			JMP	ZB339
ZB1EF			TBA

			JSR	JMPOFF1
			FCB	JB227 - *
			FCB	$01
			FCB	JB242 - *
			FCB	$02
			FCB	ZB2B4 - *
			FCB	$05
			FCB	JB26F - *
			FCB	$07
			FCB	ZB2B4 - *
			FCB	$08
			FCB	JB26F - *
			FCB	$09
			FCB	ZB2B4 - *
			FCB	$0B
			FCB	ZB223 - *
			FCB	$14
			FCB	JB2B8 - *
			FCB	$15
			FCB	ZB2B4 - *
			FCB	$16
			FCB	JB29D - *
			FCB	$18
			FCB	ZB2B4 - *
			FCB	$1F
			FCB	JB2A1 - *
			FCB	$20
			FCB	ZB223 - *
			FCB	$28
			FCB	JB2D7 - *
			FCB	$33
			FCB	JB30A - *
			FCB	$34
			FCB	JB2D7 - *
			FCB	$35
			FCB	JB224 - *
			FCB	$36
			FCB	ZB223 - *
			FCB	$3C
			FCB	JB2B2 - *
			FCB	$3D
			FCB	ZB2B4 - *
			FCB	$3E
			FCB	JB299 - *
			FCB	$3F
			FCB	ZB223 - *
			FCB	$46
			FCB	ZB2B4 - *
			FCB	$00

ZB223			RTS
JB224			JMP	ZB326
JB227			STAB	M7774
			LDAB	M778C
			BEQ	ZB23F
			DECB
ZB230			STAB	M777B
ZB233			LDX	#OP_ENABLE
			ABX
			STX	M7781
			LDAB	#$01
			JMP	ZB2CB
ZB23F			CLRB
			BRA	ZB245
JB242			STAB	M7774
ZB245			ASLB
			LDX	#MB61E
ZB249			ABX
			LDD	,X
ZB24C			STAB	M7783
			TAB
			CMPB	#110
			BCS	ZB256
			ANDB	#$7F
ZB256			STAB	M7787
			JSR	F_AF6F
			STX	M7784
			ABX
			TSTA
			BPL	ZB266
			JSR	F_B690
ZB266			STX	M7781
			CLR	>M00A5
			JMP	ZB560
JB26F			STAB	M7774
			LDAB	M778C
			CMPB	#$04
			BCS	F_B284
			CLRB
			JSR	F_B284
			LDAB	M778C
			SUBB	#$04
			BRA	ZB230

F_B284			STAB	M777B
			JSR	F_E110
			LDAB	M7774
			CMPB	#$08
			BEQ	ZB295
			SUBB	#$03
			BRA	ZB245
ZB295			LDAB	#$04
			BRA	ZB245
JB299			LDAA	#$02
			BRA	ZB2BA
JB29D			SUBA	#$14
			BRA	ZB2BA
JB2A1			STAB	M7774
			LDX	#M7740
			LDAB	M778C
			ABX
			STX	M7781
			LDAB	#$7F
			BRA	ZB2CB
JB2B2			BRA	ZB2B4
ZB2B4			LDAA	#$01
			BRA	ZB2BA
JB2B8			SUBA	#$14
ZB2BA			STAB	M7774
ZB2BD			LDAB	#$03
			MUL
			LDX	#T_PARAM_RANGE
			ABX
			LDD	,X
			STD	M7781
			LDAB	$02,X
ZB2CB			STAB	M7783
			CLR	M777E
			CLR	>M00A5
			JMP	ZB560
JB2D7			LDAA	M778C
			STAA	M7786
ZB2DD			STAB	M7774
			SUBB	#$28
ZB2E2			ASLB
			LDX	#MB672
			ABX
			LDD	,X
ZB2E9			STAB	M7783
			TAB
			CMPB	#110
			BCS	ZB2F3
			ANDB	#$7F
ZB2F3			STAB	M7787
			LDX	#PFM_EDIT_BUF
			ABX
			TSTA
			BMI	ZB300
			JMP	ZB266
ZB300			LDAB	M7786
			LDAA	#12
			MUL
			ABX
			JMP	ZB266
JB30A			LDAA	M778C
			BEQ	ZB2DD
			CMPA	#$01
			BNE	ZB31A
			STAB	M7774
			LDAB	#$0E
			BRA	ZB2E2
ZB31A			SUBA	#$02
			STAA	M7786
			STAB	M7774
			LDAB	#$0D
			BRA	ZB2E2
ZB326			STAB	M7774
			LDAA	M778C
			CMPA	#$0A
			BCS	ZB333
			JMP	ZB223
ZB333			ADDA	#$64
			LDAB	#$7F
			BRA	ZB2E9

ZB339			JSR	JMPOFF1
			FCB	ZB37F - *
			FCB	$02
			FCB	JB380 - *
			FCB	$03
			FCB	JB38A - *
			FCB	$04
			FCB	JB3EC - *
			FCB	$05
			FCB	ZB37F - *
			FCB	$07
			FCB	JB43F - *
			FCB	$08
			FCB	ZB37F - *
			FCB	$09
			FCB	JB37C - *
			FCB	$0A
			FCB	JB379 - *
			FCB	$0B
			FCB	ZB37F - *
			FCB	$15
			FCB	JB376 - *
			FCB	$16
			FCB	ZB37F - *
			FCB	$18
			FCB	JB373 - *
			FCB	$19
			FCB	JB367 - *
			FCB	$1A
			FCB	JB36A - *
			FCB	$1B
			FCB	JB36D - *
			FCB	$1C
			FCB	JB370 - *
			FCB	$1D
			FCB	ZB37F - *
			FCB	$1F
			FCB	JB364 - *
			FCB	$20
			FCB	ZB37F - *
			FCB	$00

JB364			JMP	ZB551
JB367			JMP	ZB4EC
JB36A			JMP	ZB4F7
JB36D			JMP	ZB502
JB370			JMP	ZB51F
JB373			JMP	ZB4EA
JB376			JMP	ZB4BE
JB379			JMP	ZB48E
JB37C			JMP	ZB46E
ZB37F			RTS
JB380			LDAB	M7789
ZB383			ASLB
			LDX	#MB628
			JMP	ZB249
JB38A			LDAB	M7789
			BNE	ZB39F
			LDAB	M778C
			BEQ	F_B3C3
			CLRB
			JSR	F_B3C3
			LDAB	M778C
			DECB
			JMP	ZB230
ZB39F			CMPB	#$01
			BEQ	ZB3C7
			LDAB	M778C
			CMPB	#$04
			BCS	F_B3B6
			CLRB
			JSR	F_B3B6
			LDAB	M778C
			SUBB	#$04
			JMP	ZB230

F_B3B6			STAB	M777B
			JSR	F_E110
			LDAB	M7789
			ADDB	#$07
			BRA	ZB383

F_B3C3			LDAB	#$06
			BRA	ZB383
ZB3C7			LDAB	M778C
			BEQ	ZB3E8
			CMPB	#$05
			BCS	F_B3DC
			CLRB
			JSR	F_B3DC
			LDAB	M778C
			SUBB	#$05
			JMP	ZB230

F_B3DC			SUBB	#$01
			STAB	M777B
			JSR	F_E110
			LDAB	#$08
			BRA	ZB383
ZB3E8			LDAB	#$07
			BRA	ZB383
JB3EC			JSR	F_B6A8
			STAA	M777B
			PSHB
			JSR	F_E110
			PULA
			TSTA
			BEQ	ZB426
			LDAB	M778C
			BEQ	ZB43B
			CMPB	#$02
			BCS	F_B40F
			CLRB
			JSR	F_B40F
			LDAB	M778C
			SUBB	#$02
			JMP	ZB233

F_B40F			CMPA	#$02
			BNE	F_B436
			JSR	F_AF5F
			LDAA	#$D9
			TIM	#%00111100,$0B,X
			BNE	ZB421
			LDAB	#$07
			BRA	ZB423
ZB421			LDAB	#$0F
ZB423			JMP	ZB24C
ZB426			LDAB	M778C
			BEQ	F_B436
			CLRB
			JSR	F_B436
			LDAB	M778C
			DECB
			JMP	ZB233

F_B436			ADDA	#$0B
			TAB
			BRA	ZB46B
ZB43B			LDAB	#$0D
			BRA	ZB46B
JB43F			LDAB	M778C
			LDAA	M7789
			CMPA	#$05
			BNE	ZB450
			TSTB
			BNE	ZB450
			INCB
			STAB	M778C
ZB450			CMPB	#$04
			BCS	F_B460
			CLRB
			JSR	F_B460
			LDAB	M778C
			SUBB	#$04
			JMP	ZB230

F_B460			STAB	M777B
			JSR	F_E110
			LDAB	M7789
			ADDB	#$0E
ZB46B			JMP	ZB383
ZB46E			LDAB	M778C
			CMPB	#$04
			BCS	F_B481
			CLRB
			JSR	F_B481
			LDAB	M778C
			SUBB	#$04
			JMP	ZB230

F_B481			STAB	M777B
			JSR	F_E110
			LDAB	M7789
			ADDB	#$14
			BRA	ZB46B
ZB48E			LDAB	M7789
			CMPB	#$0F
			BCC	ZB4AD
			CMPB	#$02
			BNE	ZB4A9
			JSR	F_AF6F
			TST	$3F,X
			BNE	ZB4A5
			LDAA	#$01
			JMP	ZB2BD
ZB4A5			LDAB	#$18
			BRA	ZB46B
ZB4A9			ADDB	#$16
			BRA	ZB46B
ZB4AD			LDAA	M778C
			CMPA	#$0A
			BCS	ZB4B7
			JMP	ZB37F
ZB4B7			ADDA	#$4D
			LDAB	#$7F
			JMP	ZB24C
ZB4BE			LDAA	M7788
			CMPA	#$02
			BCC	ZB4D5
			LDAA	M7789
			CMPA	#$08
			BCC	ZB4D0
			ADDA	#$04
			BRA	ZB4D2
ZB4D0			LDAA	#$01
ZB4D2			JMP	ZB2BD
ZB4D5			LDAA	M7789
			CMPA	#$0C
			BEQ	ZB4DF
			JMP	ZB37F
ZB4DF			LDAB	M778A
			LDX	#PROG_CHANGES
			ABX
			LDAB	#$B7
			BRA	ZB54B
ZB4EA			BRA	ZB4D0
ZB4EC			LDAA	M7789
			CMPA	#$04
			BCC	ZB4D0
			ADDA	#$0C
			BRA	ZB4D2
ZB4F7			LDAA	M7789
			CMPA	#$03
			BCC	ZB4D0
			ADDA	#$10
			BRA	ZB4D2
ZB502			LDAA	M7788
			CMPA	#$01
			BEQ	ZB4D0
			LDAA	M7789
			CMPA	#$0C
			BCS	ZB511
			CLRA
ZB511			LDAB	#$04
			MUL
			ADDB	M778C
			LDX	#CHORD
			ABX
			LDAB	#$31
			BRA	ZB54B
ZB51F			LDAA	M7788
			CMPA	#$01
			BEQ	ZB52F
			LDAA	M7789
			BEQ	ZB539
			CMPA	#$02
			BEQ	ZB534
ZB52F			JSR	HI_CALL_03
			BRA	ZB4D0
ZB534			LDX	#MICROTUNE_FULL
			BRA	ZB53C
ZB539			LDX	#MICROTUNE_OCT
ZB53C			LDAB	M778A
			ASLB
			ABX
			LDAB	#$6C
			TST	M778C
			BEQ	ZB54B
			LDAB	#$3F
			INX
ZB54B			STX	M7781
			JMP	ZB2CB
ZB551			LDX	#M7740
			LDAB	M778C
			ABX
			STX	M7781
			LDAB	#$7F
			JMP	ZB2CB
ZB560			LDX	M7781

F_B563			LDAA	M7783
			CMPA	,X
			BCC	ZB56C
			CLR	,X
ZB56C			LDAA	M7774
			CMPA	#$1F
			BEQ	ZB5A3
			CMPA	#$35
			BEQ	ZB5A3
			CMPA	#$0A
			BEQ	ZB595
			CMPA	#$07
			BEQ	ZB585
			CMPA	#$1C
			BEQ	ZB5C4
			BRA	ZB5AD
ZB585			LDAB	M7788
			CMPB	#$01
			BNE	ZB5AD
			LDAA	M7789
			CMPA	#$04
			BEQ	ZB5B4
			BRA	ZB5AD
ZB595			LDAB	M7788
			CMPB	#$01
			BNE	ZB5AD
			LDAA	M7789
			CMPA	#$0F
			BNE	ZB5AD
ZB5A3			LDAA	#$1F
			CMPA	,X
			BCS	ZB5AD
			LDAA	#$24
			STAA	,X
ZB5AD			LDX	M7781
			JSR	F_E10C
			RTS
ZB5B4			LDAA	M778C
			CMPA	#$04
			BCC	ZB5AD
			TST	,X
			BNE	ZB5AD
			OIM	#%00000001,$00,X
			BRA	ZB5AD
ZB5C4			LDAB	M7788
			CMPB	#$02
			BNE	ZB5AD
			LDAB	M7789
			BEQ	ZB5D4
			CMPB	#$02
			BNE	ZB5AD
ZB5D4			TST	M778C
			BNE	ZB5AD
			LDAA	#$0C
			CMPA	,X
			BCS	ZB5AD
			LDAA	#$0D
			STAA	,X
			BRA	ZB5AD

;
; three bytes per entry:
; - pointer to parameter's storage
; - its maximum permitted value
;
T_PARAM_RANGE		FDB	SYS_TUNE
			FCB	$7F
			FDB	M7570
			FCB	$01
			FDB	SYS_MLOCK
			FCB	$01
			FDB	SYS_CMBIN
			FCB	$01
			FDB	SYS_MIDBCH
			FCB	$10
			FDB	SYS_MIDTCH
			FCB	$0F
			FDB	SYS_PCINF
			FCB	$02
			FDB	SYS_COINF
			FCB	$11
			FDB	SYS_AT
			FCB	$01
			FDB	SYS_PBSW
			FCB	$11
			FDB	SYS_NOTESW
			FCB	$02
			FDB	SYS_SYSAVL
			FCB	$01
			FDB	EF1T
			FCB	$7F
			FDB	EF1P
			FCB	$30
			FDB	EF1F
			FCB	$07
			FDB	EF1L
			FCB	$63
			FDB	EF2D
			FCB	$02
			FDB	EF2S
			FCB	$01
			FDB	EF2R
			FCB	$63

MB61E			FDB	$3407,$3507,$DA07,$8C06,$8A63

MB628			FDB	$3B03,$3663,$3763,$3863,$3963,$3A01,$3C07,$3D03
			FDB	$8801,$8707,$8907,$D807,$8B3F,$D701,$801F,$811F
			FDB	$840F,$821F,$830F,$DB03,$8603,$8563,$3F01,$400C
			FDB	$4101,$4263,$4363,$6C63,$6D63,$4763,$4863,$4963
			FDB	$4A63,$4B64,$4C63,$3E30,$6B07

MB672			FDB	$6101,$8008,$829F,$8310,$847F,$857F,$860E,$8730
			FDB	$8863,$8903,$8A03,$600C,$6203,$8B01,$630B

;-------

F_B690			LDAB	M777B
			PSHX
			LDX	#D_A350
			ABX
			LDAB	,X
			PULX
			CMPA	#$D7
			BCS	1F
			LDAA	#$05
			BRA	2F
1			LDAA	#$0D
2			MUL
			ABX
			RTS

;-------

F_B6A8			LDAB	M7789
			CLRA
1			SUBB	#$03
			BMI	2F
			INCA
			BRA	1B
2			ADDB	#$03
			CMPA	#$04
			BCS	3F
			CLRA
3			RTS

;-------

F_B6BB			LDAA	M778C
			LDAB	M7788
			BEQ	ZB6CA
			CMPB	#$01
			BEQ	ZB6EE
			JMP	ZB724
ZB6CA			LDAB	M7774

			JSR	JMPOFF1
			FCB	ZB742 - *
			FCB	$01
			FCB	JB773 - *
			FCB	$05
			FCB	ZB752 - *
			FCB	$07
			FCB	JB773 - *
			FCB	$08
			FCB	ZB752 - *
			FCB	$09
			FCB	JB773 - *
			FCB	$1F
			FCB	JB76A - *
			FCB	$20
			FCB	JB773 - *
			FCB	$29
			FCB	ZB752 - *
			FCB	$33
			FCB	JB762 - *
			FCB	$34
			FCB	JB773 - *
			FCB	$35
			FCB	JB762 - *
			FCB	$36
			FCB	JB773 - *
			FCB	$3C
			FCB	ZB752 - *
			FCB	$3D
			FCB	JB773 - *
			FCB	$00

ZB6EE			LDAB	M7774
			JSR	JMPOFF1
			FCB	JB773 - *
			FCB	$03
			FCB	JB706 - *
			FCB	$04
			FCB	JB711 - *
			FCB	$05
			FCB	JB773 - *
			FCB	$07
			FCB	ZB752 - *
			FCB	$08
			FCB	JB773 - *
			FCB	$09
			FCB	ZB752 - *
			FCB	$0A
			FCB	JB762 - *
			FCB	$0B
			FCB	JB773 - *
			FCB	$00

JB706			LDAB	M7789
			BEQ	ZB742
			CMPB	#$02
			BCS	ZB75A
			BRA	ZB752
JB711			LDAB	M7789
			BEQ	ZB742
			CMPB	#$03
			BEQ	ZB742
			CMPB	#$06
			BEQ	ZB742
			CMPB	#$09
			BEQ	ZB742
			BRA	ZB74A

ZB724			LDAB	M7774
			JSR	JMPOFF1
			FCB	JB773 - *
			FCB	$1B
			FCB	JB73A - *
			FCB	$1C
			FCB	JB732 - *
			FCB	$1D
			FCB	JB773 - *
			FCB	$00

JB732			CMPA	#$01
			BLS	ZB770
			LDAA	#$01
			BRA	ZB770
JB73A			CMPA	#$03
			BLS	ZB770
			LDAA	#$03
			BRA	ZB770
ZB742			CMPA	#$04
			BLS	ZB770
			LDAA	#$04
			BRA	ZB770
ZB74A			CMPA	#$05
			BLS	ZB770
			LDAA	#$05
			BRA	ZB770
ZB752			CMPA	#$07
			BLS	ZB770
			LDAA	#$07
			BRA	ZB770
ZB75A			CMPA	#$08
			BLS	ZB770
			LDAA	#$08
			BRA	ZB770
JB762			CMPA	#$09
			BLS	ZB770
			LDAA	#$09
			BRA	ZB770
JB76A			CMPA	#$0F
			BLS	ZB770
			LDAA	#$0F
ZB770			STAA	M778C
JB773			RTS

F_B774			AIM	#~ECMI,TCSR3
			LDX	#M6A67
			STX	M00A9
			LDX	#M6A19
			JSR	LO_CALL_06
			BRA	ZB79F

F_B784			JSR	MIDI_SEND_PGM_CNG
F_B787			CMPB	M7773
			BNE	F_B796
			TST	VOICE_EDITED
			BNE	F_B796
			JSR	F_E178
			BRA	ZB7C2

F_B796			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_19
			CLR	VOICE_COMPARE
ZB79F			JSR	F_AEDD

F_B7A2			STX	M00A9
			AIM	#~ECMI,TCSR3
			LDX	#M6A67
			JSR	LO_CALL_00
			JSR	LO_CALL_08
			JSR	F_E178
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_91FE
			OIM	#ECMI,TCSR3
ZB7C2			RTS

F_B7C3			PSHB
			ADDB	#$20
			JSR	MIDI_SEND_PGM_CNG
			PULB
			CMPB	M7779
			BNE	F_B7D6
			TST	PFM_EDITED
			BNE	F_B7D6
			BRA	ZB804

F_B7D6			AIM	#~ECMI,TCSR3
			STAB	M7779
			CLR	PFM_EDITED
			JSR	F_AEFF
			STX	M00A9
			AIM	#~ECMI,TCSR3
			LDX	#PFM_EDIT_BUF
			JSR	F_AED3
HI_CALL_13		JSR	SEND_SYSEX_PCED
			JSR	LO_CALL_0A
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_C7C2
			OIM	#ECMI,TCSR3
			BSR	F_B805
ZB804			RTS

F_B805			AIM	#~ECMI,TCSR3
			BSR	F_B820
			JSR	LO_CALL_08
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE
			JSR	HI_CALL_15
			JSR	HI_CALL_16
			OIM	#ECMI,TCSR3
			RTS

F_B820			CLRB
ZB821			PSHB
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAB	$02,X
			JSR	F_AEE0
			STX	M00A9
			PULA
			PSHA
			JSR	F_9A2F
			JSR	LO_CALL_00
			PULB
			INCB
			CMPB	#$08
			BNE	ZB821
			RTS

F_B83F			LDAB	M7795
			STAB	M7773
			CLR	VOICE_EDITED
			CLR	VOICE_COMPARE
			LDX	#M6A67
			STX	M00A9
			JSR	F_AEDD
			JSR	LO_CALL_06
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE
			JMP	F_E113

F_B862			LDAA	M777F
			CMPA	#$20
			BCS	ZB86A
			CLRA
ZB86A			STAA	M00A9
			LDAA	#$1F
ZB86E			STAA	M00A7
			DECB
			TST	M7795
			BMI	ZB87E
			LDAA	M7795
			JSR	F_8D0C
			BRA	ZB880
ZB87E			LDAA	M00A9
ZB880			STAA	M7795
			RTS

F_B884			LDAA	M777A
			STAA	M00A9
			LDAA	#$17
			BRA	ZB86E

F_B88D			LDAB	M7795
			STAB	M7779
			CLR	PFM_EDITED
			LDX	#PFM_EDIT_BUF
			STX	M00A9
			JSR	F_AEFF
			JSR	LO_CALL_07
			JSR	HI_CALL_00
			JMP	HI_CALL_01

F_B8A7			LDAB	M7794
			JSR	F_AF62
			STX	M00A7
			LDAB	M777C
			JSR	F_AF62
			STX	M00A9
			LDAB	#$07
			JSR	MEMCPY_xB_A9_A7
			LDAB	#$01
			STAB	VOICE_EDITED
			LDX	#F_9E95
			JSR	F_92DB
			LDX	#F_9EB9
			JSR	F_92DB
			LDX	#F_9ECC
			JSR	F_92DB
			LDX	#F_9EEC
			JSR	F_92DB
			LDX	#F_9F00
			JSR	F_92DB
			JSR	F_E114
			RTS

F_B8E3			DECB
			TST	>M0059
			BNE	ZB8F8
			LDAA	#$03
			STAA	M00A7
			LDAA	M777C
			JSR	F_8D0C
			STAA	M777C
			BRA	ZB90D
ZB8F8			TST	M7794
			BMI	ZB909
			LDAA	#$03
			STAA	M00A7
			LDAA	M7794
			JSR	F_8D0C
			BRA	ZB90A
ZB909			CLRA
ZB90A			STAA	M7794
ZB90D			RTS

F_B90E			AIM	#~ECMI,TCSR3
			LDAB	#110
			LDX	#M6A67
			STX	M00A9
			LDX	#M6AD5
			JSR	MEMCPY_xB_A9_X
			JSR	LO_CALL_08
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_91FE
			JSR	F_C7C2
			OIM	#ECMI,TCSR3
			RTS

F_B931			TST	M7788
			BEQ	ZB939
			JMP	ZBA42
ZB939			TBA
			LDAB	M7774

			JSR	JMPOFF1
			FCB	JB971 - *
			FCB	$02
			FCB	JB97B - *
			FCB	$04
			FCB	JB974 - *
			FCB	$05
			FCB	JB971 - *
			FCB	$07
			FCB	JB9B7 - *
			FCB	$08
			FCB	JB971 - *
			FCB	$09
			FCB	JB9BE - *
			FCB	$0A
			FCB	JB9BB - *
			FCB	$0B
			FCB	JB971 - *
			FCB	$15
			FCB	JB9C2 - *
			FCB	$16
			FCB	JB971 - *
			FCB	$18
			FCB	JB9C9 - *
			FCB	$19
			FCB	JB9D0 - *
			FCB	$1A
			FCB	JB9DE - *
			FCB	$1B
			FCB	JB9D0 - *
			FCB	$1C
			FCB	JB9F0 - *
			FCB	$1D
			FCB	JB9F7 - *
			FCB	$1F
			FCB	JB971 - *
			FCB	$3C
			FCB	JBA10 - *
			FCB	$3D
			FCB	JBA19 - *
			FCB	$3E
			FCB	JB971 - *
			FCB	$46
			FCB	JB96E - *
			FCB	$47
			FCB	JB971 - *
			FCB	$00

JB96E			JMP	ZBBB1
JB971			TAB
			CLC
			RTS
JB974			PSHB
			LDAB	#$01
			STAB	M778C
			PULB
JB97B			SUBB	#$02
ZB97D			CMPA	#$01
			BNE	ZB9B5
			LDX	#MBBE4
			ABX
			LDAB	,X
			STAB	M778D
			STAA	M7788
			STAA	M00A4
			CLR	M7789
			LDAB	M7774
			CMPB	#$04
			BNE	ZB9A6
			JSR	F_AF6F
			TST	$66,X
			BNE	ZB9A3
			INC	M7789
ZB9A3			LDAB	M7774
ZB9A6			JSR	F_B1DD
			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_15
			JSR	HI_CALL_16
			OIM	#ECMI,TCSR3
ZB9B5			SEC
			RTS
JB9B7			LDAB	#$03
			BRA	ZB97D
JB9BB			CLR	M778C
JB9BE			SUBB	#$05
			BRA	ZB97D
JB9C2			CLR	M777E
			LDAB	#$06
			BRA	ZB97D
JB9C9			CLR	M777E
			LDAB	#$07
			BRA	ZB97D
JB9D0			SUBB	#$11
			PSHB
			PSHA
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			PULA
			PULB
			BRA	ZB97D
JB9DE			SUBB	#$11
			CMPA	#$01
			BNE	ZB9B5
			STAA	M7788
			PSHB
			JSR	F_B90E
			PULB
			LDAA	#$01
			BRA	ZB97D
JB9F0			CLR	M778F
			SUBB	#$11
			BRA	ZB97D
JB9F7			TST	>M00A5
			BEQ	ZBA08
			CLR	>M00A5
			CMPA	#$01
			BNE	ZBA0E
			JSR	F_C274
			BRA	ZBA0E
ZBA08			CMPA	#$01
			BNE	ZBA0E
			STAA	M00A5
ZBA0E			SEC
			RTS
JBA10			CMPA	#$01
			BNE	ZB9B5
			JSR	F_C259
			BRA	ZB9B5
JBA19			TST	>M00A5
			BEQ	ZBA2A
			CLR	>M00A5
			CMPA	#$01
			BNE	ZB9B5
			JSR	F_C33D
			BRA	ZB9B5
ZBA2A			CMPA	#$01
			BEQ	ZBA3D
			LDAA	M777E
			INCA
			CMPA	#$05
			BCS	ZBA37
			CLRA
ZBA37			STAA	M777E
			JMP	ZB9B5
ZBA3D			STAA	M00A5
			JMP	ZB9B5
ZBA42			TBA
			CLR	>M00A4
			LDAB	M7774

			JSR	JMPOFF1
			FCB	ZBA5C - *
			FCB	$15
			FCB	JBA5F - *
			FCB	$16
			FCB	ZBA5C - *
			FCB	$18
			FCB	JBADD - *
			FCB	$19
			FCB	ZBA5C - *
			FCB	$1B
			FCB	JBB12 - *
			FCB	$1C
			FCB	JBB34 - *
			FCB	$1D
			FCB	ZBA5C - *
			FCB	$00

ZBA5C			TAB
			CLC
			RTS
JBA5F			LDAB	M7789
			CMPB	#$08
			BEQ	ZBAC3
			BCS	ZBA5C
			CMPB	#$0D
			BCC	ZBA5C
			CMPB	#$09
			BEQ	ZBABA
			CMPB	#$0A
			BNE	ZBA8B
			CMPA	#$01
			BEQ	ZBA86
			LDAA	M777E
			INCA
			CMPA	#$05
			BCS	ZBA81
			CLRA
ZBA81			STAA	M777E
			BRA	ZBADB
ZBA86			JSR	F_BBF0
			BRA	ZBADB
ZBA8B			CMPB	#$0B
			BNE	ZBAAC
			TST	>M00A5
			BEQ	ZBAA4
			CLR	>M00A5
			CMPA	#$01
			BNE	ZBADB
			JSR	F_C245
			INC	M7789
			JMP	ZBBA6
ZBAA4			CMPA	#$01
			BNE	ZBADB
			STAA	M00A5
			BRA	ZBADB
ZBAAC			LDAB	M7788
			CMPB	#$02
			BEQ	ZBA5C
			CMPA	#$01
			BNE	ZBADB
			JMP	ZBB7A
ZBABA			CMPA	#$01
			BNE	ZBADB
			JSR	SEND_SYSEX_PMEM
			BRA	ZBADB
ZBAC3			CMPA	#$01
			BEQ	ZBAD5
			LDAA	M777E
			INCA
			CMPA	#$05
			BCS	ZBAD0
			CLRA
ZBAD0			STAA	M777E
			BRA	ZBADB
ZBAD5			JSR	F_E115
			JSR	F_BC18
ZBADB			SEC
			RTS
JBADD			CMPA	#$01
			BNE	ZBAEA
			LDAB	#$01
			STAB	XROM
			JSR	XROM_CALL
			BRA	ZBB10
ZBAEA			LDAA	M7789
			BEQ	ZBB01
			CMPA	#$08
			BCS	ZBB10
			LDAA	M777E
			INCA
			CMPA	#$05
			BCS	ZBAFC
			CLRA
ZBAFC			STAA	M777E
			BRA	ZBB10
ZBB01			LDAA	M777E
			INCA
			ANDA	#$01
			STAA	M777E
			LDX	M7781
			JSR	F_E10C
ZBB10			SEC
			RTS
JBB12			LDAB	M7788
			CMPB	#$01
			BEQ	ZBB1C
			JMP	ZBA5C
ZBB1C			CMPA	#$01
			BEQ	ZBB28
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			BRA	ZBBA0
ZBB28			JSR	HI_CALL_00
			JSR	HI_CALL_01
			JSR	F_ED75
			CLRB
			BRA	ZBB7C
JBB34			LDAB	M7789
			BEQ	ZBB63
			CMPB	#$02
			BEQ	ZBB63
			LDAB	M7788
			CMPB	#$02
			BEQ	ZBB4C
			CMPA	#$01
			BNE	ZBBA0
			LDAB	#$0A
			BRA	ZBB7C
ZBB4C			CMPA	#$01
			BNE	ZBB96
			JSR	F_C345
			JSR	HI_CALL_03
			LDAA	#$01
			STAA	M7788
			DEC	M7789
			CLR	M778A
			BRA	ZBBA6
ZBB63			LDAB	M7788
			CMPB	#$01
			BEQ	ZBB6D
			JMP	ZBA5C
ZBB6D			CMPA	#$01
			BNE	ZBBA0
			TST	M7789
			BNE	ZBB7A
			LDAB	#$0B
			BRA	ZBB7C
ZBB7A			LDAB	#$7F
ZBB7C			STAB	M778E
			LDAA	#$01
			STAA	M00A4
			LDAA	#$02
			STAA	M7788
			CLR	M778A
			CLR	M778C
			LDAB	M7774
			JSR	F_B1DD
ZBB94			SEC
			RTS
ZBB96			LDAA	#$01
			STAA	M7788
			CLR	M778A
			BRA	ZBBA6
ZBBA0			CLR	M7788
			CLR	M7789
ZBBA6			CLR	M778C
			LDAB	M7774
			JSR	F_B1DD
			BRA	ZBB94
ZBBB1			CMPA	#$01
			BNE	F_BBBC
			LDAB	#$02
			STAB	XROM
			JSR	XROM_CALL

F_BBBC			CLR	>M00A6
			LDX	#S_GOOD_MORNING
			STX	M00A9
			LDAB	#$10
			LDX	#M7740
			JSR	MEMCPY_xB_A9_X
			LDAA	#$01
			STAA	M00CC
			LDAB	M7779
			JSR	F_B7D6
			JSR	F_B09A
			LDAB	M7773
			JSR	MIDI_SEND_PGM_CNG
			JSR	F_B796
			SEC
			RTS
MBBE4			FCB	$05,$03,$0B,$05,$01,$0F,$0C,$0A,$03,$02,$0B,$03

;-------

F_BBF0			LDAB	M777E
			CMPB	#$05
			BCS	1F
			CLRB
1			PSHB
			ASLB
			LDX	#MBC0E
			ABX
			LDX	,X
			JSR	,X
			PULB
			TSTB
			BEQ	2F
			CMPB	#$04
			BEQ	2F
			JSR	DELAY_30_x_4500
2			RTS

MBC0E			FDB	F_E633
			FDB	SEND_SYSEX_SYS0
			FDB	SEND_SYSEX_SYS1
			FDB	SEND_SYSEX_SYS2
			FDB	F_E639

;-------

F_BC18			TST	M777E
			BEQ	ZBC26
			LDAB	#$03
			STAB	XROM
			JSR	XROM_CALL
			BRA	ZBC29
ZBC26			JSR	F_E11D
ZBC29			RTS

F_BC2A			LDX	M7781
			JSR	F_E0E9
			TST	VOICE_COMPARE
			BEQ	ZBC3F
			LDAA	M7772
			CMPA	#$01
			BNE	ZBC3F
			JMP	ZBDE5
ZBC3F			PSHB
			LDAB	M7772
			CMPB	#$05
			BNE	ZBC8E
			LDAB	M7774
			CMPB	#$29
			BNE	ZBC6A
			LDX	#PFM_EDIT_BUF
			CLRA
			LDAB	#12
ZBC54			ADDA	,X
			ABX
			CPX	#PFM_EDIT_INST_END
			BNE	ZBC54
			CMPA	#$08
			BHI	ZBC8B
			BCS	ZBCB0
			PULB
			PSHB
			CMPB	#$02
			BEQ	ZBCB0
			BRA	ZBC8B
ZBC6A			CMPB	#$2A
			BCS	ZBCB0
			CMPB	#$34
			BCC	ZBCB0
			CMPB	#$33
			BNE	ZBC7D
			LDAB	M778C
			CMPB	#$02
			BCS	ZBCB0
ZBC7D			LDAA	M7786
			LDAB	#12
			MUL
			LDX	#PFM_EDIT_BUF
			ABX
			TST	,X
			BNE	ZBCB0
ZBC8B			JMP	ZBDE6
ZBC8E			CMPB	#$01
			BNE	ZBCB0
			LDAB	M7787
			CMPB	#$0B
			BNE	ZBCA2
			LDAB	M778C
			CMPB	#$02
			BCS	ZBCB3
			BRA	ZBCB0
ZBCA2			CMPB	#$59
			BNE	ZBCB0
			LDAB	M778C
			CMPB	#$02
			BCC	ZBCB0
			JMP	ZBDE8
ZBCB0			CLRA
			BRA	ZBCEB
ZBCB3			LDAB	M777B
			LDAA	#$05
			JSR	F_AF64
			LDAA	$57,X
			PULB
			PSHA
			LDX	M7781
			DECB
			BEQ	ZBCF3
			LDAA	,X
			BNE	ZBCCC
			JMP	ZBDE6
ZBCCC			CMPA	#$05
			BCS	ZBCD3
			JMP	ZBD90
ZBCD3			LDAB	M777B
			LDAA	#$05
			JSR	F_AF64
			LDAA	$59,X
			CMPA	#$08
			BCS	ZBCE5
			LDAA	#$07
			STAA	$59,X
ZBCE5			LDX	M7781
			JMP	ZBD8C
ZBCEB			PULB
			PSHA
			LDX	M7781
			DECB
			BNE	ZBD4C
ZBCF3			LDAB	M7774
			CMPB	#$1C
			BEQ	ZBD0A
			CMPB	#$2A
			BNE	ZBD2D
			LDAA	,X
			CMPA	M7783
			BNE	ZBD37
			PULB
			CLRA
			JMP	F_BE61
ZBD0A			LDAB	M7788
			CMPB	#$02
			BNE	ZBD2D
			TST	M778C
			BEQ	ZBD2D
			LDAA	,X
			CMPA	M7783
			BNE	ZBD37
			DEX
			LDAA	,X
			CMPA	#$6C
			BCC	ZBD34
			INCA
			STAA	,X
			INX
			CLRA
			PULB
			JMP	F_BE61
ZBD2D			LDAA	,X
			CMPA	M7783
			BNE	ZBD37
ZBD34			JMP	ZBDE6
ZBD37			PULB
			TSTB
			BEQ	ZBD48
			ADDA	#$04
			CMPA	M7783
			BLS	ZBD45
			JMP	ZBDE5
ZBD45			JMP	F_BE61
ZBD48			INCA
			JMP	F_BE61
ZBD4C			LDAB	M7774
			CMPB	#$1C
			BEQ	ZBD62
			CMPB	#$2A
			BNE	ZBD8C
			LDAA	,X
			BNE	ZBD90
			PULB
			LDAA	M7783
			JMP	F_BE61
ZBD62			LDAB	M7788
			CMPB	#$02
			BNE	ZBD8C
			TST	M778C
			BEQ	ZBD84
			LDAA	,X
			BNE	ZBD90
			DEX
			LDAA	,X
			CMPA	#$0D
			BLS	ZBDE6
			DECA
			STAA	,X
			INX
			LDAA	M7783
			PULB
			JMP	F_BE61
ZBD84			LDAA	,X
			CMPA	#$0D
			BLS	ZBDE6
			BRA	ZBD90
ZBD8C			LDAA	,X
			BEQ	ZBDE6
ZBD90			PULB
			TSTB
			BEQ	ZBD9B
			SUBA	#$04
			BMI	ZBDE5
			JMP	F_BE61
ZBD9B			DECA
			LDAB	M7774
			CMPB	#$35
			BEQ	ZBDDE
			CMPB	#$0A
			BEQ	ZBDC6
			CMPB	#$07
			BNE	ZBDD4
			LDAB	M7788
			CMPB	#$01
			BNE	ZBDD4
			LDAB	M7789
			CMPB	#$04
			BNE	ZBDD4
			LDAB	M778C
			CMPB	#$04
			BCC	ZBDD4
			TSTA
			BEQ	ZBDE5
			JMP	F_BE61
ZBDC6			LDAB	M7788
			CMPB	#$01
			BNE	ZBDD4
			LDAB	M7789
			CMPB	#$0F
			BEQ	ZBDDE
ZBDD4			CPX	#MICROTUNE_FULL_END
			BCS	ZBDE2
			CPX	#M7750
			BCC	ZBDE2
ZBDDE			CMPA	#$20
			BCS	ZBDE5
ZBDE2			JMP	F_BE61
ZBDE5			RTS
ZBDE6			PULA
			RTS
ZBDE8			PULB
			LDX	M7781
			DECB
			BNE	ZBE2B
			LDAA	,X
			CMPA	M7783
			BEQ	ZBDF9
			INCA
			BRA	ZBE28
ZBDF9			PSHX
			DEX
			DEX
			LDAA	,X
			BEQ	ZBE5F
			PSHA
			JSR	F_AF5F
			LDAA	$0B,X
			CMPA	#$3F
			BCC	ZBE5E
			PULB
			TSTB
			BEQ	ZBE16
			ADDA	#$04
			CMPA	#$3F
			BHI	ZBE5F
			BRA	ZBE17
ZBE16			INCA
ZBE17			STAA	$0B,X
			PULX
			CMPA	#$04
			BCC	ZBE22
			LDAA	#$07
			BRA	ZBE24
ZBE22			LDAA	#$0F
ZBE24			STAA	M7783
			CLRA
ZBE28			JMP	F_BE61
ZBE2B			LDAA	,X
			BEQ	ZBE32
			DECA
			BRA	ZBE5C
ZBE32			PSHX
			DEX
			DEX
			LDAA	,X
			BEQ	ZBE5F
			PSHA
			JSR	F_AF5F
			LDAA	$0B,X
			BEQ	ZBE5E
			PULB
			TSTB
			BEQ	ZBE4B
			SUBA	#$04
			BMI	ZBE5F
			BRA	ZBE4C
ZBE4B			DECA
ZBE4C			STAA	$0B,X
			PULX
			CMPA	#$04
			BCC	ZBE57
			LDAA	#$07
			BRA	ZBE59
ZBE57			LDAA	#$0F
ZBE59			STAA	M7783
ZBE5C			BRA	F_BE61
ZBE5E			PULA
ZBE5F			PULX
			RTS

F_BE61			JMP	ZBEBF
			LDAB	M7774
			CMPB	#$15
			BNE	ZBE7B
			LDAB	M7788
			CMPB	#$01
			BNE	ZBEBF
			LDAB	M7789
			CMPB	#$02
			BCS	ZBE87
			BRA	ZBEBF
ZBE7B			CMPB	#$29
			BEQ	ZBE87
			CMPB	#$2E
			BCC	ZBEBF
			CMPB	#$2B
			BCS	ZBEBF
ZBE87			PSHX
			LDX	#M7CE3
			LDAB	#$08
ZBE8D			TIM	#%00000010,$01,X
			BNE	ZBEBC
			INX
			INX
			DECB
			BNE	ZBE8D
			LDAB	M7772
			ANDB	#$04
			BEQ	ZBEA2
			LDAB	#$08
			BRA	ZBEA4
ZBEA2			LDAB	#$01
ZBEA4			LDX	#M7F39
ZBEA7			PSHB
			LDAB	M006C
ZBEAA			TIM	#%00000010,$01,X
			BNE	ZBEBB
			INX
			INX
			DECB
			BNE	ZBEAA
			PULB
			DECB
			BNE	ZBEA7
			PULX
			BRA	ZBEBF
ZBEBB			PULB
ZBEBC			PULX
			BRA	ZBF10
ZBEBF			STAA	,X
			JSR	F_B563
			LDAB	M7788
			BEQ	ZBECC
			JMP	ZBF4F
ZBECC			LDAB	M7774

			JSR	JMPOFF1
			FCB	JBF19 - *
			FCB	$01
			FCB	JBF1C - *
			FCB	$02
			FCB	ZBF10 - *
			FCB	$05
			FCB	JBF13 - *
			FCB	$06
			FCB	JBF16 - *
			FCB	$07
			FCB	ZBF10 - *
			FCB	$08
			FCB	JBF22 - *
			FCB	$09
			FCB	ZBF10 - *
			FCB	$14
			FCB	JBF1F - *
			FCB	$15
			FCB	ZBF10 - *
			FCB	$16
			FCB	JBF31 - *
			FCB	$18
			FCB	ZBF10 - *
			FCB	$19
			FCB	JBF25 - *
			FCB	$1D
			FCB	JBF31 - *
			FCB	$20
			FCB	ZBF10 - *
			FCB	$28
			FCB	JBF2B - *
			FCB	$29
			FCB	JBF2E - *
			FCB	$2A
			FCB	JBF34 - *
			FCB	$2B
			FCB	JBF37 - *
			FCB	$2C
			FCB	JBF3A - *
			FCB	$2E
			FCB	JBF28 - *
			FCB	$2F
			FCB	JBF3D - *
			FCB	$30
			FCB	JBF40 - *
			FCB	$31
			FCB	JBF43 - *
			FCB	$32
			FCB	JBF46 - *
			FCB	$33
			FCB	JBF49 - *
			FCB	$34
			FCB	JBF4C - *
			FCB	$35
			FCB	JBF28 - *
			FCB	$36
			FCB	ZBF10 - *
			FCB	$3C
			FCB	JBF31 - *
			FCB	$3F
			FCB	ZBF10 - *
			FCB	$00

ZBF10			JMP	ZC0ED
JBF13			JMP	ZC05A
JBF16			JMP	ZC002
JBF19			JMP	ZC177
JBF1C			JMP	ZC187
JBF1F			JMP	ZC1E0
JBF22			JMP	ZC1C8
JBF25			JMP	ZC207
JBF28			JMP	ZC16F
JBF2B			JMP	ZC16C
JBF2E			JMP	ZC169
JBF31			JMP	ZC0E4
JBF34			JMP	ZC0EF
JBF37			JMP	ZC0FE
JBF3A			JMP	ZC125
JBF3D			JMP	ZC12D
JBF40			JMP	ZC135
JBF43			JMP	ZC146
JBF46			JMP	ZC14B
JBF49			JMP	ZC150
JBF4C			JMP	ZC155
ZBF4F			LDAB	M7774

			JSR	JMPOFF1
			FCB	JBF77 - *
			FCB	$02
			FCB	JBF7D - *
			FCB	$03
			FCB	JBFB7 - *
			FCB	$04
			FCB	JC015 - *
			FCB	$05
			FCB	JBF77 - *
			FCB	$07
			FCB	JBF86 - *
			FCB	$08
			FCB	JBF77 - *
			FCB	$09
			FCB	JBF80 - *
			FCB	$0A
			FCB	JBF83 - *
			FCB	$0B
			FCB	JBF77 - *
			FCB	$15
			FCB	JBF7A - *
			FCB	$16
			FCB	JBF77 - *
			FCB	$19
			FCB	JBF89 - *
			FCB	$1A
			FCB	JBF96 - *
			FCB	$1B
			FCB	JBFA6 - *
			FCB	$1C
			FCB	JBFB1 - *
			FCB	$1D
			FCB	JBF77 - *
			FCB	$00

JBF77			JMP	ZC0ED
JBF7A			JMP	ZC1EE
JBF7D			JMP	ZC18F
JBF80			JMP	ZC09C
JBF83			JMP	ZC0B1
JBF86			JMP	ZC073
JBF89			LDAB	M7789
			CMPB	#$01
			BNE	ZBF93
			JMP	ZC207
ZBF93			JMP	ZC0E4
JBF96			JSR	HI_CALL_11
			LDAB	M7789
			CMPB	#$02
			BNE	ZBFA3
			JMP	ZC0E4
ZBFA3			JMP	ZC207
JBFA6			LDAA	M776B
			ANDA	#%11110111
			STAA	M776B
			JMP	ZC207
JBFB1			JSR	HI_CALL_03
			JMP	ZC0E4
JBFB7			LDAB	M7789
			BNE	ZBFCA
			TST	M778C
			BNE	ZBFF0
			LDX	#F_9D91
			JSR	F_92E3
			JMP	ZC1D8
ZBFCA			CMPB	#$01
			BNE	ZBFE9
			LDAB	M778C
			BEQ	ZBFE0
			CMPB	#$05
			BCC	ZBFF0
			LDX	#F_9EB9
			JSR	F_92DB
			JMP	ZC1D8
ZBFE0			LDX	#F_9D91
			JSR	F_92E3
			JMP	ZC1D8
ZBFE9			LDAB	M778C
			CMPB	#$04
			BCS	ZBFF3
ZBFF0			JMP	ZC0E4
ZBFF3			LDX	#F_9D68
			JSR	F_92DB
			LDX	#F_9FEC
			JSR	F_92DB
			JMP	ZC1D8
ZC002			LDAB	M778C
			CMPB	#$04
			BCS	ZC00C
			JMP	ZC0E4
ZC00C			LDX	#F_9DD7
			JSR	F_92DB
			JMP	ZC1D8
JC015			LDAB	M7789
			BEQ	ZC02F
			CMPB	#$03
			BEQ	ZC02F
			CMPB	#$06
			BEQ	ZC02F
			CMPB	#$09
			BEQ	ZC02F
			LDAB	M778C
			CMPB	#$02
			BCS	ZC037
			BRA	ZC034
ZC02F			TST	M778C
			BEQ	ZC037
ZC034			JMP	ZC0E4
ZC037			LDAB	M7787
			CMPB	#$0B
			BNE	ZC052
			ANDA	#$3C
			BNE	ZC052
			LDAB	M777B
			LDAA	#$05
			JSR	F_AF64
			LDAA	#$07
			CMPA	$59,X
			BCC	ZC052
			STAA	$59,X
ZC052			LDX	#F_9E95
			JSR	F_92DB
			BRA	ZC064
ZC05A			LDAB	M778C
			CMPB	#$04
			BCS	ZC064
			JMP	ZC0E4
ZC064			LDX	#F_9DD7
			JSR	F_92DB
			LDX	#F_9E58
			JSR	F_92DB
			JMP	ZC1BE
ZC073			LDAB	M778C
			CMPB	#$04
			BCS	ZC07D
			JMP	ZC0E4
ZC07D			LDAB	M7789
			CMPB	#$06
			BCC	ZC0ED

			JSR	JMPOFFB
			FCB	JC08D - *
			FCB	JC090 - *
			FCB	JC093 - *
			FCB	JC096 - *
			FCB	JC093 - *
			FCB	JC099 - *

JC08D			JMP	ZC1AF
JC090			JMP	ZC1B4
JC093			JMP	ZC1B9
JC096			JMP	ZC1BE
JC099			JMP	ZC1C3
ZC09C			LDAB	M778C
			CMPB	#$04
			BCS	ZC0A6
			JMP	ZC0E4
ZC0A6			TST	M7789
			BEQ	ZC0AE
			JMP	ZC1D2
ZC0AE			JMP	ZC1AF
ZC0B1			LDAB	M7789

			JSR	JMPOFF1
			FCB	JC0D5 - *
			FCB	$01
			FCB	JC0D8 - *
			FCB	$02
			FCB	JC0D2 - *
			FCB	$03
			FCB	JC0DB - *
			FCB	$04
			FCB	JC0DE - *
			FCB	$05
			FCB	ZC18F - *
			FCB	$0B
			FCB	JC0D8 - *
			FCB	$0C
			FCB	JC0DE - *
			FCB	$0D
			FCB	JC0E1 - *
			FCB	$0E
			FCB	JC0CF - *
			FCB	$0F
			FCB	JC0D2 - *
			FCB	$10
			FCB	ZC0ED - *
			FCB	$00

JC0CF			JMP	ZC1C3
JC0D2			JMP	ZC1D8
JC0D5			JMP	ZC207
JC0D8			JMP	ZC229
JC0DB			JMP	ZC221
JC0DE			JMP	ZC237
JC0E1			JMP	ZC1E6
ZC0E4			LDX	M7781
			JSR	F_E10C
			SEC
			BRA	ZC0EE
ZC0ED			CLC
ZC0EE			RTS
ZC0EF			LDAB	M778C
			STAB	M0073
			LDX	M7781
			LDAB	,X
			JSR	F_D06A
			BRA	ZC16F
ZC0FE			TST	PFM_EDIT_ASSIGN
			BEQ	ZC10E
			JSR	F_C7C2
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			BRA	ZC120
ZC10E			LDAB	M778C
			JSR	F_D099
			LDAB	M778C
			JSR	F_C832
			AIM	#~EOCI1,TCSR1
			JSR	F_995A
ZC120			OIM	#EOCI1,TCSR1
			BRA	ZC16F
ZC125			LDAB	M778C
			JSR	F_D099
			BRA	ZC16F
ZC12D			LDX	#F_A01B
			JSR	F_92E3
			BRA	ZC16F
ZC135			LDAB	M778C
			JSR	F_C81C
			AIM	#~ECMI,TCSR3
			JSR	F_EC17
			OIM	#ECMI,TCSR3
			BRA	ZC16F
ZC146			JSR	F_95E5
			BRA	ZC16F
ZC14B			JSR	F_B805
			BRA	ZC16F
ZC150			JSR	HI_CALL_03
			BRA	ZC16F
ZC155			JSR	HI_CALL_00
			JSR	HI_CALL_01
			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_15
			JSR	HI_CALL_16
			OIM	#ECMI,TCSR3
			BRA	ZC16F
ZC169			JSR	F_C7C2
ZC16C			JSR	F_B805
ZC16F			LDAA	#$01
			STAA	PFM_EDITED
			JMP	ZC0E4
ZC177			TST	M778C
			BNE	ZC184
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			BRA	ZC187
ZC184			JMP	ZC0E4
ZC187			LDX	#F_9A41
			JSR	F_92E3
			BRA	ZC1D2
ZC18F			JSR	F_9A87
			LDX	#F_9B02
			JSR	F_92E3
			LDX	#F_9C35
			JSR	F_92E3
			LDX	#F_9AC2
			JSR	F_92E3
			JSR	F_9C76
			LDX	#F_9D12
			JSR	F_92E3
			BRA	ZC1D8
ZC1AF			LDX	#F_9E95
			BRA	ZC1D5
ZC1B4			LDX	#F_9EB9
			BRA	ZC1D5
ZC1B9			LDX	#F_9EEC
			BRA	ZC1D5
ZC1BE			LDX	#F_9ECC
			BRA	ZC1D5
ZC1C3			LDX	#F_9E6D
			BRA	ZC1D5
ZC1C8			LDAB	M778C
			CMPB	#$04
			BCS	ZC1D2
			JMP	ZC0E4
ZC1D2			LDX	#F_9F00
ZC1D5			JSR	F_92DB
ZC1D8			LDAA	#$01
			STAA	VOICE_EDITED
ZC1DD			JMP	ZC0E4
ZC1E0			JSR	HI_CALL_18
			JMP	ZC0E4
ZC1E6			LDX	#F_A01B
			JSR	F_92E3
			BRA	ZC1D8
ZC1EE			LDAB	M7789
			BNE	ZC1F8
			JSR	F_E6BD
			BRA	ZC207
ZC1F8			CMPB	#$01
			BEQ	ZC207
			CMPB	#$07
			BHI	ZC1DD
			BEQ	ZC207
			JSR	F_E6BD
			BRA	ZC1DD
ZC207			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAB	M7774
			CMPB	#$0A
			BNE	ZC1DD
			TST	M7789
			BNE	ZC1DD
			JSR	F_E0F3
			BRA	ZC1D8
ZC221			LDX	#F_A049
			JSR	F_92E3
			BRA	ZC1D8
ZC229			LDX	#F_A0D1
			JSR	F_92E3
			LDX	#F_A0F1
			JSR	F_92E3
			BRA	ZC1D8
ZC237			LDX	#F_A100
			JSR	F_92E3
			LDX	#F_A110
			JSR	F_92E3
			BRA	ZC1D8

;-------

F_C245			CLRB
			LDX	#PROG_CHANGES
ZC249			STAB	,X
			INCB
			INX
			CPX	#PROG_CHANGES_END
			BNE	ZC249
			RTS

;-------
;
; unused
;
F_C253			LDAA	PORT2
			COMA
			ANDA	#SW3|SW2|SW1
			RTS

;-------

F_C259			LDAB	M778C
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAB	$02,X
			PSHB
			JSR	F_B164
			JSR	F_AFD9
			PULB
			JSR	F_B787
			JSR	F_B084
			RTS

F_C274			CMPB	#$1E
			BEQ	ZC286
			JSR	HI_CALL_1A
			JSR	F_E111
			CLRA
			STAA	M777B
ZC282			JSR	F_B082
			RTS
ZC286			JSR	F_C291
			JSR	F_E112
			JSR	F_E10F
			BRA	ZC282

F_C291			LDAA	M7780
			STAA	M7773
			CLR	VOICE_COMPARE
			LDAA	#$01
			STAA	VOICE_EDITED
			LDD	#$0101
			STD	OP_ENABLE
			STD	OP_ENABLE + 2
			TST	SYS_CMBIN
			BNE	ZC2B9
			LDAB	#$01
			STAB	SYS_CMBIN
			BSR	F_C2BC
			CLR	SYS_CMBIN
			BRA	ZC2BB
ZC2B9			BSR	F_C2BC
ZC2BB			RTS

F_C2BC			LDX	#M6A19
			JMP	F_B7A2

HI_CALL_1A		LDAB	M7773
			JSR	HI_CALL_19
			CLR	VOICE_COMPARE
			LDAA	#$01
			STAA	VOICE_EDITED
			LDD	#$0101
			STD	OP_ENABLE
			STD	OP_ENABLE + 2
			LDX	#INIT_VOICE
			TST	SYS_CMBIN
			BNE	ZC2EE
			LDAB	#$01
			STAB	SYS_CMBIN
			JSR	F_B7A2
			CLR	SYS_CMBIN
			BRA	ZC2F1
ZC2EE			JSR	F_B7A2
ZC2F1			RTS
HI_CALL_19		TST	VOICE_EDITED
			BEQ	ZC314
			LDAA	M7773
			STAA	M7780
			STAB	M7773
			CLR	VOICE_EDITED
			TST	VOICE_COMPARE
			BNE	ZC313
			LDX	#M6A67
			STX	M00A9
			LDX	#M6A19
			JSR	LO_CALL_06
ZC313			RTS
ZC314			STAB	M7773
			BRA	ZC313
HI_CALL_1B		LDAB	M7773
			JSR	HI_CALL_19
			CLR	VOICE_COMPARE
			JSR	F_AEDD
			STX	M00A9
			LDX	#M6A67
			JSR	LO_CALL_00
			JSR	LO_CALL_08
			JSR	HI_CALL_05
			LDD	#$0101
			STD	OP_ENABLE
			STD	OP_ENABLE + 2
			RTS

F_C33D			LDAB	#$04
			STAB	XROM
			JSR	XROM_CALL
			RTS

F_C345			LDAA	M778F
HI_CALL_02		LDAB	M778A
			JSR	F_969B
			LDAA	M7789
			CMPA	#$03
			BEQ	ZC365
			LDX	#M7F9A
			STX	M00A9
			LDAB	#$18
			LDX	#MICROTUNE_OCT
			JSR	MEMCPY_xB_A9_X
			JMP	ZC406
ZC365			LDX	#M7F9A
			STX	M00A9
			LDX	#MICROTUNE_FULL
			STX	M00A7
			LDAB	#$0C
ZC371			PSHB
			LDX	M00A9
			LDD	,X
			PSHA
			LDAA	M778A
			CMPA	#$09
			PULA
			BCS	ZC389
			BNE	ZC385
			SUBA	#$1E
			BRA	ZC38B
ZC385			SUBA	#$0F
			BRA	ZC38B
ZC389			SUBA	#$3C
ZC38B			INX
			INX
			STX	M00A9
			LDX	M00A7
			STD	,X
			INX
			INX
			STX	M00A7
			PULB
			DECB
			BNE	ZC371
			CLRB
ZC39C			PSHB
			LDAA	#$18
			MUL
			LDX	#MICROTUNE_FULL
			ABX
			STX	M00A9
			LDAB	#$18
			ABX
			STX	M00A7
			PULB
			PSHB
			CMPB	#$09
			BNE	ZC3B5
			LDAB	#$08
			BRA	ZC3B7
ZC3B5			LDAB	#$0C
ZC3B7			PSHB
			LDX	M00A9
			LDD	,X
			PSHA
			LDAA	M778A
			CMPA	#$09
			PULA
			BCS	ZC3CF
			BNE	ZC3CB
			ADDA	#$06
			BRA	ZC3D1
ZC3CB			ADDA	#$03
			BRA	ZC3D1
ZC3CF			ADDA	#$0C
ZC3D1			INX
			INX
			STX	M00A9
			LDX	M00A7
			STD	,X
			INX
			INX
			STX	M00A7
			PULB
			DECB
			BNE	ZC3B7
			PULB
			INCB
			CMPB	#$0A
			BNE	ZC39C
			CLRB
			LDX	#MICROTUNE_FULL
ZC3EB			LDAA	,X
ZC3ED			CMPA	#$0D
			BCC	ZC3F5
			ADDA	#$0C
			BRA	ZC3ED
ZC3F5			CMPA	#$6D
			BCS	ZC3FD
			SUBA	#$0C
			BRA	ZC3F5
ZC3FD			STAA	,X
			INX
			INX
			INCB
			CMPB	#$80
			BNE	ZC3EB
ZC406			RTS

F_C407			LDAA	M7772
			ANDA	#$04
			BEQ	ZC41F
			LDAA	PFM_EDIT_MICTUN
ZC411			CMPA	#$0B
			BCS	ZC43D
			BEQ	ZC41B
			LDAA	#$03
			BRA	ZC442
ZC41B			LDAA	#$06
			BRA	ZC442
ZC41F			LDAA	M7774
			CMPA	#$1C
			BNE	ZC441
			LDAA	M7788
			CMPA	#$02
			BNE	ZC441
			LDAA	M7789
			BEQ	ZC43D
			CMPA	#$02
			BEQ	ZC43D
			LDAA	M778A
			ADDA	#$02
			BRA	ZC411
ZC43D			LDAA	#$0C
			BRA	ZC442
ZC441			CLRA
ZC442			STAA	M7F99
			RTS

LCD_INIT		LDAA	#$38			; A <- LCD Mode Set
			LDX	#$0000
1			DEX				; wait a bit
			BNE	1B			; -
			STAA	LCD_CMD			; send LCD mode set
			LDX	#10000
2			DEX				; wait a bit more
			BNE	2B			; -
			STAA	LCD_CMD			; send it again
			LDX	#10000
3			DEX				; wait a bit more again
			BNE	3B			;-
			STAA	LCD_CMD			; send it again
			JSR	LCD_WAIT		; wait for LCD busy to clear
			STAA	LCD_CMD			; and once more for luck...
			JSR	LCD_WAIT		; and wait for LCD busy to clear
			LDAA	#$0C
			STAA	LCD_CMD
			JSR	LCD_WAIT
			LDAA	#$01
			STAA	LCD_CMD
			JSR	LCD_WAIT
			LDAA	#$06
			STAA	LCD_CMD

			LDAA	#$20			; erase the off screen LCD buffer
			LDX	#LCD_COPY		; -
4			STAA	,X			; -
			INX				; -
			CPX	#LCD_COPY + 32		; -
			BNE	4B			; -

			LDX	#SWITCH_LO		; clear switch state
5			CLR	,X			; why is this a loop just to clear two bytes?!
			INX
			CPX	#SWITCH_LO + 2
			BNE	5B

			JSR	F_C253
			CMPA	#$60
			BNE	6F
			LDAB	#$01
			BRA	8F
6			CMPA	#$A0
			BNE	7F
			LDAB	#$02
			BRA	8F
7			CMPA	#$C0
			BNE	9F
			LDAB	#$03
8			STAB	M00A6
			LSRA
			LSRA
			LSRA
			LSRA
			LSRA
			STAA	SWITCH_LO
			LDX	#S_VERSION
			STX	M00A9
			LDAB	#$10
			LDX	#M7740
			JSR	MEMCPY_xB_A9_X
			BRA	12F
9			JSR	READ_SWITCHES
			CMPB	#$07
			BNE	10F
			JSR	READ_SWITCHES
10			CMPB	#$03
			BNE	12F
			LDAA	#$01
			STAA	M00AD
11			LDX	#S_GOOD_MORNING
			STX	M00A9
			LDAB	#$10
			LDX	#M7740
			JSR	MEMCPY_xB_A9_X
			TST	>M00AD
			BNE	20F
12			JSR	LCD_CLR
			CLRB
13			PSHB
			LSRB
			ANDB	#$03
			LDAA	#$80
14			TSTB
			BEQ	15F
			DECB
			LSRA
			BRA	14B
15			ORAA	#$08
			STAA	PORT6
			PULB
			CMPB	#$10
			BCS	16F
			LDX	#M7740
			PSHB
			SUBB	#$10
			ABX
			PULB
			BRA	17F
16			LDX	#S_YAMAHA_TX81Z
			ABX
17			LDAA	,X
			LDX	#LCD_BUFFER
			ABX
			STX	M00A7
			CMPA	#$20
			BCS	11B
			CMPA	#$80
			BCC	11B
			PSHB
			TAB
			JSR	PUTCHAR
			JSR	LCD_UPDATE
			PULB
			TST	>M00A6
			BNE	19F
			LDX	#$A000
18			DEX
			BNE	18B
19			INCB
			CMPB	#$20
			BNE	13B
			LDAB	#$FF
			JSR	DELAY_B_x_4500
20			JSR	LCD_CLR
			RTS

;-------

F_C548			CLR	M7F99
			CLR	M7788
			CLR	M7789
			CLR	M778A
			CLR	M778C
			TST	VOICE_COMPARE
			BEQ	ZC561
			LDAA	#$01
			STAA	VOICE_EDITED
ZC561			LDAA	M7790
			BEQ	ZC56B
			LDAA	#$FF
			STAA	M7790
ZC56B			LDAA	#$01
			STAA	SYS_MLOCK
			STAA	SYS_CMBIN
			LDAA	#$FF
			STAA	M7794
			STAA	M7795
			LDAA	M7772
			ANDA	#$07
			CMPA	#$03
			BEQ	ZC588
			CMPA	#$07
			BNE	ZC589
ZC588			CLRA
ZC589			STAA	M7772
			CLR	M777D
			LDAA	#$01
			STAA	POLL_ENABLE
			CLR	>M00EF
			JSR	F_C7C2
			LDAA	#$B1
			CMPA	M776D
			BCC	ZC5A4
			STAA	M776D
ZC5A4			CLR	M778B
			LDAA	M778F
			CMPA	#$0C
			BCS	ZC5AF
			CLRA
ZC5AF			STAA	M778F
			JSR	HI_CALL_09
			LDAA	M7779
			CMPA	#$18
			BCS	ZC5BF
			CLR	M7779
ZC5BF			LDAA	M7773
			CMPA	#$A0
			BCS	ZC5C9
			CLR	M7773
ZC5C9			LDAA	M7780
			CMPA	#$A0
			BCS	ZC5D3
			CLR	M7780
ZC5D3			LDAA	M777B
			ANDA	#$03
			STAA	M777B
			LDAA	M7776
			CMPA	#$0B
			BCS	ZC5E5
			CLR	M7776
ZC5E5			LDAA	M7775
			CMPA	#$1F
			BCC	ZC5F0
			CMPA	#$14
			BCC	ZC5F5
ZC5F0			LDAA	#$14
			STAA	M7775
ZC5F5			LDAA	M7778
			CMPA	#$36
			BCC	ZC600
			CMPA	#$28
			BCC	ZC605
ZC600			LDAA	#$28
			STAA	M7778
ZC605			LDAA	M7777
			CMPA	#$3F
			BCC	ZC610
			CMPA	#$3C
			BCC	ZC615
ZC610			LDAA	#$3C
			STAA	M7777
ZC615			JSR	LO_CALL_08
			LDAA	M7774
			TST	>M00A6
			BEQ	ZC629
			LDAA	#$04
			STAA	M7772
			LDAA	#$46
			BRA	ZC64A
ZC629			CMPA	#$46
			BCS	ZC630
			JSR	F_BBBC
ZC630			TST	>M00AD
			BEQ	ZC641
			LDAA	#$FF
			STAA	M7790
			CLR	M7772
			LDAA	#$1F
			BRA	ZC64A
ZC641			LDAA	M7774
			CMPA	#$1F
			BNE	ZC64A
			LDAA	#$14
ZC64A			STAA	M7774
			LDAA	M7772
			BNE	ZC65F
			LDAB	M7774
			CMPB	#$20
			BCC	ZC697
			CMPB	#$14
			BCC	ZC69C
			BRA	ZC697
ZC65F			CMPA	#$01
			BNE	ZC66D
			LDAB	M7774
			CMPB	#$0B
			BCS	ZC69C
			CLRB
			BRA	ZC699
ZC66D			CMPA	#$04
			BNE	ZC684
			LDAB	M7774
			CMPB	#$46
			BEQ	ZC69C
			CMPB	#$3F
			BCC	ZC680
			CMPB	#$3C
			BCC	ZC69C
ZC680			LDAB	#$3C
			BRA	ZC699
ZC684			CMPA	#$05
			BNE	ZC69F
			LDAB	M7774
			CMPB	#$36
			BCC	ZC693
			CMPB	#$28
			BCC	ZC69C
ZC693			LDAB	#$28
			BRA	ZC699
ZC697			LDAB	#$14
ZC699			STAB	M7774
ZC69C			JSR	F_B1DD
ZC69F			JSR	F_C95A
			JSR	F_C972
			RTS

S_YAMAHA_TX81Z		FCC	"* YAMAHA TX81Z *"
			FCB	$00

HI_CALL_09		LDAA	SYS_PBSW
			CMPA	#18
			BCS	ZC6C3
			LDAA	#$01
			STAA	SYS_PBSW
ZC6C3			LDAA	SYS_NOTESW
			CMPA	#$03
			BCS	ZC6CD
			CLR	SYS_NOTESW
ZC6CD			LDAA	SYS_COINF
			CMPA	#$12
			BCS	ZC6D6
			LDAA	#$01
ZC6D6			STAA	SYS_COINF
			LDAA	SYS_SYSAVL
			ANDA	#$01
			STAA	SYS_SYSAVL
			LDAA	SYS_MLOCK
			ANDA	#$01
			STAA	SYS_MLOCK
			LDAA	SYS_CMBIN
			ANDA	#$01
			STAA	SYS_CMBIN
			LDAA	SYS_AT
			ANDA	#$01
			STAA	SYS_AT
			CLRB
ZC6FA			LDX	#M7740
			ABX
			LDAA	,X
			CMPA	#$20
			BCS	ZC708
			CMPA	#$80
			BCS	ZC70C
ZC708			LDAA	#$2A
			STAA	,X
ZC70C			INCB
			CMPB	#$10
			BNE	ZC6FA
			LDAA	SYS_TUNE
			ANDA	#$7F
			STAA	SYS_TUNE
			LDAA	SYS_PCINF
			CMPA	#$03
			BCS	ZC721
			CLRA
ZC721			STAA	SYS_PCINF
			LDAA	SYS_MIDTCH
			ANDA	#$0F
			STAA	SYS_MIDTCH
			LDAA	SYS_MIDBCH
			CMPA	#$11
			BCS	ZC734
			CLRA
ZC734			STAA	SYS_MIDBCH
			CLRB
ZC738			LDX	#EFFECTS_PARAMS
			ABX
			LDAA	,X
			PSHX
			LDX	#MC7BB
			ABX
			CMPA	,X
			PULX
			BLS	ZC74A
			CLR	,X
ZC74A			INCB
			CMPB	#$04
			BNE	ZC738
			CLRB
ZC750			LDX	#EF2D
			ABX
			LDAA	,X
			PSHX
			LDX	#MC7BF
			ABX
			CMPA	,X
			PULX
			BLS	ZC762
			CLR	,X
ZC762			INCB
			CMPB	#$03
			BNE	ZC750
			CLRB
ZC768			LDX	#CHORD
			ABX
			LDAA	,X
			CMPA	#$31
			BLS	ZC774
			CLR	,X
ZC774			INCB
			CMPB	#$30
			BNE	ZC768
			LDX	#PROG_CHANGES
ZC77C			LDAA	,X
			CMPA	#$B8
			BCS	ZC784
			CLR	,X
ZC784			INX
			CPX	#PROG_CHANGES + $80
			BNE	ZC77C
			CLRB
ZC78B			LDX	#MICROTUNE_OCT
			JSR	F_C7A1
			CMPB	#$0C
			BNE	ZC78B
			CLRB
ZC796			LDX	#MICROTUNE_FULL
			JSR	F_C7A1
			CMPB	#$80
			BNE	ZC796
			RTS

F_C7A1			PSHB
			ASLB
			ABX
			LDD	,X
			CMPA	#$0D
			BCC	ZC7AE
			LDAA	#$0D
			BRA	ZC7B4
ZC7AE			CMPA	#$6C
			BLS	ZC7B4
			LDAA	#$6C
ZC7B4			ANDB	#$3F
			STD	,X
			PULB
			INCB
			RTS

MC7BB			FCB	$7F,$30,$07,$63

MC7BF			FCB	$02,$01,$63

F_C7C2			LDAB	#$08
			LDX	#M7D8A
			LDAA	#$80
			BSR	F_C7F8
			LDAB	#$08
			LDX	#M7D5A
			CLRA
			BSR	F_C7F8
			LDAB	#$08
			LDX	#M7D62
			CLRA
			BSR	F_C7F8
			LDAB	#$08
			LDX	#M7D6A
			LDAA	#$FE
			BSR	F_C7F8
			LDAB	#$08
			LDX	#M0048
			LDAA	#$40
			BSR	F_C7F8
			LDAB	#$08
			LDX	#M0050
			CLRA
			BSR	F_C7F8
			BSR	F_C7FF
			RTS

F_C7F8			STAA	,X
			DEX
			DECB
			BNE	F_C7F8
			RTS

F_C7FF			LDAB	M7772
			ANDB	#$04
			BNE	ZC810
			LDAB	#$08
			LDX	#M7D72
			CLRA
			BSR	F_C7F8
			BRA	ZC812
ZC810			BSR	F_C813
ZC812			RTS

F_C813			CLRB
ZC814			BSR	F_C81C
			INCB
			CMPB	#$08
			BNE	ZC814
			RTS

F_C81C			PSHB
			LDX	#PFM_EDIT_BUF
			LDAA	#12
			MUL
			ABX
			LDAA	$08,X
			JSR	MUL_660
			COMA
			LDX	#M7D6B
			PULB
			ABX
			STAA	,X
			RTS

F_C832			LDX	#M7D83
			ABX
			LDAA	#$80
			STAA	,X
			LDX	#M7D53
			ABX
			CLRA
			STAA	,X
			LDX	#M7D5B
			ABX
			CLRA
			STAA	,X
			LDX	#M7D63
			ABX
			LDAA	#$FE
			STAA	,X
			LDX	#M0041
			ABX
			LDAA	#$40
			STAA	,X
			LDX	#M0049
			ABX
			CLRA
			STAA	,X
			JSR	F_C81C
			RTS
			PSHA
			PULA
			PSHA
			PULA
			RTS

;-------

PUTSTR_OFFSET		EQU	$C801		; not used in this bank
			INCLUDE	"inc/lcd.asm"

			INCLUDE "inc/lcd_clr.asm"

;-------

F_C8E9			TST	M7790
			BEQ	ZC8F3
			OIM	#LED1,PORT6
			BRA	ZC8F6
ZC8F3			AIM	#~LED1,PORT6
ZC8F6			LDAB	M7772
			ANDB	#$07

			JSR	JMPOFFB
			FCB	JC907 - *
			FCB	JC920 - *
			FCB	JC939 - *
			FCB	JC906 - *
			FCB	ZC916 - *
			FCB	ZC92F - *
			FCB	JC939 - *
			FCB	JC906 - *

JC906			RTS
JC907			TST	VOICE_COMPARE
			BEQ	ZC916
			TIM	#%00100000,M006E
			BEQ	ZC916
			AIM	#~LED4,PORT6
			BRA	ZC919
ZC916			OIM	#LED4,PORT6
ZC919			AIM	#~LED3,PORT6
			AIM	#~LED2,PORT6
			RTS
JC920			TST	VOICE_COMPARE
			BEQ	ZC92F
			TIM	#%00100000,M006E
			BEQ	ZC92F
			AIM	#~LED3,PORT6
			BRA	ZC932
ZC92F			OIM	#ECMI,PORT6
ZC932			AIM	#~LED4,PORT6
			AIM	#~LED2,PORT6
			RTS
JC939			AIM	#~LED4,PORT6
			AIM	#~LED3,PORT6
			TST	>M00AE
			BNE	ZC949
			OIM	#LED2,PORT6
			BRA	ZC94C
ZC949			AIM	#~LED2,PORT6
ZC94C			RTS

F_C94D			SEI
			SPIN3
			LDAA	#$21
			STAA	M006E
			LDAA	#$02
			STAA	M00AE
			CLI
			RTS

F_C95A			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_15
			OIM	#ECMI,TCSR3
			JSR	F_C407
			JSR	F_C8E9
			LDAB	#$0B
			STAB	>XROM
			JSR	XROM_CALL
			RTS

F_C972			TST	>M009A
			BNE	ZC9DF
			LDAB	M7772
			CMPB	#$02
			BCS	ZC99B
			CMPB	#$04
			BCS	ZC9DF
			CMPB	#$06
			BCS	ZC9A5
			BEQ	ZC993
			CMPB	#$09
			BEQ	ZC990
			CMPB	#$11
			BNE	ZC9DF
ZC990			JMP	ZCB00
ZC993			TST	M7795
			BPL	ZC9DF
			JMP	ZCAB2
ZC99B			TST	M7794
			BPL	ZC9DF
			TST	VOICE_COMPARE
			BNE	ZC9DF
ZC9A5			LDAB	M7774
			LDAA	M7788
			CMPA	#$02
			BCS	ZC9B2
			JMP	ZCB0C

ZC9B2			JSR	JMPOFF1
			FCB	JC9E6 - *
			FCB	$01
			FCB	ZC9DF - *
			FCB	$03
			FCB	JCA00 - *
			FCB	$04
			FCB	JCA3F - *
			FCB	$05
			FCB	ZCA86 - *
			FCB	$07
			FCB	JCA7F - *
			FCB	$08
			FCB	ZCA86 - *
			FCB	$09
			FCB	JCA7F - *
			FCB	$0A
			FCB	JCA95 - *
			FCB	$0B
			FCB	ZC9DF - *
			FCB	$1F
			FCB	JCAAB - *
			FCB	$20
			FCB	ZC9DF - *
			FCB	$29
			FCB	ZCAB2 - *
			FCB	$30
			FCB	JC9E3 - *
			FCB	$31
			FCB	ZCAB2 - *
			FCB	$33
			FCB	JC9E0 - *
			FCB	$34
			FCB	ZC9DF - *
			FCB	$35
			FCB	ZCAA3 - *
			FCB	$36
			FCB	ZC9DF - *
			FCB	$3C
			FCB	ZCAB2 - *
			FCB	$3D
			FCB	ZC9DF - *
			FCB	$00

ZC9DF			RTS
JC9E0			JMP	ZCAEB
JC9E3			JMP	ZCADA
JC9E6			LDAA	M778C
			BNE	ZC9EF
			LDAA	#$C4
			BRA	ZC9F1
ZC9EF			ADDA	#$80
ZC9F1			JSR	LCD_WAIT
			STAA	LCD_CMD
			LDAA	#$0D
ZC9F9			JSR	LCD_WAIT
			STAA	LCD_CMD
			RTS
JCA00			CMPA	#$01
			BNE	ZC9DF
			LDAB	M7789
			BNE	ZCA10
			LDAA	M778C
			BEQ	ZCA3B
			BRA	ZC9EF
ZCA10			CMPB	#$01
			BEQ	ZCA27
ZCA14			LDAA	M778C
			CMPA	#$04
			BCS	ZCA1F
			SUBA	#$03
			BRA	ZC9EF
ZCA1F			LDAB	#$03
			MUL
			ADDB	#$C6
			TBA
			BRA	ZC9F1
ZCA27			LDAA	M778C
			BEQ	ZCA37
			CMPA	#$05
			BCS	ZCA34
			SUBA	#$04
			BRA	ZC9EF
ZCA34			DECA
			BRA	ZCA1F
ZCA37			LDAA	#$C4
			BRA	ZC9F1
ZCA3B			LDAA	#$CE
			BRA	ZC9F1
JCA3F			CMPA	#$01
			BNE	ZC9DF
			LDAB	M7789
			BEQ	ZCA54
			CMPB	#$03
			BEQ	ZCA54
			CMPB	#$06
			BEQ	ZCA54
			CMPB	#$09
			BNE	ZCA5D
ZCA54			LDAA	M778C
			BNE	ZC9EF
			LDAA	#$CD
			BRA	ZC9F1
ZCA5D			LDAA	M778C
			BEQ	ZCA37
			CMPA	#$02
			BCS	ZCA69
			DECA
			BRA	ZC9EF
ZCA69			LDAB	M777B
			LDAA	#$05
			JSR	F_AF64
			TST	$57,X
			BEQ	ZCA7A
			LDAA	#$CD
			JMP	ZC9F1
ZCA7A			LDAA	#$CF
			JMP	ZC9F1
JCA7F			CMPA	#$01
			BEQ	ZCA86
			JMP	ZC9DF
ZCA86			LDAA	M778C
			CMPA	#$04
			BCS	ZCA92
			SUBA	#$03
			JMP	ZC9EF
ZCA92			JMP	ZCA14
JCA95			CMPA	#$01
			BNE	ZCAA0
			LDAB	M7789
			CMPB	#$0F
			BEQ	ZCAA3
ZCAA0			JMP	ZC9DF
ZCAA3			LDAA	M778C
			ADDA	#$C6
ZCAA8			JMP	ZC9F1
JCAAB			LDAA	M778C
			ADDA	#$C0
			BRA	ZCAA8
ZCAB2			LDAA	M778C
ZCAB5			LDAB	#$04
			MUL
			TBA
			CMPA	#$10
			BCS	ZCABF
			SUBA	#$0F
ZCABF			ADDA	#$C2
			LDAB	M7772
			CMPB	#$06
			BEQ	ZCACF
			LDAB	M7774
			CMPB	#$3C
			BNE	ZCAA8
ZCACF			JSR	LCD_WAIT
			STAA	LCD_CMD
			LDAA	#$0E
			JMP	ZC9F9
ZCADA			LDAA	M778C
			LDAB	#$03
			MUL
			TBA
			CMPA	#$0C
			BCS	ZCAE7
			SUBA	#$0B
ZCAE7			ADDA	#$C4
			BRA	ZCAA8
ZCAEB			LDAA	M778C
			BEQ	ZCAFC
			CMPA	#$01
			BNE	ZCAF8
			LDAA	#$8F
			BRA	ZCAFE
ZCAF8			SUBA	#$02
			BRA	ZCAB5
ZCAFC			LDAA	#$8C
ZCAFE			BRA	ZCAA8
ZCB00			LDAB	M0059
			BEQ	ZCB06
			LDAB	#$04
ZCB06			ADDB	#$CA
			TBA
			JMP	ZC9F1
ZCB0C			CMPB	#$1B
			BNE	ZCB1D
			LDAA	M776B
			ANDA	#$08
			BNE	ZCB1A
			JMP	ZCAB2
ZCB1A			JMP	ZC9DF
ZCB1D			CMPB	#$1C
			BNE	ZCB1A
			LDAB	M7789
			ANDB	#$01
			BEQ	ZCB33
			LDAA	#$C0
			TST	M778C
			BEQ	ZCB3C
			LDAA	#$CF
			BRA	ZCB3C
ZCB33			LDAA	#$C6
			TST	M778C
			BEQ	ZCB3C
			ADDA	#$04
ZCB3C			JMP	ZC9F1

;-------

POLL			TST	POLL_ENABLE		; polling gets disabled sometimes
			BEQ	3F			; bug out if so

			TST	>MIDI_RX_ERR		; check for MIDI RX errors
			BEQ	1F			; none?  branch
			JSR	SHOW_RX_ERR		; display the error
			BRA	3F			; bug out

1			TST	>M00CB			; ??
			BEQ	2F
			JSR	F_E6BD

2			LDX	PTR_RX			; check for data in the RX buffer
			CPX	PTR_RX_TAIL
			BNE	4F			; branch to process it
			LDAA	M00B3
			CMPA	#$01
			BCS	_POLL_EXIT
			CLR	>M00B3
			OIM	#ECMI,TCSR3		; enable timer 2 interrupts
3			BRA	_POLL_EXIT

4			LDD	#$0000
			STD	M00B0
			LDAA	,X			; get first byte from RX buffer
			CPX	#MIDI_RXBUF_END - 1	; compare pointer to buffer end
			BNE	5F
			LDX	#MIDI_RXBUF - 1		; reset to (one before) buffer start
5			INX				; inc RX buffer pointer
			STX	PTR_RX			; and save it
			TSTA				; re-examine A
			BPL	11F			; if it's data, branch
			CMPA	#$FE			; is it Active Sense?
			BNE	6F			; no?  branch...
			LDAB	#$01
			STAB	M00AF
			CLR	>M00B2
6			CMPA	#$F8			; >= $F8
			BCC	_POLL_EXIT		; yes?  we're done

7			STAA	MIDI_RX_CMD		; store MIDI command
			CLR	>MIDI_RX_DATA_COUNT
			CMPA	#SYX			; is it a SysEx start
			BEQ	9F			; yes?  branch
			BCC	8F			; > $F0 ? go around...
			ANDA	#$0F			; mask out MIDI channel
			TAB				; store in B
			LDX	#M7F89			; offset into table
			ABX				; -
			LDAA	,X			; get value from table
			STAA	M00DA
8			BRA	POLL			; go around again

							; start of SysEx handling
9			AIM	#~ECMI,TCSR3		; disable timer 2 interrupts
			LDAB	#$01
			STAB	M00B3			; sysex flag?
			BRA	POLL			; go around

10			LDAA	#EOX
			BRA	7B

11			LDAB	MIDI_RX_CMD
			CMPB	#SYX
			BCS	12F
			BHI	POLL			; go around
			TST	SYS_SYSAVL
			BEQ	10B
			JMP	ZD0C8

12			LSRB				; rotate command nybble to bottom half
			LSRB				; -
			LSRB				; -
			LSRB				; -
			ANDB	#$07			; ignore top bit

			JSR	JMPOFF1
			FCB	RX_NOTE_OFF - *		; note off
			FCB	$01
			FCB	RX_NOTE_ON - *		; note on
			FCB	$02
			FCB	_POLL_EXIT - *		; poly aftertouch
			FCB	$03
			FCB	1F - *			; control change
			FCB	$04
			FCB	2F - *			; program change
			FCB	$05
			FCB	3F - *			; channel aftertouch
			FCB	$06
			FCB	4F - *			; pitch bend
			FCB	$07
			FCB	_POLL_EXIT - *		; sysex
			FCB	$00

_POLL_EXIT		RTS

1			JMP	RX_CTL_CHANGE
2			JMP	RX_PGM_CHANGE
3			JMP	RX_AFTERTOUCH
4			JMP	RX_PITCHBEND

;-------

RX_NOTE_OFF		TST	>MIDI_RX_DATA_COUNT
			BNE	1F
			INC	>MIDI_RX_DATA_COUNT
			STAA	MIDI_RX_DATA_1
			JMP	POLL
1			CLR	>MIDI_RX_DATA_COUNT
_TEST_NOTE_OFF		LDAB	SYS_NOTESW		; check MIDI note switch mode
			BEQ	_DO_NOTE_OFF		; 0 -> keep on going
			EORB	MIDI_RX_DATA_1		; xor note number with note mode
			ANDB	#$01			; and look at bit 0
			BEQ	_DO_NOTE_OFF		; same -> keep on going
			JMP	POLL			; otherwise ignore, and go around

_DO_NOTE_OFF		AIM	#~ECMI,TCSR3
			AIM	#~EOCI1,TCSR1
			LDAB	MIDI_RX_DATA_1
			STAB	NOTE_NUMBER_STOP
			LDAA	M00DA
			CLRB
4			LSRA
			BCS	5F
			BEQ	8F
			BRA	7F
5			PSHA
			PSHB
			JSR	F_EA9B
			JSR	F_ECDD
			LDAA	#$04
			STAA	M0058
			JSR	F_EDEA
			BVS	6F
			JSR	NOTE_STOP
6			JSR	F_EE1F
			PULB
			PULA
7			INCB
			BRA	4B
8			OIM	#EOCI1,TCSR1
			OIM	#ECMI,TCSR3
			JMP	POLL

;--------

RX_NOTE_ON		TST	>MIDI_RX_DATA_COUNT
			BNE	1F
			INC	>MIDI_RX_DATA_COUNT
			STAA	MIDI_RX_DATA_1
			JMP	POLL
1			CLR	>MIDI_RX_DATA_COUNT
			TSTA				; check if velocity is zero
			BEQ	_TEST_NOTE_OFF		; if so, treat as a Note Off cmd
			LDAB	SYS_NOTESW		; check MIDI note switch mode
			BEQ	_DO_NOTE_ON		; 0 -> keep on going
			EORB	MIDI_RX_DATA_1		; xor note number with note mode
			ANDB	#$01			; and look at bit 0
			BEQ	_DO_NOTE_ON		; same -> keep on going
			JMP	POLL			; otherwise ignore, and go around

_DO_NOTE_ON		AIM	#~ECMI,TCSR3
			LDAB	M7772
			ANDB	#$03
			CMPB	#$02
			BNE	3F
			LDAB	#$21
			STAB	M006E
			LDAB	#$01
			STAB	M00AE
			AIM	#~LED2,PORT6
3			AIM	#~EOCI1,TCSR1
			AIM	#~IRQ1E,RP5CR
			STAA	NOTE_VELOCITY		; store note velocity
			LDAB	MIDI_RX_DATA_1		; get previous received byte
			STAB	NOTE_NUMBER		; and store it as the note number
			TAB				; and into B
			LDX	#D_VELOCITY_MAP		; and offset into the velocity map table
			ABX				;
			LDAB	,X			;
			STAB	M00F1			; and save the result
			LDAA	M00DA
			CLRB
4			LSRA
			BCS	5F
			BEQ	8F
			BRA	7F
5			PSHA
			PSHB
			JSR	F_EC77
			JSR	F_EA0E
			LDAA	#$04
			STAA	M0058
			JSR	F_ED8F
			BVS	6F
			JSR	NOTE_START
6			PULB
			PULA
7			INCB
			BRA	4B
8			LDAA	M776B
			ANDA	#$02
			BEQ	10F
			TST	M7767
			BNE	10F
			LDAA	#$03
			STAA	M7767
			TST	EF2D
			BNE	9F
			JSR	F_ECFE
9			JSR	F_A68F
			JSR	F_A68F
10			OIM	#IRQ1E,RP5CR
			OIM	#EOCI1,TCSR1
			OIM	#ECMI,TCSR3
			JMP	POLL

;-------

RX_PITCHBEND		TST	>MIDI_RX_DATA_COUNT
			BNE	1F
			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
1			CLR	>MIDI_RX_DATA_COUNT
			TST	SYS_PBSW
			BEQ	9F
			ASLA
			LDX	#M7D83
			AIM	#~ECMI,TCSR3
			LDAB	TCSR1
			PSHB
			AIM	#~EOCI1,TCSR1
			LDAB	M7772
			ANDB	#$04
			BEQ	4F
			TST	PFM_EDIT_ASSIGN
			BEQ	2F
			TST	>M00DA
			BNE	3F
			BRA	8F
2			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			ADDB	#$02
			CMPB	SYS_PBSW
			BNE	4F
3			LDAB	#$FF
			BRA	5F
4			LDAB	M00DA
5			LSRB
			BCS	6F
			BEQ	8F
			BRA	7F
6			STAA	,X
7			INX
			BRA	5B
8			PULB
			STAB	TCSR1
			OIM	#ECMI,TCSR3
9			RTS

;-------

RX_PGM_CHANGE		TST	SYS_PCINF
			BEQ	_PGM_CHGN_EXIT_1
			LDAB	M7772
			CMPB	#$02
			BEQ	1F
			CMPB	#$06
			BNE	_PGM_CHGN_EXIT_1
1			LDAB	SYS_PCINF
			CMPB	#$02
			BEQ	8F
2			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			CMPB	SYS_MIDBCH
			BEQ	3F
			LDAB	SYS_MIDBCH
			CMPB	#$10
			BEQ	3F
			BRA	_PGM_CHGN_EXIT_1	; could be RTS
3			TAB
			LDX	#PROG_CHANGES
			ABX
			LDAB	,X
			LDAA	M7772
			CMPA	#$02
			BNE	5F
			CMPB	#$A0
			BCS	6F
			LDAA	#$01
			STAA	M00CC
			PSHB
			LDAB	#$07
			JSR	F_8A08
			PULB
4			SUBB	#$A0
			LDAA	#$01
			STAA	M00CC
			JSR	F_8A64
			RTS
5			CMPB	#$A0
			BCC	4B
			LDAA	#$01
			STAA	M00CC
			PSHB
			LDAB	#$07
			JSR	F_8A08
			PULB
6			LDAA	#$01
			STAA	M00CC
			JSR	F_8A81
_PGM_CHGN_EXIT_1	RTS

8			LDAB	M7772
			CMPB	#$02
			BEQ	2B
			TAB
			LDX	#PROG_CHANGES
			ABX
			LDAB	,X
			CMPB	#$A0
			BCC	_PGM_CHGN_EXIT_1
			LDAA	M00DA
			CLRB
9			LSRA
			BCS	10F
			BEQ	12F
			BRA	11F
10			PSHA
			PSHB
			PSHX
			LDAA	#$01
			STAA	M00CC
			LDAA	,X
			JSR	F_D052
			PULX
			PULB
			PULA
11			INCB
			BRA	9B
12			JSR	F_C95A
			JSR	F_C972
			RTS

;-------

RX_AFTERTOUCH		TST	SYS_AT
			BNE	1F
			RTS
1			TST	SYS_COINF
			BNE	2F
			RTS
2			ASLA
			LDX	#M7D5B
			JSR	F_D012
			RTS

;-------
;
; MIDI CC processing
;

RX_CTL_CHANGE		TST	>MIDI_RX_DATA_COUNT
			BNE	1F
			INC	>MIDI_RX_DATA_COUNT
			STAA	MIDI_RX_DATA_1
			JMP	POLL
1			CLR	>MIDI_RX_DATA_COUNT
			LDAB	MIDI_RX_DATA_1
			CMPB	#CC_SUSTAIN
			BEQ	2F
			CMPB	#CC_ALL_NOTES_OFF
			BEQ	2F
			CMPB	#CC_MONO_ON
			BEQ	2F
			CMPB	#CC_POLY_ON
			BEQ	2F
			TST	SYS_COINF
			BEQ	3F
			LDAB	MIDI_RX_DATA_1
2			JSR	JMPOFF1
			FCB	3F - *			; <1 : ignore
			FCB	$01
			FCB	RX_CC_MODULATION - *	; <2 : modulation
			FCB	$02
			FCB	RX_CC_BREATH - *	; <3 : breath
			FCB	$03
			FCB	3F - *			; <4 : ignore
			FCB	$04
			FCB	RX_CC_FOOT - *		; <5 : foot
			FCB	$05
			FCB	RX_CC_PORT_TIME - *	; <6 : portamento time
			FCB	$06
			FCB	RX_CC_DATA_ENTRY_MSB- *	; <7 : CC6 - no-op
			FCB	$07
			FCB	RX_CC_VOLUME - *	; <8 : volume
			FCB	$08
			FCB	3F - *			; <10 : ignore
			FCB	$0A
			FCB	6F - *			; <11 : pan
			FCB	$0B
			FCB	3F - *			; <64 : ignore
			FCB	$40
			FCB	RX_CC_SUSTAIN - *	; <65 : sustain
			FCB	$41
			FCB	RX_CC_PORTAMENTO - *	; <66 : portamento
			FCB	$42
			FCB	3F - *			; <96 : ignore
			FCB	$60
			FCB	RX_CC_DATA_ENTRY - *	; <98 : (96, 97) data entry
			FCB	$62
			FCB	3F - *			; <123: ignore
			FCB	$7B
			FCB	RX_CC_ALL_NOTES_OFF - *	; <124: all notes off
			FCB	$7C
			FCB	3F - *			; <126: ignore
			FCB	$7E
			FCB	4F - *			; <127: mono on
			FCB	$7F
			FCB	5F - *			; <128: poly on
			FCB	$80
			FCB	3F - *
			FCB	$00
3			RTS

4			JMP	RX_CC_MONO_ON
5			JMP	RX_CC_POLY_ON
6			JMP	RX_CC_PAN

RX_CC_MODULATION	ASLA
			LDX	#M7D53
			JSR	F_D012
			RTS

RX_CC_BREATH		TST	SYS_AT
			BNE	1F
			ASLA
			LDX	#M7D5B
			JSR	F_D012
1			RTS

RX_CC_FOOT		ASLA
			LDX	#M7D63
			JSR	F_D012
			RTS

RX_CC_VOLUME		ASLA
			COMA
			DECA
			LDX	#M7D6B
			JSR	F_D012
			RTS

RX_CC_PORT_TIME		LDAB	M7772
			ANDB	#$04
			BNE	ZCE9D
			LDAB	SYS_MIDBCH
			CMPB	#$10
			BEQ	ZCE81
			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			CMPB	SYS_MIDBCH
			BNE	ZCE9D
ZCE81			JSR	MUL_200
			CMPA	M6AA9
			BEQ	ZCE9D
			STAA	M6AA9
			LDX	#F_A049
			JSR	F_92E3
ZCE92			LDAA	#$01
			STAA	VOICE_EDITED
			JSR	F_C95A
			JSR	F_C972
ZCE9D			RTS

RX_CC_DATA_ENTRY_MSB	RTS

RX_CC_DATA_ENTRY	RTS

RX_CC_SUSTAIN		AIM	#~ECMI,TCSR3
			LDAB	TCSR1
			PSHB
			AIM	#~EOCI1,TCSR1
			LDX	#M0041
			LDAB	M00DA
			CMPA	#$40
			BCC	ZCECB
			CLRA
ZCEB3			LSRB
			BCS	ZCEBA
			BEQ	ZCEE4
			BRA	ZCEC7
ZCEBA			AIM	#%01111111,$00,X
			PSHX
			PSHB
			PSHA
			TAB
			JSR	F_885F
			PULA
			PULB
			PULX
ZCEC7			INX
			INCA
			BRA	ZCEB3
ZCECB			CLRA
ZCECC			LSRB
			BCS	ZCED3
			BEQ	ZCEE4
			BRA	ZCEE0
ZCED3			OIM	#%10000000,$00,X
			PSHX
			PSHB
			PSHA
			TAB
			JSR	F_885F
			PULA
			PULB
			PULX
ZCEE0			INX
			INCA
			BRA	ZCECC
ZCEE4			PULB
			STAB	TCSR1
			OIM	#ECMI,TCSR3
			RTS

RX_CC_PORTAMENTO	AIM	#~ECMI,TCSR3
			LDAB	TCSR1
			PSHB
			AIM	#~EOCI1,TCSR1
			LDX	#M0041
			LDAB	M7772
			ANDB	#$04
			BEQ	ZCF0D
			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			ADDB	#$02
			CMPB	SYS_COINF
			BNE	ZCF0D
			LDAB	#$FF
			BRA	ZCF0F
ZCF0D			LDAB	M00DA
ZCF0F			LSRB
			BCS	ZCF16
			BEQ	ZCF25
			BRA	ZCF22
ZCF16			CMPA	#$40
			BCC	ZCF1F
			AIM	#%10111111,$00,X
			BRA	ZCF22
ZCF1F			OIM	#%01000000,$00,X
ZCF22			INX
			BRA	ZCF0F
ZCF25			PULB
			STAB	TCSR1
			OIM	#ECMI,TCSR3
			RTS

RX_CC_ALL_NOTES_OFF	AIM	#~ECMI,TCSR3
			AIM	#~EOCI1,TCSR1
			LDAA	M00DA
			CLRB
ZCF35			LSRA
			BCS	ZCF3C
			BEQ	ZCF4B
			BRA	ZCF48
ZCF3C			PSHA
			PSHB
			JSR	F_E78F
			PULB
			PSHB
			JSR	F_E9C9
			PULB
			PULA
ZCF48			INCB
			BRA	ZCF35
ZCF4B			OIM	#EOCI1,TCSR1
			OIM	#ECMI,TCSR3
			RTS

RX_CC_MONO_ON		LDAB	M7772
			ANDB	#$04
			BNE	ZCF83
			LDAB	SYS_MIDBCH
			CMPB	#$10
			BEQ	ZCF69
			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			CMPB	SYS_MIDBCH
			BNE	ZCF83
ZCF69			CMPA	#$01
			BNE	RX_CC_ALL_NOTES_OFF
			TST	M6AA6
			BNE	RX_CC_ALL_NOTES_OFF
			LDAA	#$01
			STAA	M6AA6
ZCF77			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JMP	ZCE92
ZCF83			RTS

RX_CC_POLY_ON		LDAB	M7772
			ANDB	#$04
			BNE	ZCF83
			LDAB	SYS_MIDBCH
			CMPB	#$10
			BEQ	ZCF9B
			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			CMPB	SYS_MIDBCH
			BNE	ZCF83
ZCF9B			TST	M6AA6
			BEQ	RX_CC_ALL_NOTES_OFF
			CLR	M6AA6
			BRA	ZCF77

RX_CC_PAN		AIM	#~ECMI,TCSR3
			LDAB	TCSR1
			PSHB
			AIM	#~EOCI1,TCSR1
			LDAB	M7772
			BITB	#$04
			BEQ	ZD00B
			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			ADDB	#$02
			CMPB	SYS_COINF
			BNE	ZCFC4
			LDAB	#$FF
			BRA	ZCFC6
ZCFC4			LDAB	M00DA
ZCFC6			CMPA	#$56
			BCC	ZCFD2
			CMPA	#$2B
			BCC	ZCFD6
			LDAA	#$01
			BRA	ZCFD8
ZCFD2			LDAA	#$02
			BRA	ZCFD8
ZCFD6			LDAA	#$03
ZCFD8			LDX	#PFM_EDIT_INST_0 + 9	; out assign
			CLR	>M00C0
ZCFDE			LSRB
			BCS	ZCFE5
			BEQ	ZCFF8
			BRA	ZCFF1
ZCFE5			TST	,X
			BEQ	ZCFF1
			CMPA	,X
			BEQ	ZCFF1
			STAA	,X
			STAA	M00C0
ZCFF1			PSHB
			LDAB	#$0C
			ABX
			PULB
			BRA	ZCFDE
ZCFF8			TST	>M00C0
			BEQ	ZD00B
			JSR	F_95E5
			LDAA	#$01
			STAA	PFM_EDITED
			JSR	F_C95A
			JSR	F_C972
ZD00B			PULB
			STAB	TCSR1
			OIM	#ECMI,TCSR3
			RTS

;--------
;
; involved in CC processing
;
F_D012			AIM	#~ECMI,TCSR3		; disable timer 2 interrupts
			LDAB	TCSR1			; save timer 1 state
			PSHB				; -
			AIM	#~EOCI1,TCSR1
			LDAB	M7772
			ANDB	#$04
			BEQ	3F
			TST	PFM_EDIT_ASSIGN
			BEQ	1F
			TST	>M00DA
			BNE	2F
			BRA	7F
1			LDAB	MIDI_RX_CMD
			ANDB	#$0F
			ADDB	#$02
			CMPB	SYS_COINF
			BNE	3F
2			LDAB	#$FF
			BRA	4F
3			LDAB	M00DA
4			LSRB
			BCS	5F
			BEQ	7F
			BRA	6F
5			STAA	,X
6			INX
			BRA	4B
7			PULB				; restore timer 1 state
			STAB	TCSR1			;
			OIM	#ECMI,TCSR3		; enable timer 2 interrupts
			RTS

;-------

F_D052			STAB	M0073
			PSHA
			LDX	#PFM_EDIT_BUF
			LDAB	M0073
			LDAA	#12
			MUL
			ABX
			PULB
			CMPB	$02,X
			BEQ	ZD098
			STAB	$02,X
			LDAA	#$01
			STAA	PFM_EDITED

F_D06A			PSHB
			AIM	#~ECMI,TCSR3
			AIM	#~EOCI1,TCSR1
			LDAB	M0073
			JSR	F_D099
			PULB
			JSR	F_AEE0
			STX	M00A9
			LDAA	M0073
			JSR	F_9A2F
			JSR	LO_CALL_00
			LDAB	M0073
			STAB	M009F
			LDAB	#$0C
			STAB	XROM
			JSR	XROM_CALL
			JSR	F_94C9
			OIM	#EOCI1,TCSR1
			OIM	#ECMI,TCSR3
ZD098			RTS

F_D099			LDAA	TCSR1
			PSHA
			AIM	#~EOCI1,TCSR1
			PSHB
			JSR	F_95A4
			PULB
			PSHB
			LDX	#M0041
			ABX
			AIM	#%01111111,$00,X
			JSR	F_885F
			PULB
			PSHB
			JSR	F_E78F
			PULB
			TSTB
			BNE	ZD0C4
			PSHB
			JSR	HI_CALL_16
			LDAB	#$7C
			STAB	M0058
			PULB
			JSR	F_E821
ZD0C4			PULA
			STAA	TCSR1
			RTS

ZD0C8			LDAB	MIDI_RX_DATA_COUNT
			CMPB	#$FA
			BEQ	ZD0FE
			BCC	ZD101
			CMPB	#$0F
			BCC	ZD0FB
			LDX	#MD0DD
			ASLB
			ABX
			LDX	,X
			JMP	,X

MD0DD			FDB	C_D10B
			FDB	C_D11A
			FDB	C_D148
			FDB	C_D191
			FDB	C_D1A7
			FDB	C_D207
			FDB	C_D256
			FDB	C_D296
			FDB	C_D296
			FDB	C_D296
			FDB	C_D296
			FDB	C_D296
			FDB	C_D296
			FDB	C_D2D6
			FDB	C_D2D6

ZD0FB			JMP	ZD304
ZD0FE			JMP	ZD320
ZD101			JMP	C_D104

C_D104			LDAA	#EOX
			STAA	MIDI_RX_CMD
			JMP	POLL

C_D10B			STAA	MIDI_RX_DATA_1
			CMPA	#$43
			BNE	ZD117
			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD117			JMP	C_D104

C_D11A			TAB
			ANDA	#$F0
			STAA	M00BF
			CMPB	#$10
			BCS	ZD12D
			CMPB	#$20
			BCS	ZD131
			CMPB	#$30
			BCS	ZD131
			BRA	ZD145
ZD12D			LDAA	#$01
			STAA	M00B2
ZD131			LDAA	SYS_MIDBCH
			CMPA	#$10
			BEQ	ZD13F
			ANDB	#$0F
			CMPB	SYS_MIDBCH
			BNE	ZD145
ZD13F			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD145			JMP	C_D104

C_D148			STAA	M00C0
			LDAB	M00BF
			CMPB	#$10
			BCS	ZD16D
			BEQ	ZD17C
			CMPA	#$03
			BNE	ZD15C
			JSR	F_D326
			JMP	C_D104
ZD15C			CMPA	#$04
			BNE	ZD166
			JSR	F_D33D
			JMP	C_D104
ZD166			CMPA	#$7E
			BEQ	ZD18B
			JMP	C_D104
ZD16D			CMPA	#$03
			BEQ	ZD18B
			CMPA	#$04
			BEQ	ZD18B
			CMPA	#$7E
			BEQ	ZD18B
			JMP	C_D104
ZD17C			CMPA	#$10
			BEQ	ZD18B
			CMPA	#$12
			BEQ	ZD18B
			CMPA	#$13
			BEQ	ZD18B
			JMP	C_D104
ZD18B			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL

C_D191			STAA	M00C1
			LDAB	M00BF
			CMPB	#$20
			BCS	ZD1A1
			JSR	F_D3A7
			BCC	ZD1A1
			JMP	C_D104
ZD1A1			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL

C_D1A7			STAA	M00C2
			LDAB	M00BF
			CMPB	#$10
			BCS	ZD1D7
			BEQ	ZD1BF
			JSR	F_D3A7
			BCC	ZD1B9
			JMP	C_D104
ZD1B9			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL

ZD1BF			LDAB	M00C0
			CMPB	#$10
			BNE	ZD1D1
			LDAA	M00C1
			CMPA	#$7B
			BCS	ZD1D1
			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD1D1			JSR	F_D8DD
			JMP	C_D104
ZD1D7			TST	SYS_SYSAVL
			BEQ	ZD1E8
			LDAB	M00C0
			CMPB	#$03
			BEQ	ZD1EB
			CMPB	#$04
			BEQ	ZD1F6
			BRA	ZD201
ZD1E8			JMP	C_D104
ZD1EB			JSR	F_D480
			BCS	ZD1E8
			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD1F6			JSR	F_D4A1
			BCS	ZD1E8
			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD201			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL

C_D207			STAA	>M00C3
			LDAB	M00BF
			CMPB	#$10
			BCS	ZD232
			BEQ	ZD220
			JSR	F_D3A7
			BCC	ZD21A
			JMP	C_D104
ZD21A			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD220			LDAB	M00C1
			CMPB	#$7D
			BCC	ZD22C
			JSR	F_D8DD
			JMP	C_D104
ZD22C			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD232			LDAB	M00C0
			CMPB	#$03
			BEQ	ZD24A
			CMPB	#$04
			BEQ	ZD250
			JSR	F_D3A1
			BCC	ZD244
			JMP	C_D104
ZD244			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD24A			JSR	F_D520
			JMP	POLL
ZD250			JSR	F_D547
			JMP	POLL

;-------

C_D256			LDAB	M00BF
			CMPB	#$10
			BCS	3F
			BEQ	2F
			JSR	F_D3A7
			BCC	1F
			JMP	C_D104
1			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
2			JSR	F_D8DD
			JMP	C_D104
3			LDAB	M00C0
			CMPB	#$03
			BEQ	5F
			CMPB	#$04
			BEQ	6F
			JSR	F_D3A1
			BCC	4F
			JMP	C_D104
4			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
5			JSR	F_D520
			JMP	POLL
6			JSR	F_D547
			JMP	POLL

;-------

C_D296			LDAB	M00BF
			CMPB	#$10
			BCS	ZD2B2
			JSR	F_D3A7
			BVS	ZD2AC
			BCC	ZD2A6
			JMP	C_D104
ZD2A6			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD2AC			JSR	F_D35B
			JMP	C_D104
ZD2B2			LDAB	M00C0
			CMPB	#$03
			BEQ	ZD2CA
			CMPB	#$04
			BEQ	ZD2D0
			JSR	F_D3A1
			BCC	ZD2C4
			JMP	C_D104
ZD2C4			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD2CA			JSR	F_D520
			JMP	POLL
ZD2D0			JSR	F_D547
			JMP	POLL

C_D2D6			LDAB	M00C0
			CMPB	#$03
			BEQ	ZD2F8
			CMPB	#$04
			BEQ	ZD2FE
			JSR	F_D3A1
			BVS	ZD2EA
			BCC	ZD2F2
			JMP	C_D104
ZD2EA			JSR	F_D4C5
			BCC	ZD2F2
			JMP	C_D104
ZD2F2			INC	>MIDI_RX_DATA_COUNT
			JMP	POLL
ZD2F8			JSR	F_D520
			JMP	POLL
ZD2FE			JSR	F_D547
			JMP	POLL
ZD304			LDAB	M00C0
			CMPB	#$03
			BEQ	ZD314
			CMPB	#$04
			BEQ	ZD31A
			JSR	F_D593
			JMP	POLL
ZD314			JSR	F_D520
			JMP	POLL
ZD31A			JSR	F_D547
			JMP	POLL
ZD320			JSR	F_D730
			JMP	C_D104

;-------

F_D326			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAA	#$01
			STAA	M00CC
			JSR	F_DE39
			CLR	>M00CC
			JSR	F_E16B
			RTS

;-------

F_D33D			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAB	#$0C
			JSR	LCD_WAIT
			STAB	LCD_CMD
			CLR	>M00CC
			JSR	F_E11D
			JSR	F_C95A
			JSR	F_C972
			RTS

;-------

F_D35B			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAB	#$0C
			JSR	LCD_WAIT
			STAB	LCD_CMD
			CLR	>M00CC
			LDAB	M00C9
			SUBB	#$78
			ASLB
			LDX	#MD383
			ABX
			LDX	,X
			JSR	,X
			JSR	F_C95A
			JSR	F_C972
			RTS

MD383			FDB	SEND_SYSEX_MCRTE0
			FDB	SEND_SYSEX_MCRTE1
			FDB	SEND_SYSEX_SYS0
			FDB	SEND_SYSEX_SYS1
			FDB	SEND_SYSEX_SYS2
			FDB	SEND_SYSEX_PCED
			FDB	SEND_SYSEX_PMEM
			FDB	F_D393

;-------

F_D393			LDAA	#$01
			STAA	M00CC
			JSR	F_DE39
			CLR	>M00CC
			JSR	F_E178
			RTS

;-------

F_D3A1			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$05
			BRA	1F

F_D3A7			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$03
1			CMPB	#$04
			BCS	2F
			BEQ	4F
			CMPB	#$08
			BCS	7F
			BEQ	11F
			BCC	12F
2			LDX	#S_LM
			ABX
			CMPA	,X
			BNE	3F
			CLC
			CLV
			RTS
3			SEC
			CLV
			RTS
4			CMPA	#$38
			BNE	5F
			CLR	>M00C9
			CLC
			CLV
			RTS
5			CMPA	#$4D
			BNE	6F
			STAA	M00C9
			CLC
			CLV
			RTS
6			SEC
			CLV
			RTS
7			TST	>M00C9
			BNE	9F
			LDX	#S_976
			SUBB	#$05
			ABX
			CMPA	,X
			BNE	8F
			CLC
			CLV
			RTS
8			SEC
			CLV
			RTS
9			LDX	#S_CRT
			SUBB	#$05
			ABX
			CMPA	,X
			BNE	10F
			CLC
			CLV
			RTS
10			SEC
			CLV
			RTS
11			STAA	MIDI_RX_DATA_1
			CLC
			CLV
			RTS
12			TAB
			LDAA	MIDI_RX_DATA_1
			XGDX
			TST	>M00C9
			BNE	19F
			CPX	#$5330
			BNE	13F
			LDAA	#$7A
			STAA	M00C9
			CLC
			SEV
			RTS
13			CPX	#$5331
			BNE	14F
			LDAA	#$7B
			STAA	M00C9
			CLC
			SEV
			RTS
14			CPX	#$5332
			BNE	15F
			LDAA	#$7C
			STAA	M00C9
			CLC
			SEV
			RTS
15			CPX	#$5045
			BNE	16F
			LDAA	#$7D
			STAA	M00C9
			CLC
			SEV
			RTS
16			CPX	#$504D
			BNE	17F
			LDAA	#$7E
			STAA	M00C9
			CLC
			SEV
			RTS
17			CPX	#$4145
			BNE	18F
			LDAA	#$7F
			STAA	M00C9
			CLC
			SEV
			RTS
18			SEC
			CLV
			RTS
19			CPX	#$4530
			BNE	20F
			LDAA	#$78
			STAA	M00C9
			CLC
			SEV
			RTS
20			CPX	#$4531
			BNE	21F
			LDAA	#$79
			STAA	M00C9
			CLC
			SEV
			RTS
21			SEC
			CLV
			RTS

S_LM			FCC	"LM  "
S_976			FCC	"976"
S_CRT			FCC	"CRT"

;-------

F_D480			TST	>M00C1
			BNE	2F
			LDAA	M00C2
			CMPA	#$5D
			BNE	2F
			LDAA	#$03
			STAA	M00C9
			TST	>M00DF
			BNE	1F
			LDAB	M7773
			JSR	HI_CALL_19
1			CLR	>MIDI_RX_CRC
			CLC
			RTS
2			SEC
			RTS

;-------

F_D4A1			TST	SYS_MLOCK
			BEQ	1F
			JSR	F_D879
			BRA	2F
1			LDAA	M00C1
			DECA
			CMPA	#$20
			BCC	2F
			TST	>M00C2
			BNE	2F
			LDAA	#$04
			STAA	M00C9
			CLR	>M00C8
			CLR	>MIDI_RX_CRC
			CLC
			RTS
2			SEC
			RTS

;-------

F_D4C5			LDAB	M00C9
			CMPB	#$7F
			BEQ	1F
			CMPB	#$7D
			BEQ	1F
			CMPB	#$03
			BEQ	1F
			TST	SYS_MLOCK
			BEQ	1F
			JSR	F_D879
			SEC
			RTS
1			SUBB	#$78
			LDX	#D_D508
			ABX
			ASLB
			ABX
			LDAA	M00C1
			LDAB	M00C2
			CMPA	,X
			BNE	3F
			CMPB	$01,X
			BNE	3F
			LDAA	$02,X
			STAA	MIDI_RX_CRC
			LDAB	M00C9
			CMPB	#$7F
			BNE	2F
			LDAB	M7773
			JSR	HI_CALL_19
2			CLR	>M00C8
			CLC
			RTS
3			SEC
			RTS

D_D508			FCB	$00,$22,$84,$02,$0A,$85,$00,$25
			FCB	$3A,$02,$0A,$3B,$00,$41,$3C,$00
			FCB	$78,$4C,$13,$0A,$54,$00,$21,$3D

;-------

F_D520			AIM	#~ECMI,TCSR3
			LDAB	#$01
			STAB	M00B3
			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$05
			CMPB	#$57
			BCC	1F
			LDX	#M6A67
			ABX
			STAA	,X
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$62
			BNE	2F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
2			RTS

;-------

F_D547			AIM	#~ECMI,TCSR3
			LDAB	#$01
			STAB	M00B3
			PSHA
			LDAA	M00C8
			LDAB	#$4E
			MUL
			ADDD	#USER_VOICE
			XGDX
			PULA
			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$05
			CMPB	#$54
			BCC	2F
			CMPB	#$43
			BCS	1F
			CMPB	#$49
			BCS	2F
			SUBB	#$06
1			ABX
			STAA	,X
2			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			INC	>MIDI_RX_DATA_COUNT
			LDAA	MIDI_RX_DATA_COUNT
			CMPA	#$85
			BEQ	3F
			RTS
3			INC	>M00C8
			LDAA	M00C8
			CMPA	M00C1
			BEQ	4F
			CMPA	#$20
			BEQ	4F
			LDAB	#$05
			STAB	MIDI_RX_DATA_COUNT
			RTS
4			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
			RTS

;-------

F_D593			AIM	#~ECMI,TCSR3
			LDAB	#$01
			STAB	M00B3
			LDAB	M00C9
			SUBB	#$78
			LDX	#D_D5A7
			ASLB
			ABX
			LDX	,X
			JMP	,X

D_D5A7			FDB	C_D5B7
			FDB	C_D5D7
			FDB	C_D619
			FDB	C_D64B
			FDB	C_D694
			FDB	C_D6B4
			FDB	C_D6D4
			FDB	C_D710

;-------

C_D5B7			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#$18
			BCC	1F
			LDX	#MICROTUNE_OCT
			ABX
			STAA	,X
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$27
			BNE	2F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
2			RTS

;-------

C_D5D7			TST	>M00C8
			BNE	2F
			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			LDX	#MICROTUNE_FULL
			ABX
			STAA	,X
			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			INC	>MIDI_RX_DATA_COUNT
			LDAA	MIDI_RX_DATA_COUNT
			CMPA	#$8F
			BCC	1F
			RTS
1			LDAA	#$01
			STAA	M00C8
			LDAA	#$0F
			STAA	MIDI_RX_DATA_COUNT
			RTS
2			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			LDX	#MICROTUNE_FULL + $80
			ABX
			STAA	,X
			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			INC	>MIDI_RX_DATA_COUNT
			LDAA	MIDI_RX_DATA_COUNT
			CMPA	#$8F
			BNE	3F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
3			RTS

;-------

C_D619			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#$0B
			BCC	1F
			LDX	#SYS_PARAMS		; save in SYS param table
			ABX
			STAA	,X
			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			INC	>MIDI_RX_DATA_COUNT
			RTS
1			CMPB	#$1B
			BCC	2F
			LDX	#M7735
			ABX
			STAA	,X
2			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$2A
			BNE	3F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
3			RTS

;-------

C_D64B			LDX	#PROG_CHANGES
			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			ABX
			TST	>M00C8
			BNE	3F
			BITA	#$01
			BNE	1F
			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	,X
			ANDA	#$7F
			STAA	,X
			BRA	2F
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	,X
			ORAA	#$80
			STAA	,X
2			COM	>M00C8
			RTS
3			TAB
			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			TBA
			LDAB	,X
			ANDB	#$80
			ABA
			STAA	,X
			COM	>M00C8
			INC	>MIDI_RX_DATA_COUNT
			LDAB	MIDI_RX_DATA_COUNT
			CMPB	#$8F
			BNE	4F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
4			RTS

;-------

C_D694			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#$37
			BCC	1F
			LDX	#EFFECTS_PARAMS
			ABX
			STAA	,X
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$46
			BNE	2F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
2			RTS

;-------

C_D6B4			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#110
			BCC	1F
			LDX	#PFM_EDIT_BUF
			ABX
			STAA	,X
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$7D
			BNE	2F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
2			RTS

;-------

C_D6D4			PSHA
			LDAA	M00C8
			CMPA	#$18
			BCS	1F
			PULA
			BRA	2F
1			LDAB	#$4C
			MUL
			ADDD	#USER_PFM
			XGDX
			PULA
			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#$4C
			BCC	2F
			ABX
			STAA	,X
2			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$5B
			BNE	3F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
			LDAA	M00C8
			INCA
			STAA	M00C8
			CMPA	#$20
			BEQ	3F
			LDAB	#$0F
			STAB	MIDI_RX_DATA_COUNT
3			RTS

;-------

C_D710			LDAB	MIDI_RX_DATA_COUNT
			SUBB	#$0F
			CMPB	#$17
			BCC	1F
			LDX	#M6ABE
			ABX
			STAA	,X
1			ADDA	MIDI_RX_CRC
			STAA	MIDI_RX_CRC
			LDAA	MIDI_RX_DATA_COUNT
			INCA
			STAA	MIDI_RX_DATA_COUNT
			CMPA	#$26
			BNE	2F
			LDAA	#$FA
			STAA	MIDI_RX_DATA_COUNT
2			RTS

;-------

F_D730			CLR	>M00B3
			ADDA	MIDI_RX_CRC
			ANDA	#$7F
			BEQ	1F
			SUBA	#$30
			ANDA	#$7F
			BEQ	1F
			ADDA	#$70
			ANDA	#$7F
			BEQ	1F
			JSR	F_D87E
			RTS
1			LDAB	M00C9
			CMPB	#$03
			BEQ	2F
			CMPB	#$04
			BEQ	3F
			SUBB	#$78
			LDX	#D_D764
			ASLB
			ABX
			LDX	,X
			JMP	,X
2			JMP	5F
3			JMP	9F

D_D764			FDB	C_D7D4
			FDB	C_D7E7
			FDB	C_D7FA
			FDB	C_D80D
			FDB	C_D81D
			FDB	C_D830
			FDB	C_D863
			FDB	C_D874

5			TST	>M00DF
			BNE	6F
			JSR	HI_CALL_12
6			CLR	>M00DF
			JSR	LO_CALL_08
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAA	M7772
			BITA	#$04
			BEQ	7F
			LDX	#M6A67
			STX	M00A9
			LDX	#M69C1
			JSR	LO_CALL_06
			JSR	F_B805
			BRA	8F
7			JSR	F_91FE
8			LDAA	#$01
			STAA	VOICE_EDITED
			CLR	VOICE_COMPARE
			LDD	#$0101
			STD	OP_ENABLE
			STD	OP_ENABLE + 2
			JSR	F_C95A
			JSR	F_C972
			RTS
9			LDAA	M7772
			BITA	#$04
			BNE	10F
			JSR	HI_CALL_1B
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
10			JSR	F_D883
			RTS

;-------

C_D7D4			JSR	HI_CALL_09
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_D8BB
			JSR	F_D883
			RTS

;-------

C_D7E7			JSR	HI_CALL_09
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_D8BB
			JSR	F_D883
			RTS

;-------

C_D7FA			JSR	HI_CALL_09
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_D8BB
			JSR	F_D883
			RTS

;-------

C_D80D			JSR	HI_CALL_09
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_D883
			RTS

;-------

C_D81D			JSR	HI_CALL_09
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	F_D8BB
			JSR	F_D883
			RTS

;-------

C_D830			LDAA	#8			; 8 instruments
			LDAB	#12			; 12 bytes per
			LDX	#PFM_EDIT_BUF		; table base
1			ASL	$02,X			; voice number (MSB -> C)
			ASR	$01,X			;
			ROR	$02,X			; restore voice number
			ABX				; jump to next instrument
			DECA				; -
			BNE	1B			; -
			JSR	LO_CALL_0A
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			LDAA	M7772
			BITA	#$04
			BEQ	2F
			JSR	F_B805
2			LDAA	#$01
			STAA	PFM_EDITED
			JSR	F_C95A
			JSR	F_C972
			RTS

;-------

C_D863			LDAA	M7772
			BITA	#$04
			BEQ	1F
			LDAB	M7779
			JSR	F_B7D6
1			JSR	F_D883
			RTS

;-------

C_D874			LDAA	#$01
			STAA	M00DF
			RTS

;-------

F_D879			LDX	#S_MEM_PROTECTED
			BRA	4F

F_D87E			LDX	#S_MIDI_CSUM_ERROR
			BRA	4F

F_D883			JSR	F_C95A
			LDX	#S_MIDI_RECEIVED

4			JSR	LCD_OUT
			LDAA	#$0C
			JSR	LCD_WAIT
			STAA	LCD_CMD
			LDAA	#$01
			STAA	M0057
			RTS

S_MIDI_RECEIVED		FCC	" Midi Received  "
			FCB	$00

S_MIDI_CSUM_ERROR	FCC	"Midi CSUM Error "
			FCB	$00

;-------

F_D8BB			JSR	HI_CALL_0F
			JSR	HI_CALL_18
			JSR	HI_CALL_11
			AIM	#~ECMI,TCSR3
			JSR	HI_CALL_15
			JSR	HI_CALL_16
			OIM	#ECMI,TCSR3
			RTS

;-------

HI_CALL_12		LDX	#M6ABE
1			CLR	,X
			INX
			CPX	#M6AD5
			BNE	1B
			RTS

;-------

F_D8DD			STAA	MIDI_RX_DATA_1
			LDAB	M00C1
			LDAA	M00C0
			CMPA	#$10
			BEQ	5F
			CMPA	#$12
			BEQ	3F
			CMPB	#$17
			BCC	1F
			JSR	F_D93E
			RTS
1			CMPB	#$40
			BCS	2F
			CMPB	#$4C
			BCC	2F
			JSR	F_DF29
			RTS				; merge these
2			RTS
3			CMPB	#$57
			BCS	4F
			CMPB	#$5D
			BEQ	4F
			RTS
4			JSR	F_DA3F
			RTS
5			CMPB	#$6E
			BCC	6F
			JSR	F_DBBD
			RTS
6			CMPB	#$7B
			BNE	7F
			JSR	F_DC7F
			RTS
7			CMPB	#$7C
			BNE	8F
			JSR	F_DD1C
			RTS
8			CMPB	#$7D
			BNE	9F
			JSR	F_DD7E
			RTS
9			CMPB	#$7E
			BNE	10F
			JSR	F_DDAC
			RTS
10			CMPB	#$7F
			BNE	11F
			JSR	F_DCF6
			RTS				; merge these
11			RTS

;-------

F_D93E			PSHB
			JSR	F_DE08
			PULB
			CMPB	#$13
			BCS	1F
			JMP	C_DA05
1			CMPB	#$05
			BCS	2F
			CMPB	#$0A
			BCS	3F
			CMPB	#$0F
			BCS	4F
			BRA	5F
2			LDAA	#$03
			STAA	M778C
			BRA	6F
3			SUBB	#$05
			LDAA	#$01
			STAA	M778C
			BRA	6F
4			SUBB	#$0A
			LDAA	#$02
			STAA	M778C
			BRA	6F
5			SUBB	#$0F
			CLR	M778C
6			LDX	#D_D97F
			ASLB
			ABX
			LDX	,X
			JMP	,X

D_D97F			FDB	C_D989
			FDB	C_D9A6
			FDB	C_D9C2
			FDB	C_D9E2
			FDB	C_D9F0

C_D989			LDAA	#$01
			STAA	M7788
			LDAA	#$04
			STAA	M7774
			LDAA	#$03
			LDAB	M778C
			MUL
			INCB
			STAB	M7789
			CLR	M778C
			LDAA	M00C2
			JSR	F_DE9D
			RTS

;-------

C_D9A6			LDAA	#$01
			STAA	M7788
			LDAA	#$04
			STAA	M7774
			LDAA	#$03
			LDAB	M778C
			MUL
			STAB	M7789
			CLR	M778C
			LDAA	M00C2
			JSR	F_DE9D
			RTS

;-------

C_D9C2			LDAA	#$01
			STAA	M7788
			LDAA	#$04
			STAA	M7774
			LDAA	#$03
			LDAB	M778C
			MUL
			INCB
			INCB
			STAB	M7789
			LDAA	#$01
			STAA	M778C
			LDAA	M00C2
			JSR	F_DE9D
			RTS

;-------

C_D9E2			CLR	M7788
			LDAA	#$05
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE96
			RTS

;-------

C_D9F0			LDAA	#$01
			STAA	M7788
			LDAA	#$07
			STAA	M7774
			LDAA	#$05
			STAA	M7789
			LDAA	M00C2
			JSR	F_DE9D
			RTS

;--------

C_DA05			CMPB	#$13
			BNE	1F
			RTS
1			CMPB	#$14
			BEQ	2F
			CMPB	#$15
			BEQ	3F
			CMPB	#$16
			BEQ	4F
			RTS
2			LDAA	#$0E
			STAA	M7789
			BRA	5F
3			LDAA	#$05
			STAA	M7789
			BRA	5F
4			LDAA	#$06
			STAA	M7789
			BRA	5F			; no-op jump
5			LDAA	#$01
			STAA	M7788
			CLR	M778C
			LDAA	#$0A
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE9D
			RTS

;-------

F_DA3F			PSHB
			JSR	F_DE08
			PULB
			CMPB	#$34
			BCS	1F
			JMP	11F
1			CMPB	#$0D
			BCS	2F
			CMPB	#$1A
			BCS	3F
			CMPB	#$27
			BCS	4F
			BRA	5F
2			LDAA	#$03
			STAA	M778C
			BRA	6F
3			SUBB	#$0D
			LDAA	#$01
			STAA	M778C
			BRA	6F
4			SUBB	#$1A
			LDAA	#$02
			STAA	M778C
			BRA	6F
5			SUBB	#$27
			CLR	M778C
6			CMPB	#$0A
			BNE	7F
			CLR	M7788
			LDAA	#$08
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE96
			RTS
7			CMPB	#$0C
			BNE	8F
			CLR	M7788
			LDAA	#$06
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE96
			RTS
8			CMPB	#$0B
			BNE	9F
			LDAA	#$01
			STAA	M7788
			LDAA	#$04
			STAA	M7774
			LDAA	M778C
			LDAB	#$03
			MUL
			INCB
			STAB	M7789
			LDAA	#$01
			STAA	M778C
			LDAA	M00C2
			JSR	F_DE9D
			RTS
9			CMPB	#$08
			BNE	10F
			INC	M778C
10			LDX	#D_DB7B
			ASLB
			ABX
			LDAA	,X
			STAA	M7774
			LDAA	$01,X
			STAA	M7789
			LDAA	#$01
			STAA	M7788
			LDAA	M00C2
			JSR	F_DE9D
			RTS
11			CMPB	#$5D
			BEQ	15F
			CMPB	#$57
			BCC	12F
			CMPB	#$36
			BCC	13F
			CLR	M7788
			SUBB	#$34
			STAB	M7774
			CLR	M778C
			LDAA	M00C2
			JSR	F_DE96
12			RTS
13			CMPB	#$44
			BEQ	12B
			CMPB	#$45
			BEQ	12B
			CMPB	#$46
			BEQ	12B
			CMPB	#$4D
			BCS	14F
			TBA
			SUBA	#$4D
			STAA	M778C
			LDAA	#$01
			STAA	M7788
			LDAA	#$0A
			STAA	M7774
			LDAA	#$0F
			STAA	M7789
			LDAA	M00C2
			JSR	F_DE9D
			RTS
14			SUBB	#$36
			ASLB
			LDX	#D_DB8F
			ABX
			LDAA	,X
			STAA	M7774
			LDAA	$01,X
			STAA	M7789
			LDAA	#$01
			STAA	M7788
			CLR	M778C
			LDAA	M00C2
			JSR	F_DE9D
			RTS
15			CLR	OP_ENABLE
			CLR	OP_ENABLE + 1
			CLR	OP_ENABLE + 2
			CLR	OP_ENABLE + 3
			LDAA	M00C2
			LSRA
			ROL	OP_ENABLE + 3
			LSRA
			ROL	OP_ENABLE + 2
			LSRA
			ROL	OP_ENABLE + 1
			LSRA
			ROL	OP_ENABLE
			LDAA	#$01
			STAA	M778C
			CLR	M7788
			CLR	M7774
			CLRB
			JSR	F_B1DD
			JSR	F_C95A
			JSR	F_C972
			RTS
			RTS

D_DB7B			FCB	$07,$00,$07,$01,$07,$03,$07,$04
			FCB	$07,$02,$09,$01,$09,$00,$03,$02
			FCB	$03,$01,$03,$03

D_DB8F			FCB	$02,$01,$02,$02,$02,$03,$02,$04
			FCB	$02,$05,$02,$00,$03,$00,$03,$01
			FCB	$0A,$0D,$0A,$00,$0A,$01,$0A,$02
			FCB	$0A,$03,$0A,$04,$00,$00,$00,$00
			FCB	$00,$00,$0A,$07,$0A,$08,$0A,$09
			FCB	$0A,$0A,$0A,$0B,$0A,$0C

;-------

F_DBBD			PSHB
			JSR	F_DE65
			PULB
			CMPB	#$60
			BCS	1F
			JMP	C_DC24
1			CLRA
2			SUBB	#$0C
			BCS	3F
			INCA
			BRA	2B
3			ADDB	#$0C
			STAA	M778C
			CMPB	#$0B
			BNE	4F
			INC	M778C
			INC	M778C
4			CMPB	#$01
			BNE	7F
			PSHB
			LDAB	M00C2
			BNE	5F
			CLRB
			BRA	6F
5			LDAB	#$80
6			STAB	M00C2
			PULB
7			CMPB	#$02
			BNE	8F
			PSHB
			LDAB	M00C1
			LDX	#PFM_EDIT_BUF
			ABX
			LDAB	,X
			LDAA	M00C2
			ANDB	#$80
			ABA
			STAA	M00C2
			PULB
8			CLR	M7788
			LDX	#D_DC18
			ABX
			LDAA	,X
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE96
			RTS

D_DC18			FCB	$29,$2A,$2A,$2B,$2C,$2D,$2E,$2F
			FCB	$30,$31,$32,$33

;-------

C_DC24			CMPB	#$64
			BCC	6F
			CMPB	#$60
			BEQ	1F
			CMPB	#$61
			BEQ	2F
			CMPB	#$62
			BEQ	3F
			BRA	4F
1			CLR	M778C
			LDAA	#$33
			STAA	M7774
			BRA	5F
2			LDAA	#$28
			STAA	M7774
			CLR	M778C
			BRA	5F
3			LDAA	#$34
			STAA	M7774
			CLR	M778C
			BRA	5F
4			LDAA	#$33
			STAA	M7774
			LDAA	#$01
			STAA	M778C
5			CLR	M7788
			LDAA	M00C2
			JSR	F_DE96
			RTS
6			CMPB	#$6E
			BCS	7F
			RTS
7			SUBB	#$64
			STAB	M778C
			CLR	M7788
			LDAA	#$35
			STAA	M7774
			LDAA	M00C2
			JSR	F_DE96
			RTS

;-------

F_DC7F			LDAB	M00C2
			CMPB	#$1B
			BCS	1F
			RTS
1			PSHB
			JSR	F_DDD7
			PULB
			CMPB	#$0B
			BCS	2F
			JMP	C_DCE2
2			CLR	M778C
			TSTB
			BNE	3F
			LDAA	#$14
			STAA	M7774
			BRA	5F
3			CMPB	#$08
			BNE	4F
			LDAA	#$16
			STAA	M7774
			BRA	5F
4			CMPB	#$09
			BNE	6F
			LDAA	#$17
			STAA	M7774
5			CLR	M7788
			LDAA	>M00C3
			JSR	F_DE96
			RTS
6			DECB
			LDAA	#$01
			STAA	M7788
			LDAA	#$15
			STAA	M7774
			LDX	#D_DCD8
			ABX
			LDAA	,X
			STAA	M7789
			LDAA	>M00C3
			JSR	F_DE9D
			RTS

D_DCD8			FCB	$00,$01,$02,$03,$05,$06,$07,$00,$00,$04

;-------

C_DCE2			SUBB	#$0B
			STAB	M778C
			CLR	M7788
			LDAA	#$1F
			STAA	M7774
			LDAA	>M00C3
			JSR	F_DE96
			RTS

;-------

F_DCF6			JSR	F_DDD7
			LDAA	#$02
			STAA	M7788
			LDAA	#$15
			STAA	M7774
			CLR	M778C
			LDAA	#$0C
			STAA	M7789
			LDAA	M00C2
			STAA	M778A
			LDAA	>M00C3
			LDAB	MIDI_RX_DATA_1
			ASLB
			LSRD
			TBA
			JSR	F_DEC9
			RTS

;-------

F_DD1C			LDAB	M00C2
			CMPB	#$37
			BCS	1F
			RTS
1			JSR	F_DDD7
			LDAB	M00C2
			CMPB	#$07
			BCC	2F
			LDAA	#$01
			STAA	M7788
			LDX	#M_DD4A
			ASLB
			ABX
			LDAA	,X
			STAA	M7774
			LDAA	$01,X
			STAA	M7789
			CLR	M778C
			LDAA	>M00C3
			JSR	F_DE9D
			RTS

M_DD4A			FCB	$19,$00,$19,$01,$19,$02,$19,$03
			FCB	$1A,$01,$1A,$00,$1A,$02

2			LDAA	#$02
			STAA	M7788
			LDAA	#$1B
			STAA	M7774
			CLR	M778A
			SUBB	#$07
			CLRA
3			SUBB	#$04
			BCS	4F
			INCA
			BRA	3B
4			ADDB	#$04
			STAA	M7789
			STAB	M778C
			LDAA	>M00C3
			JSR	F_DEC9
			RTS

;-------

F_DD7E			JSR	F_DDD7
			LDAB	M00C2
			CMPB	#$0C
			BCS	1F
			RTS
1			LDAA	#$02
			STAA	M7788
			LDAA	#$1C
			STAA	M7774
			CLR	M7789
			STAB	M778A
			CLR	M778C
			LDAA	>M00C3
			JSR	F_DEC9
			LDAA	#$01
			STAA	M778C
			LDAA	MIDI_RX_DATA_1
			JSR	F_DEC9
			RTS

;-------

F_DDAC			JSR	F_DDD7
			LDAA	#$02
			STAA	M7788
			LDAA	#$1C
			STAA	M7774
			LDAA	#$02
			STAA	M7789
			LDAA	M00C2
			STAA	M778A
			CLR	M778C
			LDAA	>M00C3
			JSR	F_DEC9
			LDAA	#$01
			STAA	M778C
			LDAA	MIDI_RX_DATA_1
			JSR	F_DEC9
			RTS

;------

F_DDD7			LDAB	M7772
			ANDB	#$07
			STAB	M7772
			LDX	#MDDE8
			ASLB
			ABX
			LDX	,X
			JMP	,X

MDDE8			FDB	C_DE07
			FDB	C_DE02
			FDB	C_DE02
			FDB	C_DE07
			FDB	C_DDF8
			FDB	C_DDF8
			FDB	C_DDFD
			FDB	C_DE07

C_DDF8			LDAB	#$07
			JSR	F_8A08

C_DDFD			LDAB	#$07
			JSR	F_8A08

C_DE02			LDAB	#$05
			JSR	F_8A08

C_DE07			RTS

;-------

F_DE08			LDAB	M7772
			ANDB	#$07
			STAB	M7772
			LDX	#MDE19
			ASLB
			ABX
			LDX	,X
			JMP	,X

MDE19			FDB	C_DE33
			FDB	C_DE38
			FDB	C_DE33
			FDB	C_DE38
			FDB	C_DE29
			FDB	C_DE29
			FDB	C_DE2E
			FDB	C_DE38

C_DE29			LDAB	#$07
			JSR	F_8A08

C_DE2E			LDAB	#$07
			JSR	F_8A08

C_DE33			LDAB	#$06
			JSR	F_8A08

C_DE38			RTS

;-------

F_DE39			LDAB	M7772
			ANDB	#$07
			STAB	M7772
			LDX	#MDE4A
			ASLB
			ABX
			LDX	,X
			JMP	,X

MDE4A			FDB	C_DE64
			FDB	C_DE64
			FDB	C_DE64
			FDB	C_DE64
			FDB	C_DE5A
			FDB	C_DE5A
			FDB	C_DE5F
			FDB	C_DE64

C_DE5A			LDAB	#$07
			JSR	F_8A08

C_DE5F			LDAB	#$07
			JSR	F_8A08

C_DE64			RTS

;-------

F_DE65			LDAB	M7772
			ANDB	#$07
			STAB	M7772
			LDX	#MDE76
			ASLB
			ABX
			LDX	,X
			JMP	,X

MDE76			FDB	C_DE86
			FDB	C_DE86
			FDB	C_DE8B
			FDB	C_DE95
			FDB	C_DE90
			FDB	C_DE95
			FDB	C_DE90
			FDB	C_DE95

C_DE86			LDAB	#$07
			JSR	F_8A08

C_DE8B			LDAB	#$07
			JSR	F_8A08

C_DE90			LDAB	#$06
			JSR	F_8A08

C_DE95			RTS

;-------

F_DE96			CLR	M7788
			JSR	F_DF0D
			RTS

;-------

F_DE9D			PSHA
			LDAB	M778C
			PSHB
			LDAB	M7789
			PSHB
			CLR	M7788
			CLR	M778C
			LDAB	M7774
			JSR	F_B1DD
			LDAB	#$01
			JSR	F_B931
			PULB
			STAB	M7789
			PULB
			STAB	M778C
			LDAA	#$01
			STAA	M7788
			PULA
			JSR	F_DF0D
			RTS

;-------

F_DEC9			PSHA
			LDAB	M778A
			PSHB
			LDAB	M778C
			PSHB
			LDAB	M7789
			PSHB
			CLR	M7788
			CLR	M778C
			LDAB	M7774
			JSR	F_B1DD
			LDAB	#$01
			JSR	F_B931
			PULB
			STAB	M7789
			LDAA	#$01
			STAA	M7788
			LDAB	M7774
			JSR	F_B1DD
			LDAB	#$01
			JSR	F_B931
			PULB
			STAB	M778C
			PULB
			STAB	M778A
			LDAB	#$02
			STAB	M7788
			PULA
			JSR	F_DF0D
			RTS

;-------

F_DF0D			PSHA
			LDAB	M7774
			JSR	F_B1DD
			PULA
			CMPA	M7783
			BLS	1F
			BRA	2F
1			LDX	M7781
			JSR	F_BE61
2			JSR	F_C95A
			JSR	F_C972
			RTS

;-------

F_DF29			CLR	>M00CC
			LDAA	M00C2
			LDAB	M00C1
			CMPB	#$41
			BEQ	6F
			CMPB	#$49
			BEQ	8F
			CMPB	#$4A
			BEQ	10F
			CMPA	#$40
			BCC	1F
			JMP	13F			; RTS
1			CMPB	#$40
			BNE	2F
			JMP	hdlr_RST
2			BCC	3F
			JMP	13F			; RTS
3			CMPB	#$4C
			BCS	4F
			JMP	13F			; RTS
4			SUBB	#$40
			LDX	#MDF87
			ABX
			LDAB	,X
5			JSR	F_8A08
			BRA	13F			; RTS
6			CMPA	#$40
			BCC	7F
			LDAB	#$04
			BRA	5B
7			LDAB	#$03
			BRA	5B
8			CMPA	#$40
			BCC	9F
			LDAB	#$0D
			BRA	5B
9			LDAB	#$0A
			BRA	5B
10			CMPA	#$40
			BCC	11F
			LDAB	#$0E
			BRA	5B
11			LDAB	#$0B
			BRA	5B

MDF87			FCB	$00,$00,$05,$06,$07,$08,$09,$02
			FCB	$01,$00,$00,$0C

13			RTS

D_VELOCITY_MAP		FCB	$FE,$C0,$B4,$AE,$A8,$A2,$9E,$98
			FCB	$94,$90,$8D,$8A,$86,$82,$80,$7D
			FCB	$7A,$77,$74,$72,$70,$6D,$6B,$69
			FCB	$67,$65,$63,$61,$5F,$5D,$5C,$5A
			FCB	$58,$56,$55,$53,$52,$51,$4F,$4E
			FCB	$4C,$4B,$4A,$48,$47,$46,$44,$43
			FCB	$42,$41,$40,$3F,$3E,$3C,$3B,$3A
			FCB	$39,$38,$37,$36,$35,$34,$32,$31
			FCB	$30,$2F,$2E,$2D,$2C,$2B,$2A,$29
			FCB	$28,$27,$26,$25,$24,$23,$22,$21
			FCB	$20,$1F,$1E,$1D,$1C,$1B,$1A,$1A
			FCB	$19,$18,$17,$16,$16,$15,$14,$13
			FCB	$12,$12,$11,$10,$10,$0F,$0E,$0E
			FCB	$0D,$0C,$0C,$0B,$0B,$0A,$09,$09
			FCB	$08,$07,$07,$06,$06,$05,$05,$04
			FCB	$04,$03,$03,$02,$02,$01,$01,$00

;-------
;
; Serial interrupt handler
;
SIO			LDAA	XROM			; remember XROM state
			PSHA

			LDAA	TRCSR			; get SIO status
			ASLA				; RDRF -> C
			BCS	_SIO_RX			;
			ASLA				; ORFE -> C, TDRE -> N
			BCS	_SIO_OVERRUN
			BMI	_SIO_TX			;
			BRA	_SIO_EXIT

_SIO_RX			LDAA	RDR			; read received data
			LDX	PTR_RX_TAIL		; store at end of ring buffer
			STAA	,X			; -
			INX				; calc next position
			CPX	#MIDI_RXBUF_END		; check for buffer end
			BNE	1F
			LDX	#MIDI_RXBUF		; go to buffer start
1			CPX	PTR_RX			; check for RX buffer overflow
			BEQ	_SIO_RX_FULL
			STX	PTR_RX_TAIL		; save the pointer
			BRA	_SIO_EXIT		; and we're done

_SIO_RX_FULL		LDAA	#$01			; handle input buffer overflow
			STAA	MIDI_RX_ERR
			JSR	MIDI_INIT_RX
			BRA	_SIO_EXIT

_SIO_TX			LDX	PTR_TX			; check if there's anything to send
			CPX	PTR_TX_TAIL		; -
			BEQ	_SIO_TX_DONE		; nope?  done...
			LDAA	,X			; get the next TX byte
			BPL	3F			; branch if it's MIDI data
			CMPA	#SYX			; SysEx?
			BEQ	2F
			CMPA	#SENSE			; Active Sense?
			BEQ	2F
2			STAA	MIDI_TX_CMD		; TX running status - not used
3			STAA	TDR			; transmit the data
			INX				; calc next position
			CPX	#MIDI_RXBUF		; check for buffer end
			BNE	4F
			LDX	#MIDI_TXBUF		; wrap to beginning of buffer
4			STX	PTR_TX			; save the pointer
			BRA	_SIO_EXIT

_SIO_TX_DONE		LDAA	#TDRE|RIE|RE|TE		; reset TRCSR (no TX IRQ)
			STAA	TRCSR
			BRA	_SIO_EXIT

_SIO_OVERRUN		LDAA	#$02			; handle input overrun
			STAA	MIDI_RX_ERR
			JSR	MIDI_INIT_RX
			LDAA	RDR			; flush RDR

_SIO_EXIT		PULA				; restore XROM state
			STAA	XROM			;
			RTS

;-------

MIDI_INIT		LDAA	#CC011|SS000		; CC = %011, SS = %000
			STAA	RMCR			; rate = E / 16 (500k / 16 = 31250)
			LDAA	#TDRE|RIE|RE|TE		; reset TRCSR (no TX IRQ)
			STAA	TRCSR			; -
			LDAA	TRCSR			; clear IRQ flags
			LDAA	RDR			; clear receive data register
			LDX	#MIDI_TXBUF		; clear MIDI TX buffer
			STX	PTR_TX_TAIL		; -
			STX	PTR_TX			; -
			LDAA	#EOX			; pretend last command was EOX
			STAA	MIDI_RX_CMD		;
			LDX	#MIDI_RXBUF		; clear MIDI RX buffer
			STX	PTR_RX_TAIL		; -
			STX	PTR_RX			; -
			RTS

;-------

MIDI_INIT_RX		LDAA	#EOX
			STAA	MIDI_RX_CMD
			LDX	#MIDI_RXBUF
			STX	PTR_RX_TAIL
			STX	PTR_RX
			RTS

;-------

MIDI_SEND_PGM_CNG	TST	SYS_PCINF
			BEQ	1F
			TST	SYS_SYSAVL
			BNE	1F
			TST	>M00CC
			BNE	1F
			LDAA	SYS_MIDTCH
			ORAA	#$C0
			JSR	MIDI_SEND
			TBA
			ANDA	#$7F
			JSR	MIDI_SEND
1			RTS

;-------
;
; NO-OP
;
; B = CC number
; A = CC value (0 .. 255 - LSB ignored)
;

MIDI_SEND_CC		RTS
			PSHA
			CMPB	#CC_SUSTAIN
			BEQ	1F
			CMPB	#CC_MONO_ON
			BEQ	1F
			CMPB	#CC_POLY_ON
			BEQ	1F
			TST	SYS_COINF
			BEQ	2F
1			LDAA	SYS_MIDTCH
			ORAA	#$B0			; $Bx = MIDI CC
			JSR	MIDI_SEND
			TBA
			JSR	MIDI_SEND
			PULA
			LSRA
			JSR	MIDI_SEND
			RTS
2			PULA
			RTS

;-------

F_E0E9			RTS
			PSHB
			ADDB	#$5F
			LDAA	#$FF
			BSR	MIDI_SEND_CC
			PULB
			RTS

;-------

F_E0F3			RTS
			TST	M6AA6
			BEQ	1F
			LDAB	#$7E
			LDAA	#$02
			BRA	2F
1			LDAB	#$7F
			CLRA
2			JMP	MIDI_SEND_CC

;-------

MIDI_SEND_SENSE		RTS
			LDAA	#SENSE
			JSR	MIDI_SEND
			RTS

;-------

F_E10C			RTS
			RTS

F_E10E			RTS

F_E10F			RTS

F_E110			RTS

F_E111			RTS

F_E112			RTS

F_E113			RTS

F_E114			RTS

F_E115			RTS

HI_CALL_06		RTS

HI_CALL_0D		RTS

HI_CALL_04		RTS

HI_CALL_0A		RTS

			RTS
			RTS
			RTS

;-------

F_E11D			TST	SYS_SYSAVL
			BEQ	2F
			TST	>M00CC
			BNE	2F
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			CLR	>M00C7
			JSR	HI_CALL_0E
1			LDAA	M00C7
			LDAB	#$4E
			MUL
			ADDD	#USER_VOICE
			XGDX
			JSR	MIDI_SEND_VOICE
			LDAB	M00C7
			INCB
			STAB	M00C7
			CMPB	#$20
			BNE	1B
			JSR	MIDI_SEND_EOX
2			RTS

S_TRANSMITTING		FCC	"Transmitting!!  "
			FCB	$00

;-------

F_E16B			TST	SYS_SYSAVL
			BEQ	3F
			TST	>M00CC
			BNE	3F
			JMP	8F

;-------

F_E178			TST	SYS_SYSAVL
			BEQ	3F
			TST	>M00CC
			BEQ	4F
3			JMP	15F			; could be RTS

4			CLRB
5			LDX	#S_SYSEX_SCED
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$02
			BCS	5B
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
6			LDX	#S_SYSEX_SCED
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0F
			BCS	6B
			LDAA	#$3D
			STAA	MIDI_TX_CRC
			LDX	#M6ABE
7			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M6AD5
			BNE	7B
			JSR	MIDI_SEND_EOX

8			CLRB
9			LDX	#S_SYSEX_VCED
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$02
			BCS	9B
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
10			LDX	#S_SYSEX_VCED
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$05
			BCS	10B
			CLR	>MIDI_TX_CRC
			LDX	#M6A67
11			LDAA	,X
			CPX	#M6AAD
			BNE	12F
			CLRA
12			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M6ABE
			BNE	11B
13			LDAA	#$63
			PSHX
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M6AC1
			BNE	13B
14			LDAA	#$32
			PSHX
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M6AC4
			BNE	14B
			JSR	MIDI_SEND_EOX
15			RTS

S_SYSEX_VCED		FCB	SYX,MFR_YAMAHA,$03,$00,$5D

S_SYSEX_SCED		FCB	SYX,MFR_YAMAHA,$7E,$00,$21
			FCC	'LM  8976AE'

;-------

SEND_SYSEX_PMEM		TST	SYS_SYSAVL
			BEQ	4F
			TST	>M00CC
			BNE	4F
			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			CLR	>M00C7
			JSR	SEND_SYSEX_PMEM_HDR
1			LDAA	M00C7
			CMPA	#$18
			BCS	2F
			LDX	#D_PFM_SINGLE
			BRA	3F
2			LDAB	#$4C
			MUL
			ADDD	#USER_PFM
			XGDX
3			JSR	SEND_76
			LDAB	M00C7
			INCB
			STAB	M00C7
			CMPB	#$20
			BNE	1B
			JSR	MIDI_SEND_EOX
4			RTS

;-------

SEND_SYSEX_PMEM_HDR	CLRB
1			LDX	#S_SYSEX_PMEM
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$02
			BCS	1B
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
2			LDX	#S_SYSEX_PMEM
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0F
			BCS	2B
			LDAA	#$54
			STAA	MIDI_TX_CRC
			RTS

S_SYSEX_PMEM		FCB	SYX,MFR_YAMAHA,$7E,$13,$0A
			FCC	'LM  8976PM'

;-------

SEND_76			CLRB
1			PSHB
			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			PULB
			INCB
			CMPB	#$4C
			BNE	1B
			RTS

;-------

HI_CALL_0E		CLRB
1			LDX	#S_SYSEX_VMEM_HEADER
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$02
			BCS	1B
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
2			LDX	#S_SYSEX_VMEM_HEADER
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$05
			BCS	2B
			CLR	>MIDI_TX_CRC
			RTS

S_SYSEX_VMEM_HEADER	FCB	SYX,MFR_YAMAHA,$04,$20,$00

;-------

			INCLUDE	"inc/voice_send.asm"

;-------

SEND_SYSEX_PCED		LDAA	#$08
			LDAB	#$0C
			LDX	#PFM_EDIT_BUF
1			ASR	$02,X
			ROL	$02,X
			ROL	$01,X
			ABX
			DECA
			BNE	1B
			TST	SYS_SYSAVL
			BNE	2F
			RTS
2			TST	>M00CC
			BEQ	3F
			RTS
3			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
4			LDX	#S_SYSEX_PCED
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	4B
			LDAA	#$4C
			STAA	MIDI_TX_CRC
			LDX	#PFM_EDIT_BUF
5			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#PFM_EDIT_BUF_END
			BNE	5B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_PCED		FCB	$7E,$00,$78
			FCC	'LM  8976PE'

;-------

SEND_SYSEX_MCRTE0	TST	SYS_SYSAVL
			BNE	1F
			RTS
1			TST	>M00CC
			BEQ	2F
			RTS
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
3			LDX	#S_SYSEX_MCOCT
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	3B
			LDAA	#$84
			STAA	MIDI_TX_CRC
			LDX	#MICROTUNE_OCT
4			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#MICROTUNE_OCT_END
			BNE	4B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_MCOCT		FCB	$7E,$00,$22
			FCC	'LM  MCRTE0'

;-------

SEND_SYSEX_MCRTE1	TST	SYS_SYSAVL
			BNE	1F
			RTS
1			TST	>M00CC
			BEQ	2F
			RTS
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
3			LDX	#S_SYSEX_MCRTE1
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	3B
			LDAA	#$85
			STAA	MIDI_TX_CRC
			LDX	#MICROTUNE_FULL
4			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#MICROTUNE_FULL_END
			BNE	4B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_MCRTE1		FCB	$7E,$02,$0A
			FCC	'LM  MCRTE1'

;-------

SEND_SYSEX_SYS0		TST	SYS_SYSAVL
			BNE	1F
			RTS
1			TST	>M00CC
			BEQ	2F
			RTS
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
3			LDX	#S_SYSEX_SYS0
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	3B
			LDAA	#$3A
			STAA	MIDI_TX_CRC
			LDX	#SYS_PARAMS
4			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M7570
			BNE	4B
			LDX	#M7740
5			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#M7750
			BNE	5B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_SYS0		FCB	$7E,$00,$25
			FCC	'LM  8976S0'

;-------

SEND_SYSEX_SYS1		TST	SYS_SYSAVL
			BNE	1F
			RTS
1			TST	>M00CC
			BEQ	2F
			RTS
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
3			LDX	#S_SYSEX_SYS1
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	3B
			LDAA	#$3B
			STAA	MIDI_TX_CRC
			LDX	#PROG_CHANGES
4			LDAA	,X
			ROLA
			ROLA
			PSHX
			ANDA	#$01
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			LDAA	,X
			ANDA	#$7F
			PSHX
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#PROG_CHANGES_END
			BNE	4B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_SYS1		FCB     $7E,$02,$0A
			FCC	'LM  8976S1'

;-------

SEND_SYSEX_SYS2		TST	SYS_SYSAVL
			BNE	1F
			RTS
1			TST	>M00CC
			BEQ	2F
			RTS
2			JSR	HI_CALL_00
			JSR	HI_CALL_01
			CLR	>M005A
			JSR	LCD_CLR_BOTTOM
			STX	M00A7
			LDX	#S_TRANSMITTING
			JSR	LCD_WRITE
			LDAA	#SYX
			JSR	MIDI_SEND
			LDAA	#MFR_YAMAHA
			JSR	MIDI_SEND
			LDAA	SYS_MIDTCH
			JSR	MIDI_SEND
			CLRB
3			LDX	#S_SYSEX_SYS2
			ABX
			LDAA	,X
			JSR	MIDI_SEND
			INCB
			CMPB	#$0D
			BCS	3B
			LDAA	#$3C
			STAA	MIDI_TX_CRC
			LDX	#EFFECTS_PARAMS
4			LDAA	,X
			PSHX
			ANDA	#$7F
			TAB
			ADDB	MIDI_TX_CRC
			STAB	MIDI_TX_CRC
			JSR	MIDI_SEND
			PULX
			INX
			CPX	#EFFECTS_PARAMS_END
			BNE	4B
			JSR	MIDI_SEND_EOX
			RTS

S_SYSEX_SYS2		FCB	$7E,$00,$41
			FCC	'LM  8976S2'

;-------

F_E639			JSR	SEND_SYSEX_MCRTE0
			JSR	DELAY_30_x_4500
			JSR	SEND_SYSEX_MCRTE1
			RTS

;-------

F_E633			JSR	SEND_SYSEX_SYS1
			JSR	DELAY_30_x_4500
			JSR	SEND_SYSEX_SYS2
			JSR	DELAY_30_x_4500
			JSR	SEND_SYSEX_MCRTE0
			JSR	DELAY_30_x_4500
			JSR	SEND_SYSEX_MCRTE1
			RTS

;-------

MIDI_SEND_EOX		LDAA	MIDI_TX_CRC		; get running CRC
			NEGA				; negate it
			ANDA	#$7F			; clear top bit
			JSR	MIDI_SEND		; send that
			LDAA	#EOX			; send EOX
			JSR	MIDI_SEND		; -
			RTS

;-------

MIDI_SEND		LDX	PTR_TX_TAIL		; get MIDI TX pointer
			STAA	,X			; store data
			CPX	#MIDI_TXBUF_END - 1	; check if we're at buffer end
			BNE	1F			; if not, branch
			LDX	#MIDI_TXBUF - 1		; reset to buffer start - 1
1			INX				; increment 
			CPX	PTR_TX			; buffer full?
			BEQ	MIDI_SEND		; write it again
			STX	PTR_TX_TAIL		; save MIDI TX pointer
			LDAA	#TDRE|RIE|RE|TIE|TE	; enable TX interrupts
			STAA	TRCSR			; -
			RTS

;-------

SHOW_RX_ERR		JSR	F_E6CE
			LDX	#LCD_BUFFER
			STX	M00A7
			LDAA	#$01
			CMPA	MIDI_RX_ERR
			BNE	1F
			LDX	#S_MIDI_BUFFER_FULL
			BRA	2F
1			LDX	#S_MIDI_DATA_ERROR
2			JSR	PUTSTRX
			JSR	LCD_UPDATE
			LDAA	#$0C
			JSR	LCD_WAIT
			STAA	LCD_CMD
			CLR	>MIDI_RX_ERR
			LDAA	#$01
			STAA	M0056
			RTS

S_MIDI_BUFFER_FULL	FCC	"Midi Buffer Full"
			FCB	$00

S_MIDI_DATA_ERROR	FCC	"Midi Data Error!"
			FCB	$00

;-------

F_E6BD			JSR	F_E6CE
			SEI
			SPIN3
			JSR	MIDI_INIT_RX
			CLI
			JSR	F_C7C2
			CLR	>M00CB
			RTS

;-------

F_E6CE			LDAA	TCSR1
			PSHA
			AIM	#~EOCI1,TCSR1
			JSR	HI_CALL_16
			LDAA	#$07
			LDX	#M7CF1
1			TIM	#%00000100,$01,X
			BNE	3F
2			DEX
			DEX
			DECA
			BPL	1B
			BRA	6F
3			PSHA
			PSHX
			LDX	#M793B
			TAB
			ABX
			LDAA	,X
			BMI	5F
			LDAB	M7772
			ANDB	#$04
			BEQ	4F
			TST	PFM_EDIT_ASSIGN
			BEQ	4F
			CLRA
4			STAA	M00E0
			JSR	F_87CA
			PULX
			PULA
			PSHA
			PSHX
			JSR	F_8609
5			PULX
			PULA
			BRA	2B
6			LDAB	M006C
			ASLB
			LDAA	M7772
			ANDA	#$04
			BEQ	7F
			TST	PFM_EDIT_ASSIGN
			BNE	15F
			LDAA	#$08
			MUL
			ADDD	#M7F39
			XGDX
			DEX
			DEX
			LDAB	#$08
			BRA	8F
7			LDX	#M7F39
			ABX
			DEX
			DEX
			LDAB	#$01
8			PSHB
			LDAB	M006C
9			TIM	#%00000100,$01,X
			BNE	11F
10			DEX
			DEX
			DECB
			BNE	9B
			PULB
			DECB
			BNE	8B
			BRA	15F
11			PULA
			PSHA
			PSHB
			PSHX
			DECA
			STAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			STD	M00E1
			TIM	#%00000001,$01,X
			BNE	12F
			LDX	#M7F01
			LDAB	M00E0
			ABX
			LDAA	,X
			STAA	M005A
			TSTA
			BLE	14F
			JSR	F_87CA
			LDAA	M005A
			DECA
			STAA	M005A
			LDX	#M7F01
			LDAB	M00E0
			ABX
			STAA	,X
			BNE	13F
12			LDX	M00E1
			JSR	F_8703
			BRA	14F
13			PULX
			PSHX
			JSR	F_8731
14			PULX
			PULB
			BRA	10B
15			PULA
			STAA	TCSR1
			RTS

;-------

F_E78F			STAB	M00E0
			LDX	#M00F6
			ABX
			TST	,X
			BNE	1F
			JMP	11F
1			JSR	F_87CA
			LDAA	M7772
			ANDA	#$04
			BEQ	2F
			TST	PFM_EDIT_ASSIGN
			BNE	3F
2			LDAA	M00E0
			JSR	F_9A2F
			TST	$3F,X
			BEQ	3F
			JMP	7F
3			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAA	,X
			TAB
			LDX	#M7CE3
			ASLB
			ABX
4			LDAB	$01,X
			ANDB	#$7C
			CMPB	#$04
			BEQ	6F
5			INX
			INX
			PSHX
			LDX	#M7EF9
			LDAB	M00E0
			ABX
			CMPA	,X
			PULX
			BEQ	11F
			INCA
			BRA	4B
6			PSHA
			PSHX
			JSR	F_85FA
			PULX
			PULA
			BRA	5B
7			LDX	#M7F01
			LDAB	M00E0
			ABX
			LDAA	,X
			STAA	M005A
			TSTA
			BLE	11F
			LDAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			STD	M00E1
			LDAB	M006C
			DECB
			ASLB
			LDX	M00E1
			ABX
			LDAB	M006C
8			LDAA	$01,X
			ANDA	#$7C
			CMPA	#$04
			BEQ	10F
9			DEX
			DEX
			DECB
			BNE	8B
			BRA	11F
10			PSHB
			PSHX
			JSR	F_86E4
			PULX
			PULB
			BRA	9B
11			RTS

;-------

F_E821			STAB	M00E0
			LDX	#M00F6
			ABX
			TST	,X
			BNE	1F
			JMP	13F
1			JSR	F_87CA
			LDAA	M7772
			ANDA	#$04
			BEQ	2F
			TST	PFM_EDIT_ASSIGN
			BNE	3F
2			LDAA	M00E0
			JSR	F_9A2F
			TST	$3F,X
			BEQ	3F
			JMP	7F
3			LDX	#M7EF1
			LDAB	M00E0
			ABX
			LDAA	,X
			TAB
			LDX	#M7CE3
			ASLB
			ABX
4			TIM	#%00000100,$01,X
			BNE	6F
5			INX
			INX
			PSHX
			LDX	#M7EF9
			LDAB	M00E0
			ABX
			CMPA	,X
			PULX
			BEQ	13F
			INCA
			BRA	4B
6			LDAB	M0058
			ANDB	#$78
			ANDB	$01,X
			BEQ	5B
			PSHA
			PSHX
			JSR	F_8609
			PULX
			PULA
			BRA	5B
7			LDX	#M7F01
			LDAB	M00E0
			ABX
			LDAA	,X
			STAA	M005A
			LDAA	M00E0
			LDAB	M006C
			ASLB
			MUL
			ADDD	#M7F39
			STD	M00E1
			LDAB	M006C
			DECB
			ASLB
			LDX	M00E1
			ABX
			LDAB	M006C
8			TIM	#%00000100,$01,X
			BNE	10F
9			DEX
			DEX
			DECB
			BNE	8B
			BRA	13F
10			LDAA	M0058
			ANDA	#$78
			ANDA	$01,X
			BEQ	9B
			PSHB
			PSHX
			LDAA	M005A
			DECA
			STAA	M005A
			LDX	#M7F01
			LDAB	M00E0
			ABX
			STAA	,X
			PULX
			PSHX
			BNE	11F
			JSR	F_8703
			BRA	12F
11			JSR	F_8731
12			PULX
			PULB
			BRA	9B
13			RTS

;-------

F_E8D0			TST	>M00AF
			BEQ	1F
			TST	>M00B2
			BNE	1F
			LDD	M00B0
			ADDD	#1
			STD	M00B0
			XGDX
			CPX	#$0060
			BCS	1F
			CLR	>M00AF
			LDD	#0
			STD	M00B0
			LDAA	#$01
			STAA	M00CB
1			RTS

;-------

HI_CALL_15		LDAA	M776B
			ANDA	#$E9
			STAA	M776B
			LDAA	M7772
			BITA	#$04
			BNE	2F
			ANDA	#$07
			BNE	1F
			LDAA	M7788
			BEQ	1F
			LDAA	M7774
			CMPA	#$19
			BEQ	3F
			CMPA	#$1A
			BEQ	4F
			CMPA	#$1B
			BNE	1F
			LDAA	M7788
			CMPA	#$02
			BEQ	5F
			LDAA	M776B
			ANDA	#$F7
			STAA	M776B
			BRA	5F
1			LDAA	M776B
			ANDA	#$F7
			STAA	M776B
			RTS
2			LDAA	PFM_EDIT_EFFECT
			CMPA	#$01
			BEQ	3F
			CMPA	#$02
			BEQ	4F
			CMPA	#$03
			BEQ	5F
			LDAA	M776B
			ANDA	#$F7
			STAA	M776B
			RTS
3			LDAA	M776B
			ORAA	#$10
			STAA	M776B
			RTS
4			JSR	F_E963
			RTS
5			LDAA	M776B
			ORAA	#$04
			STAA	M776B
			RTS

;-------

F_E963			CLRA
			CLRB
			STD	M775D
			STD	M775F
			STD	M7761
			STD	M7763
1			LDX	#M7933
			ABX
			LDAA	,X
			BEQ	3F
			LSRA
			BCS	3F
			ASLA
			LDX	#M793B
			ABX
			PSHB
			LDAB	,X
			TSTB
			BPL	2F
			PULB
			BRA	3F
2			LDX	#M775D
			ABX
			ORAA	#$01
			STAA	,X
			PULB
			LDAA	M776B
			ORAA	#$02
			STAA	M776B
3			INCB
			CMPB	#$08
			BNE	1B
			RTS

;-------

HI_CALL_16		LDAA	M776B
			BITA	#%00010000
			BNE	1F
			BITA	#$02
			BNE	2F
			RTS
1			AIM	#~EOCI1,TCSR1
			CLR	M7751
			CLR	M7752
			CLR	M7753
			CLR	M7754
			LDAA	M776B
			ANDA	#%11111110
			STAA	M776B
			RTS
2			CLR	M7766
			RTS

;-------

F_E9C9			LDAA	M776B
			BITA	#$10
			BNE	1F
			BITA	#$02
			BNE	5F
			RTS
1			CMPB	M784E
			BNE	4F
			CLRB
2			LDX	#M7751
			ABX
			TST	,X
			BEQ	3F
			TST	$0C,X
			BNE	3F
			LDAA	#$01
			STAA	$0C,X
			LDAA	EF1T
			INCA
			STAA	$14,X
			LDAA	M776B
			ORAA	#$01
			STAA	M776B
3			INCB
			CMPB	#$04
			BNE	2B
			LDAB	M784E
4			RTS
5			LDX	#M775D
			ABX
			TST	,X
			BEQ	6F
			CLR	M7766
6			RTS

;-------

F_EA0E			CMPB	M784E
			BNE	1F
			LDAA	M776B
			BITA	#$10
			BNE	2F
1			RTS
2			LDAA	M784E
			PSHB
			LDAB	>NOTE_NUMBER
			JSR	F_8831
			PULB
			BCC	1B
			TST	M7751
			BEQ	3F
			TST	M7752
			BEQ	4F
			TST	M7753
			BEQ	5F
			TST	M7754
			BEQ	6F
			CLR	M7751
			LDAA	#$0C
			STAA	>M0058
			LDAB	M784E
			JSR	F_E821
3			CLRB
			BRA	7F
4			LDAB	#$01
			BRA	7F
5			LDAB	#$02
			BRA	7F
6			LDAB	#$03
7			PSHB
			LDAB	EF1L
			LDAA	#$A5
			MUL
			ASLD
			ASLD
			COMA
			LSRA
			LDAB	>M00F1
			ABA
			BCS	9F
			BNE	8F
			LDAA	#$01
			BRA	10F
8			CMPA	#$78
			BCS	10F
9			PULB
			LDAB	M784E
			RTS
10			PULB
			LDX	#M7751
			ABX
			STAA	$04,X
			LDAA	>NOTE_NUMBER
			STAA	,X
			LDAA	#$01
			STAA	$08,X
			CLR	$0C,X
			LDAA	EF1T
			INCA
			STAA	$10,X
			LDAA	M776B
			ORAA	#$01
			STAA	M776B
			LDAB	M784E
			RTS

;-------

F_EA9B			CMPB	M784E
			BNE	1F
			LDAA	M776B
			BITA	#$10
			BNE	2F
1			RTS
2			LDAA	M784E
			PSHB
			LDAB	>NOTE_NUMBER_STOP
			JSR	F_8831
			PULB
			BCC	1B
			LDAA	>NOTE_NUMBER_STOP
			CLRB
3			LDX	#M7751
			ABX
			CMPA	,X
			BNE	4F
			TST	$0C,X
			BNE	4F
			BRA	5F
4			INCB
			CMPB	#$04
			BNE	3B
			LDAB	M784E
			RTS
5			LDAA	#$01
			STAA	$0C,X
			LDAA	EF1T
			INCA
			STAA	$14,X
			LDAA	M776B
			ORAA	#$01
			STAA	M776B
			LDAB	M784E
			RTS

;-------

F_EAE6			LDAA	M776B
			ANDA	#$FE
			STAA	M776B
			BITA	#$10
			BNE	1F
			RTS
1			CLRB
2			LDX	#M7751
			ABX
			TST	,X
			BEQ	4F
			LDAA	M776B
			ORAA	#$01
			STAA	M776B
			TST	$04,X
			BEQ	3F
			DEC	$10,X
			BNE	3F
			PSHB
			JSR	F_EB28
			PULB
			LDX	#M7751
			ABX
3			TST	$0C,X
			BEQ	4F
			DEC	$14,X
			BNE	4F
			PSHB
			JSR	F_EBB1
			PULB
4			INCB
			CMPB	#$04
			BCS	2B
			RTS

;-------

F_EB28			PSHB
			LDAB	$08,X
			LDAA	,X
			STAA	>NOTE_NUMBER
1			LDAA	EF1P
			ADDA	>NOTE_NUMBER
			SUBA	#$18
			BMI	3F
2			STAA	>NOTE_NUMBER
			DECB
			BNE	1B
			BRA	6F
3			CMPA	#$C0
			BCS	5F
4			ADDA	#$0C
			BMI	4B
			BRA	2B
5			SUBA	#$0C
			BMI	5B
			BRA	2B
6			LDAA	$04,X
			STAA	>M00F1
			PULB
			CMPB	#$01
			BCS	7F
			BEQ	8F
			CMPB	#$02
			BEQ	9F
			LDAA	#$44
			STAA	>M0058
			BRA	10F
7			LDAA	#$0C
			STAA	>M0058
			BRA	10F
8			LDAA	#$14
			STAA	>M0058
			BRA	10F
9			LDAA	#$24
			STAA	>M0058
			BRA	10F			; unnecessary branch
10			LDAB	M784E
			PSHX
			JSR	NOTE_START
			PULX
			INC	$08,X
			LDAA	$04,X
			LDAB	EF1F
			PSHX
			LDX	#D_EBA9
			ABX
			ADDA	,X
			PULX
			BCS	11F
			CMPA	#$78
			BCC	11F
			BRA	12F
11			CLR	$04,X
			RTS
12			STAA	$04,X
			LDAA	EF1T
			INCA
			STAA	$10,X
			RTS

D_EBA9			FCB	$FF,$76,$3B,$27,$1D,$17,$13,$0E

;-------

F_EBB1			PSHB
			LDAB	$0C,X
			LDAA	,X
			STAA	>NOTE_NUMBER_STOP
1			LDAA	EF1P
			ADDA	>NOTE_NUMBER_STOP
			SUBA	#$18
			BMI	3F
2			STAA	>NOTE_NUMBER_STOP
			DECB
			BNE	1B
			BRA	6F
3			CMPA	#$C0
			BCS	5F
4			ADDA	#$0C
			BMI	4B
			BRA	2B
5			SUBA	#$0C
			BMI	5B
			BRA	2B
6			PULB
			CMPB	#$01
			BCS	7F
			BEQ	8F
			CMPB	#$02
			BEQ	9F
			LDAA	#$44
			BRA	10F
7			LDAA	#$0C
			BRA	10F
8			LDAA	#$14
			BRA	10F
9			LDAA	#$24
			BRA	10F			; unnecessary
10			STAA	>M0058
			LDAB	M784E
			PSHX
			JSR	NOTE_STOP
			PULX
			INC	$0C,X
			LDAA	$0C,X
			CMPA	$08,X
			BNE	11F
			TST	$04,X
			BNE	11F
			CLR	,X
			RTS
11			LDAA	EF1T
			INCA
			STAA	$14,X
			RTS

;-------

F_EC17			LDAA	#$02
			BITA	M776B
			BNE	1F
			RTS
1			INC	M7765
			LDAA	M7765
			CMPA	#$3C
			BEQ	2F
			RTS
2			CLR	M7765
			CLRA
			CLRB
3			LDX	#M775D
			ABX
			TST	,X
			BEQ	4F
			LDX	#M7D6B
			ABX
			CMPA	,X
			BCC	4F
			LDAA	,X
4			INCB
			CMPB	#$08
			BNE	3B
			TAB
			COMB
			LDX	#MA82B
			ABX
			LDAB	,X
			COMB
			LDX	#MEF41
			ABX
			LDAA	,X
			STAA	M775B
			TST	EF2D
			BEQ	6F
			LDAB	M7750
			CMPB	#$40
			BCS	5F
			STAA	M775C
			RTS
5			ASLB
			ASLB
			MUL
			STAA	M775C
			RTS
6			LDAB	M7750
			MUL
			STAA	M775C
			RTS

;-------

F_EC77			LDAA	#$02
			BITA	M776B
			BNE	1F
			RTS
1			TST	EF2D
			BNE	2F
			RTS
2			LDX	#M775D
			ABX
			TST	,X
			BNE	3F
			RTS
3			INC	M7766
			LDAA	M7766
			CMPA	#$01
			BEQ	4F
			RTS
4			PSHB
			LDAA	EF2D
			CMPA	#$01
			BEQ	5F
			LDAA	>NOTE_NUMBER
			BRA	6F
5			LDAA	NOTE_VELOCITY
6			ASLA
			LDAB	M7750
			CMPB	#$41
			BCS	10F
			CMPA	#$80
			BEQ	10F
			BCS	8F
			SUBA	#$80
			MUL
			CMPA	#$20
			BCS	7F
			LDAA	#$FF
			BRA	10F
7			ASLD
			ASLD
			ADDA	#$80
			BRA	10F
8			NEGA
			SUBA	#$80
			MUL
			CMPA	#$20
			BCS	9F
			CLRA
			BRA	10F
9			ASLD
			ASLD
			ADDA	#$80
			NEGA
10			JSR	F_ED1E
			PULB
			RTS

;-------

F_ECDD			LDAA	M776B
			BITA	#$02
			BNE	1F
			RTS
1			TST	EF2D
			BNE	2F
			RTS
2			LDX	#M775D
			ABX
			TST	,X
			BNE	3F
			RTS
3			DEC	M7766
			BMI	4F
			RTS
4			CLR	M7766
			RTS

;------

F_ECFE			LDAB	#$02
			BITB	M776B
			BNE	1F
			RTS
1			TST	EF2D
			BEQ	2F
			RTS
2			LDAA	M7836
			SUBA	#$3F
			CMPA	#$80
			BCC	3F
			ASLA
			BRA	4F
3			COMA
			ASLA
4			JSR	F_ED1E
			RTS

;-------	could fallthrough, but doesn't

F_ED1E			LDAB	M775B
			MUL
			TST	EF2D
			BEQ	1F
			LDAB	M7750
			CMPB	#$40
			BCC	2F
			ASLB
			ASLB
			MUL
			BRA	2F
1			LDAB	M7750
			MUL
2			TAB
			LDAA	M775C
			SBA
			TST	EF2S
			BEQ	3F
			PSHA
			TBA
			PULB
3			STAA	M7751
			STAB	M7752
			CLRB
4			LDX	#M775D
			ABX
			LDAA	,X
			BEQ	6F
			LDX	#M7753
			ABX
			BITA	#$02
			BEQ	5F
			LDAA	M7752
			STAA	,X
			BRA	7F
5			LDAA	M7751
			STAA	,X
			BRA	7F
6			LDX	#M7753
			ABX
			CLR	,X
7			INCB
			CMPB	#$08
			BNE	4B
			RTS

;-------

F_ED75			LDAA	#$31
			STAA	M7751
			STAA	M7752
			STAA	M7753
			STAA	M7754
			CLR	M7755
			LDAA	M776B
			ORAA	#$08
			STAA	M776B
			RTS

;-------

F_ED8F			LDAA	M776B
			BITA	#$04
			BNE	1F
			CLV
			RTS
1			CMPB	M784E
			BEQ	2F
			CLV
			RTS
2			LDAA	M784E
			PSHB
			LDAB	>NOTE_NUMBER
			JSR	F_8831
			PULB
			BCS	3F
			CLV
			RTS
3			LDAA	M776B
			BITA	#$08
			BNE	4F
			LDAA	>NOTE_NUMBER
			PSHA
			JSR	CHORD_START
			PULA
			STAA	>NOTE_NUMBER
			SEV
			RTS
4			LDAA	>NOTE_NUMBER
			SUBA	#$24
			SUBA	M7789
			CMPA	#$31
			BCS	5F
			SEV
			RTS
5			LDAB	M7755
			CMPB	#$04
			BCS	6F
			LDAB	M784E
			CLV
			RTS
6			LDX	#M7751
			ABX
			STAA	,X
			INC	M7755
			LDAB	M784E
			CLV
			RTS

;-------

F_EDEA			LDAA	M776B
			BITA	#$04
			BNE	1F
			CLV
			RTS
1			CMPB	M784E
			BEQ	2F
			CLV
			RTS
2			LDAA	M784E
			PSHB
			LDAB	>NOTE_NUMBER_STOP
			JSR	F_8831
			PULB
			BCS	3F
			CLV
			RTS
3			LDAA	M776B
			BITA	#$08
			BNE	4F
			LDAA	>NOTE_NUMBER_STOP
			PSHA
			JSR	CHORD_STOP
			PULA
			STAA	>NOTE_NUMBER_STOP
			SEV
			RTS
4			CLV
			RTS

;-------

F_EE1F			LDAA	M776B
			ANDA	#$0C
			CMPA	#$0C
			BEQ	1F
			RTS
1			TST	M7755
			BNE	2F
			RTS
2			LDX	#M7CE3
			CLRA
			ORAA	$01,X
			ORAA	$03,X
			ORAA	$05,X
			ORAA	$07,X
			ORAA	$09,X
			ORAA	$0B,X
			ORAA	$0D,X
			ORAA	$0F,X
			TSTA
			BEQ	3F
			RTS
3			LDAA	M776B
			ANDA	#$F7
			STAA	M776B
			LDAB	M7789
			ASLB
			ASLB
			LDX	#CHORD
			ABX
			LDD	M7751
			STD	,X
			LDD	M7753
			STD	$02,X
			JSR	F_C95A
			JSR	F_C972
			RTS

;-------
;
; Starts a chord
;
CHORD_START		LDAA	>NOTE_NUMBER
			STAA	CHORD_NOTE
1			SUBA	#$0C
			BCC	1B
			ADDA	#$0C
			TAB
			ASLB
			ASLB
			LDX	#CHORD
			ABX
			LDAA	,X
			CMPA	#$31
			BCC	2F
			SUBA	#$18
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER
			LDAB	M784E
			PSHX
			JSR	NOTE_START
			PULX
2			LDAA	$01,X
			CMPA	#$31
			BCC	3F
			SUBA	#$18
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER
			LDAB	M784E
			PSHX
			JSR	NOTE_START
			PULX
3			LDAA	$02,X
			CMPA	#$31
			BCC	4F
			SUBA	#$18
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER
			LDAB	M784E
			PSHX
			JSR	NOTE_START
			PULX
4			LDAA	$03,X
			CMPA	#$31
			BCC	5F
			SUBA	#$18
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER
			LDAB	M784E
			PSHX
			JSR	NOTE_START
			PULX
5			RTS

;-------

CHORD_STOP		LDAA	>NOTE_NUMBER_STOP			; get the original note
			STAA	CHORD_NOTE		; save it
1			SUBA	#12			; calculate note % 12
			BCC	1B			; -
			ADDA	#12			; -
			TAB				; B <- remainder * 4
			ASLB				; -
			ASLB				; -
			LDX	#CHORD			; offset to Chord effect table
			ABX				; -
			LDAA	,X			; get first note
			CMPA	#49			; is it 49?
			BCC	2F			; if so, go to next note
			SUBA	#24			; rebase to 24
			ADDA	CHORD_NOTE		; add to the note we started with
			STAA	>NOTE_NUMBER_STOP
			LDAB	M784E
			PSHX
			JSR	NOTE_STOP
			PULX
2			LDAA	$01,X
			CMPA	#49
			BCC	3F
			SUBA	#24
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER_STOP
			LDAB	M784E
			PSHX
			JSR	NOTE_STOP
			PULX
3			LDAA	$02,X
			CMPA	#49
			BCC	4F
			SUBA	#24
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER_STOP
			LDAB	M784E
			PSHX
			JSR	NOTE_STOP
			PULX
4			LDAA	$03,X
			CMPA	#49
			BCC	5F
			SUBA	#24
			ADDA	CHORD_NOTE
			STAA	>NOTE_NUMBER_STOP
			LDAB	M784E
			PSHX
			JSR	NOTE_STOP
			PULX
5			RTS

;-------

MEF41			FCB	$00,$08,$0C,$13,$18,$1D,$20,$27,$2B,$30,$33,$38,$3C
			FCB	$3F,$43,$47,$4B,$50,$54,$58,$5B,$5F,$63,$65,$68,$6C
			FCB	$6F,$72,$75,$78,$7B,$7D,$80,$83,$9A,$9C,$8B,$8D,$90
			FCB	$92,$94,$96,$99,$9B,$9D,$9F,$A1,$A3,$A5,$A7,$A9,$AB
			FCB	$AD,$AE,$B0,$B2,$B3,$B5,$B7,$B8,$BA,$BB,$BD,$BE,$BF
			FCB	$C1,$C2,$C4,$C5,$C6,$C7,$C9,$CA,$CB,$CC,$CD,$CE,$CF
			FCB	$D1,$D1,$D2,$D3,$D4,$D5,$D6,$D7,$D8,$D8,$D9,$DA,$DB
			FCB	$DC,$DC,$DD,$DE,$DE,$DF,$E0,$E1,$E1,$E2,$E2,$E3,$E4
			FCB	$E4,$E5,$E5,$E6,$E6,$E7,$E7,$E8,$E8,$E9,$E9,$EA,$EA
			FCB	$EB,$EB,$EB,$EC,$EC,$ED,$ED,$ED,$EE,$EE,$EE,$EF,$EF
			FCB	$F0,$F0,$F0,$F0,$F1,$F1,$F1,$F2,$F2,$F2,$F2,$F3,$F3
			FCB	$F3,$F3,$F4,$F4,$F4,$F4,$F5,$F5,$F5,$F5,$F5,$F6,$F6
			FCB	$F6,$F6,$F6,$F6,$F7,$F7,$F7,$F7,$F7,$F7,$F8,$F8,$F8
			FCB	$F8,$F8,$F8,$F8,$F9,$F9,$F9,$F9,$F9,$F9,$F9,$F9,$FA
			FCB	$FA,$FA,$FA,$FA,$FA,$FA,$FA,$FA,$FA,$FA,$FB,$FB,$FB
			FCB	$FB,$FB,$FB,$FB,$FB,$FB,$FB,$FB,$FB,$FB,$FC,$FC,$FC
			FCB	$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC,$FC
			FCB	$FC,$FC,$FC,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD
			FCB	$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD,$FD
			FCB	$FD,$FD,$FD,$FD,$FD,$FD,$FE,$FE,$FF

S_VERSION		FCC	"V1.6  03-Feb-88 "
			FCB	$00

;-------

DELAY_30_x_4500		LDAB	#30

;-------	fallthrough

DELAY_B_x_4500
0			LDX	#4500
1			DEX
			BNE	1B
			DECB
			BNE	0B
			RTS

;-------

			RTS
			RTS
			RTS
			RTS
			RTS
			RTS
			RTS

;-------

1			BRA	1B

;-------

			INCLUDE	"inc/vecs.asm"
